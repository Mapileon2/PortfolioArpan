<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Carousel Unsigned Preset - Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cloudinary SDK -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">üß™ Test Unsigned "Carousel" Preset - Fixed</h1>
            
            <!-- Fix Notice -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-green-900 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>Fixed for Unsigned Uploads
                </h3>
                <p class="text-green-800 text-sm">
                    Removed disallowed parameters: <code>overwrite</code>, <code>use_filename</code>, <code>unique_filename</code>, <code>use_filename_as_display_name</code>
                    <br>These settings are now handled automatically by your "Carousel" preset configuration.
                </p>
            </div>

            <!-- Preset Configuration Display -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-900 mb-3">
                    <i class="fas fa-cog mr-2"></i>Your Unsigned "Carousel" Preset
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="space-y-2">
                        <div><span class="font-medium text-blue-800">Name:</span> <span class="text-blue-700">Carousel</span></div>
                        <div><span class="font-medium text-blue-800">Mode:</span> <span class="text-blue-700">Unsigned ‚úÖ</span></div>
                        <div><span class="font-medium text-blue-800">Folder:</span> <span class="text-blue-700">carou</span></div>
                        <div><span class="font-medium text-blue-800">Type:</span> <span class="text-blue-700">upload</span></div>
                    </div>
                    <div class="space-y-2">
                        <div><span class="font-medium text-blue-800">Allowed Parameters:</span></div>
                        <div class="text-xs text-blue-600 ml-4">
                            ‚úÖ upload_preset, folder, tags<br>
                            ‚úÖ public_id, callback, context<br>
                            ‚ùå overwrite, use_filename (handled by preset)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button onclick="testUnsignedPresetWidget()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Test Unsigned Preset Widget
                </button>
                <button onclick="testDirectUnsignedUpload()" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-upload mr-2"></i>Test Direct Unsigned Upload
                </button>
            </div>

            <!-- File Input -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Image for Direct Upload Test</label>
                <input type="file" id="fileInput" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
            </div>

            <!-- Results Display -->
            <div class="bg-gray-100 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Upload Results</h3>
                <div id="uploadResults" class="space-y-2 text-sm">
                    <div class="text-gray-600">No uploads yet. Test the buttons above to see results.</div>
                </div>
            </div>

            <!-- Debug Console -->
            <div class="bg-black text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto">
                <div id="debugConsole">
                    <div class="text-yellow-400">üß™ Unsigned Preset Test Console - Fixed</div>
                    <div class="text-gray-400">Ready to test your unsigned "Carousel" preset...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Unsigned preset configuration (only allowed parameters)
        const UNSIGNED_PRESET_CONFIG = {
            cloudName: 'dgymjtqil',
            uploadPreset: 'Carousel', // Your unsigned preset
            folder: 'carou'
            // Note: Removed all disallowed parameters for unsigned uploads
            // overwrite, useFilename, uniqueFilename, useFilenameAsDisplayName
            // These are handled by your preset configuration on Cloudinary dashboard
        };

        // Debug console
        function log(message, type = 'info') {
            const console = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400',
                success: 'text-blue-400'
            };
            
            const div = document.createElement('div');
            div.className = colors[type] || 'text-green-400';
            div.innerHTML = `[${timestamp}] ${message}`;
            console.appendChild(div);
            console.scrollTop = console.scrollHeight;
        }

        // Display upload result
        function displayUploadResult(result) {
            const resultsDiv = document.getElementById('uploadResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'bg-white p-3 rounded border';
            resultDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${result.thumbnail}" alt="Uploaded" class="w-16 h-16 object-cover rounded">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${result.display_name || result.original_filename}</div>
                        <div class="text-sm text-gray-600">Public ID: ${result.public_id}</div>
                        <div class="text-sm text-gray-600">Folder: ${result.folder}</div>
                        <div class="text-sm text-gray-600">Size: ${result.width}x${result.height} (${(result.bytes / 1024 / 1024).toFixed(2)} MB)</div>
                        <a href="${result.secure_url}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-external-link-alt mr-1"></i>View Image
                        </a>
                    </div>
                </div>
            `;
            
            if (resultsDiv.children[0].textContent.includes('No uploads yet')) {
                resultsDiv.innerHTML = '';
            }
            resultsDiv.appendChild(resultDiv);
        }

        // Test unsigned preset widget (fixed)
        function testUnsignedPresetWidget() {
            log('Testing Cloudinary Upload Widget with unsigned "Carousel" preset (fixed)...', 'info');
            
            if (!window.cloudinary) {
                log('‚ùå Cloudinary SDK not loaded', 'error');
                return;
            }

            try {
                const widget = window.cloudinary.createUploadWidget({
                    cloudName: UNSIGNED_PRESET_CONFIG.cloudName,
                    uploadPreset: UNSIGNED_PRESET_CONFIG.uploadPreset,
                    sources: ['local'],
                    multiple: false,
                    folder: UNSIGNED_PRESET_CONFIG.folder,
                    tags: ['carousel', 'test'],
                    clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp']
                    // Note: Removed all disallowed parameters for unsigned uploads
                    // overwrite, useFilename, uniqueFilename, useFilenameAsDisplayName
                    // These are handled by your preset configuration
                }, (error, result) => {
                    if (error) {
                        log(`‚ùå Widget error: ${error.message}`, 'error');
                        return;
                    }

                    if (result && result.event === 'success') {
                        log(`‚úÖ Widget upload successful with unsigned preset!`, 'success');
                        log(`üìÅ Uploaded to folder: ${result.info.folder}`, 'info');
                        log(`üÜî Public ID: ${result.info.public_id}`, 'info');
                        log(`üìù Display Name: ${result.info.display_name}`, 'info');
                        log(`üîó URL: ${result.info.secure_url}`, 'info');
                        
                        // Add thumbnail for display
                        result.info.thumbnail = `https://res.cloudinary.com/${UNSIGNED_PRESET_CONFIG.cloudName}/image/upload/w_300,h_200,c_fill,q_auto/${result.info.public_id}`;
                        
                        displayUploadResult(result.info);
                    }

                    if (result && result.event === 'close') {
                        log('Widget closed', 'warning');
                    }
                });

                widget.open();
                log('‚úÖ Unsigned preset widget opened successfully', 'success');
            } catch (error) {
                log(`‚ùå Widget creation failed: ${error.message}`, 'error');
            }
        }

        // Test direct upload with unsigned preset (fixed)
        async function testDirectUnsignedUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                log('‚ö†Ô∏è Please select a file first', 'warning');
                return;
            }

            log(`üîÑ Testing direct upload with unsigned "Carousel" preset (fixed)...`, 'info');
            log(`üìÅ Target folder: ${UNSIGNED_PRESET_CONFIG.folder}`, 'info');
            log(`üìÑ File: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UNSIGNED_PRESET_CONFIG.uploadPreset);
                formData.append('folder', UNSIGNED_PRESET_CONFIG.folder);
                formData.append('tags', 'carousel,test,unsigned');
                
                // Note: Removed all disallowed parameters for unsigned uploads
                // The preset handles these settings automatically:
                // - overwrite: false
                // - use_filename: false  
                // - unique_filename: false
                // - use_filename_as_display_name: true
                
                log('üì§ Uploading to Cloudinary (unsigned)...', 'info');
                log('‚öôÔ∏è Using only allowed parameters for unsigned upload', 'info');

                const response = await fetch(`https://api.cloudinary.com/v1_1/${UNSIGNED_PRESET_CONFIG.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.error) {
                    log(`‚ùå Upload failed: ${result.error.message}`, 'error');
                } else {
                    log(`‚úÖ Direct unsigned upload successful!`, 'success');
                    log(`üìÅ Uploaded to folder: ${result.folder}`, 'success');
                    log(`üÜî Public ID: ${result.public_id}`, 'info');
                    log(`üìù Display Name: ${result.display_name}`, 'info');
                    log(`üìè Dimensions: ${result.width}x${result.height}`, 'info');
                    log(`üîó URL: ${result.secure_url}`, 'info');
                    
                    // Add thumbnail for display
                    result.thumbnail = `https://res.cloudinary.com/${UNSIGNED_PRESET_CONFIG.cloudName}/image/upload/w_300,h_200,c_fill,q_auto/${result.public_id}`;
                    
                    displayUploadResult(result);
                    
                    // Test saving to your carousel API
                    await testSaveToCarouselAPI(result);
                }
            } catch (error) {
                log(`‚ùå Direct upload failed: ${error.message}`, 'error');
            }
        }

        // Test saving to carousel API
        async function testSaveToCarouselAPI(cloudinaryResult) {
            log('üíæ Testing save to carousel API...', 'info');

            try {
                const carouselData = {
                    publicId: cloudinaryResult.public_id,
                    url: cloudinaryResult.secure_url,
                    thumbnail: cloudinaryResult.thumbnail,
                    title: cloudinaryResult.display_name || cloudinaryResult.original_filename || 'Carousel Image',
                    description: `Uploaded to ${cloudinaryResult.folder} folder using unsigned preset`,
                    width: cloudinaryResult.width,
                    height: cloudinaryResult.height,
                    size: cloudinaryResult.bytes,
                    folder: cloudinaryResult.folder,
                    isActive: true,
                    order: 0
                };

                const response = await fetch('/api/carousel/images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(carouselData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Carousel API save successful!`, 'success');
                    log(`üóÑÔ∏è Database ID: ${result.data?.id || 'Unknown'}`, 'info');
                } else {
                    const error = await response.text();
                    log(`‚ùå Carousel API save failed: ${response.status}`, 'error');
                    log(`üìÑ Error details: ${error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Carousel API save error: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Unsigned preset test page loaded (fixed version)', 'success');
            log(`üìã Preset: "${UNSIGNED_PRESET_CONFIG.uploadPreset}" (unsigned)`, 'info');
            log(`üìÅ Folder: "${UNSIGNED_PRESET_CONFIG.folder}"`, 'info');
            log('‚öôÔ∏è Removed disallowed parameters for unsigned uploads', 'info');
            
            // Check if Cloudinary SDK is loaded
            setTimeout(() => {
                if (window.cloudinary) {
                    log('‚úÖ Cloudinary SDK loaded successfully', 'success');
                } else {
                    log('‚ùå Cloudinary SDK not loaded', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>