<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin Dashboard - Carousel Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Cloudinary SDK -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <style>
        .drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        
        .carousel-slide {
            transition: transform 0.5s ease-in-out;
        }
        
        .upload-progress {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">🎠 Carousel Management</h1>
                    <p class="text-gray-600 mt-2">Upload and manage carousel images with Cloudinary</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="carouselManager.openUploadWidget()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>Add Images
                    </button>
                    <button onclick="carouselManager.refreshImages()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-sync mr-2"></i>Refresh
                    </button>
                    <a href="admin-dashboard.html" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Upload Images</h2>
            
            <!-- Drop Zone -->
            <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-colors hover:border-blue-500 cursor-pointer">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Drop Images Here</h3>
                <p class="text-gray-600 mb-4">Or click to select files</p>
                <button onclick="carouselManager.openUploadWidget()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    Select Images
                </button>
            </div>
            
            <!-- Upload Progress -->
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full upload-progress" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600 mt-2">Uploading...</p>
            </div>
        </div>

        <!-- Carousel Preview -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Carousel Preview</h2>
            <div id="carouselPreview" class="bg-gray-100 rounded-lg overflow-hidden">
                <!-- Carousel preview will be rendered here -->
            </div>
        </div>

        <!-- Image Management -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-900">Manage Images</h2>
                <div class="flex space-x-2">
                    <button onclick="carouselManager.toggleEditMode()" id="editModeBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                        <i class="fas fa-edit mr-2"></i>Edit Mode
                    </button>
                    <button onclick="carouselManager.saveOrder()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-save mr-2"></i>Save Order
                    </button>
                </div>
            </div>
            <div id="imageGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Images will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Edit Image Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">Edit Image</h3>
                    <button onclick="carouselManager.closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="editImagePreview" class="text-center mb-6">
                    <!-- Image preview will be shown here -->
                </div>
                
                <form id="editImageForm">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" id="editTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="editDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="editActive" class="mr-2 rounded">
                            <label for="editActive" class="text-sm font-medium text-gray-700">Show in carousel</label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="carouselManager.closeEditModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        class CarouselManager {
            constructor() {
                this.images = [];
                this.currentIndex = 0;
                this.editMode = false;
                this.currentEditingImage = null;
                this.uploadWidget = null;
                
                // Cloudinary configuration
                this.cloudinaryConfig = {
                    cloudName: 'dgymjtqil',
                    uploadPreset: 'ml_default',
                    apiKey: '951533987774134'
                };
                
                this.init();
            }

            async init() {
                console.log('🎠 Initializing Carousel Manager...');
                
                // Wait for Cloudinary SDK to load
                await this.waitForCloudinary();
                
                // Initialize upload widget
                this.initializeUploadWidget();
                
                // Setup drag and drop
                this.setupDragAndDrop();
                
                // Setup form handlers
                this.setupFormHandlers();
                
                // Load existing images
                await this.loadImages();
                
                console.log('✅ Carousel Manager ready!');
            }

            async waitForCloudinary() {
                let attempts = 0;
                while (!window.cloudinary && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.cloudinary) {
                    throw new Error('Cloudinary SDK not loaded');
                }
            }

            initializeUploadWidget() {
                this.uploadWidget = window.cloudinary.createUploadWidget({
                    cloudName: this.cloudinaryConfig.cloudName,
                    uploadPreset: this.cloudinaryConfig.uploadPreset,
                    multiple: true,
                    maxFiles: 10,
                    maxFileSize: 10000000, // 10MB
                    sources: ['local', 'url', 'camera'],
                    folder: 'portfolio/carousel',
                    tags: ['carousel', 'portfolio'],
                    clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    transformation: [
                        { width: 1200, height: 600, crop: 'fill' },
                        { quality: 'auto:good' },
                        { fetch_format: 'auto' }
                    ]
                }, (error, result) => {
                    this.handleUploadResult(error, result);
                });

                console.log('✅ Upload widget initialized');
            }

            handleUploadResult(error, result) {
                if (error) {
                    console.error('❌ Upload error:', error);
                    this.showNotification('error', `Upload failed: ${error.message}`);
                    this.hideUploadProgress();
                    return;
                }

                if (result && result.event === 'success') {
                    console.log('✅ Upload successful:', result.info);
                    
                    const imageData = {
                        id: result.info.public_id,
                        publicId: result.info.public_id,
                        url: result.info.secure_url,
                        thumbnail: this.generateThumbnailUrl(result.info.public_id),
                        title: result.info.original_filename || 'Carousel Image',
                        description: '',
                        width: result.info.width,
                        height: result.info.height,
                        size: result.info.bytes,
                        format: result.info.format,
                        createdAt: result.info.created_at,
                        isActive: true,
                        order: this.images.length
                    };

                    this.images.push(imageData);
                    this.saveToDatabase(imageData);
                    this.renderImages();
                    this.renderCarouselPreview();
                    this.showNotification('success', 'Image uploaded successfully!');
                }

                if (result && result.event === 'close') {
                    this.hideUploadProgress();
                }
            }

            generateThumbnailUrl(publicId) {
                return `https://res.cloudinary.com/${this.cloudinaryConfig.cloudName}/image/upload/w_300,h_200,c_fill,q_auto/${publicId}`;
            }

            async saveToDatabase(imageData) {
                try {
                    const response = await fetch('/api/carousel/images', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            publicId: imageData.publicId,
                            url: imageData.url,
                            thumbnail: imageData.thumbnail,
                            title: imageData.title,
                            description: imageData.description,
                            width: imageData.width,
                            height: imageData.height,
                            size: imageData.size,
                            isActive: imageData.isActive,
                            order: imageData.order
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save to database');
                    }

                    console.log('✅ Image saved to database');
                } catch (error) {
                    console.error('❌ Failed to save to database:', error);
                    // Don't throw - allow the image to be added to UI even if DB save fails
                }
            }

            async loadImages() {
                try {
                    console.log('📋 Loading carousel images...');
                    
                    const response = await fetch('/api/carousel/images');
                    
                    if (response.ok) {
                        const result = await response.json();
                        this.images = result.data || result || [];
                        
                        // Ensure images have required properties
                        this.images = this.images.map(img => ({
                            id: img.id || img.public_id,
                            publicId: img.public_id || img.publicId,
                            url: img.secure_url || img.url,
                            thumbnail: img.thumbnail || this.generateThumbnailUrl(img.public_id || img.publicId),
                            title: img.title || 'Carousel Image',
                            description: img.description || '',
                            width: img.width,
                            height: img.height,
                            size: img.bytes || img.size,
                            isActive: img.is_active !== false,
                            order: img.order_index || img.order || 0,
                            createdAt: img.created_at || img.createdAt
                        }));
                        
                        console.log(`✅ Loaded ${this.images.length} carousel images`);
                    } else {
                        console.warn('⚠️ Failed to load images, using empty array');
                        this.images = [];
                    }
                } catch (error) {
                    console.error('❌ Error loading images:', error);
                    this.images = [];
                }
                
                this.renderImages();
                this.renderCarouselPreview();
            }

            setupDragAndDrop() {
                const dropZone = document.getElementById('dropZone');
                
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });

                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    
                    const files = Array.from(e.dataTransfer.files).filter(file => 
                        file.type.startsWith('image/')
                    );
                    
                    if (files.length > 0) {
                        this.uploadFiles(files);
                    }
                });

                dropZone.addEventListener('click', () => {
                    this.openUploadWidget();
                });
            }

            setupFormHandlers() {
                document.getElementById('editImageForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveImageEdit();
                });
            }

            async uploadFiles(files) {
                this.showUploadProgress();
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const progress = ((i + 1) / files.length) * 100;
                    this.updateUploadProgress(progress, `Uploading ${file.name}...`);
                    
                    try {
                        await this.uploadSingleFile(file);
                    } catch (error) {
                        console.error(`Failed to upload ${file.name}:`, error);
                        this.showNotification('error', `Failed to upload ${file.name}`);
                    }
                }
                
                this.hideUploadProgress();
                this.showNotification('success', `${files.length} image(s) uploaded successfully!`);
            }

            async uploadSingleFile(file) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', this.cloudinaryConfig.uploadPreset);
                    formData.append('folder', 'portfolio/carousel');
                    formData.append('tags', 'carousel,portfolio');

                    fetch(`https://api.cloudinary.com/v1_1/${this.cloudinaryConfig.cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.error) {
                            reject(new Error(result.error.message));
                        } else {
                            const imageData = {
                                id: result.public_id,
                                publicId: result.public_id,
                                url: result.secure_url,
                                thumbnail: this.generateThumbnailUrl(result.public_id),
                                title: file.name.replace(/\.[^/.]+$/, ""),
                                description: '',
                                width: result.width,
                                height: result.height,
                                size: result.bytes,
                                format: result.format,
                                createdAt: result.created_at,
                                isActive: true,
                                order: this.images.length
                            };

                            this.images.push(imageData);
                            this.saveToDatabase(imageData);
                            resolve(imageData);
                        }
                    })
                    .catch(reject);
                });
            }

            renderImages() {
                const grid = document.getElementById('imageGrid');
                
                if (this.images.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-images text-6xl mb-4"></i>
                            <h3 class="text-xl font-semibold mb-2">No Images Yet</h3>
                            <p class="mb-4">Upload your first carousel image to get started</p>
                            <button onclick="carouselManager.openUploadWidget()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                                <i class="fas fa-plus mr-2"></i>Add First Image
                            </button>
                        </div>
                    `;
                    return;
                }

                const sortedImages = [...this.images].sort((a, b) => a.order - b.order);
                
                grid.innerHTML = sortedImages.map((image, index) => `
                    <div class="relative group bg-white rounded-lg shadow-md overflow-hidden ${this.editMode ? 'cursor-move' : ''}" 
                         draggable="${this.editMode}" 
                         data-index="${index}"
                         data-id="${image.id}">
                        
                        <img src="${image.thumbnail}" alt="${image.title}" 
                             class="w-full h-48 object-cover">
                        
                        <!-- Overlay Controls -->
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all duration-300 flex items-center justify-center">
                            <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex space-x-2">
                                <button onclick="carouselManager.previewImage('${image.id}')" 
                                        class="bg-white text-gray-900 rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-100 transition">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="carouselManager.editImage('${image.id}')" 
                                        class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-blue-600 transition">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="carouselManager.deleteImage('${image.id}')" 
                                        class="bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-red-600 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Image Info -->
                        <div class="p-4">
                            <h4 class="font-semibold text-gray-900 truncate">${image.title}</h4>
                            <p class="text-sm text-gray-600 truncate">${image.description || 'No description'}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-500">${image.width} × ${image.height}</span>
                                <label class="flex items-center">
                                    <input type="checkbox" ${image.isActive ? 'checked' : ''} 
                                           onchange="carouselManager.toggleImageActive('${image.id}')"
                                           class="mr-1">
                                    <span class="text-xs text-gray-600">Active</span>
                                </label>
                            </div>
                        </div>

                        <!-- Order Badge -->
                        ${this.editMode ? `
                            <div class="absolute top-2 left-2 bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </div>
                        ` : ''}
                    </div>
                `).join('');
            }

            renderCarouselPreview() {
                const container = document.getElementById('carouselPreview');
                const activeImages = this.images.filter(img => img.isActive).sort((a, b) => a.order - b.order);

                if (activeImages.length === 0) {
                    container.innerHTML = `
                        <div class="h-64 flex items-center justify-center text-gray-500">
                            <div class="text-center">
                                <i class="fas fa-images text-4xl mb-4"></i>
                                <h3 class="text-lg font-semibold mb-2">No Active Images</h3>
                                <p>Add and activate images to see the carousel preview</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="relative h-64">
                        <!-- Slides -->
                        ${activeImages.map((image, index) => `
                            <div class="carousel-slide absolute inset-0 ${index === this.currentIndex ? 'opacity-100' : 'opacity-0'}" 
                                 style="transition: opacity 0.5s ease-in-out;">
                                <img src="${image.url}" alt="${image.title}" class="w-full h-full object-cover">
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                                    <h3 class="text-white text-lg font-semibold">${image.title}</h3>
                                    <p class="text-white text-sm opacity-90">${image.description}</p>
                                </div>
                            </div>
                        `).join('')}
                        
                        <!-- Navigation -->
                        ${activeImages.length > 1 ? `
                            <button onclick="carouselManager.previousSlide()" 
                                    class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75 transition">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button onclick="carouselManager.nextSlide()" 
                                    class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75 transition">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <!-- Dots -->
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                                ${activeImages.map((_, index) => `
                                    <button onclick="carouselManager.goToSlide(${index})" 
                                            class="w-3 h-3 rounded-full transition ${index === this.currentIndex ? 'bg-white' : 'bg-white bg-opacity-50'}"></button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="p-4 bg-gray-50 text-center">
                        <p class="text-sm text-gray-600">
                            Showing ${activeImages.length} of ${this.images.length} images
                        </p>
                    </div>
                `;
            }

            // Carousel Navigation
            nextSlide() {
                const activeImages = this.images.filter(img => img.isActive);
                this.currentIndex = (this.currentIndex + 1) % activeImages.length;
                this.renderCarouselPreview();
            }

            previousSlide() {
                const activeImages = this.images.filter(img => img.isActive);
                this.currentIndex = this.currentIndex === 0 ? activeImages.length - 1 : this.currentIndex - 1;
                this.renderCarouselPreview();
            }

            goToSlide(index) {
                this.currentIndex = index;
                this.renderCarouselPreview();
            }

            // Image Management
            openUploadWidget() {
                if (this.uploadWidget) {
                    this.uploadWidget.open();
                } else {
                    console.error('❌ Upload widget not initialized');
                }
            }

            toggleImageActive(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (image) {
                    image.isActive = !image.isActive;
                    this.renderCarouselPreview();
                    this.updateImageInDatabase(image);
                }
            }

            editImage(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                this.currentEditingImage = image;
                
                // Populate form
                document.getElementById('editTitle').value = image.title;
                document.getElementById('editDescription').value = image.description;
                document.getElementById('editActive').checked = image.isActive;
                
                // Show preview
                document.getElementById('editImagePreview').innerHTML = `
                    <img src="${image.thumbnail}" alt="${image.title}" class="max-w-full h-32 object-cover mx-auto rounded-lg">
                `;
                
                // Show modal
                document.getElementById('editModal').classList.remove('hidden');
            }

            closeEditModal() {
                document.getElementById('editModal').classList.add('hidden');
                this.currentEditingImage = null;
            }

            saveImageEdit() {
                if (!this.currentEditingImage) return;

                const title = document.getElementById('editTitle').value;
                const description = document.getElementById('editDescription').value;
                const isActive = document.getElementById('editActive').checked;

                this.currentEditingImage.title = title;
                this.currentEditingImage.description = description;
                this.currentEditingImage.isActive = isActive;

                this.updateImageInDatabase(this.currentEditingImage);
                this.renderImages();
                this.renderCarouselPreview();
                this.closeEditModal();
                
                this.showNotification('success', 'Image updated successfully!');
            }

            async deleteImage(imageId) {
                if (!confirm('Are you sure you want to delete this image?')) return;

                try {
                    // Delete from Cloudinary (requires server endpoint)
                    const image = this.images.find(img => img.id === imageId);
                    if (image) {
                        await fetch('/api/cloudinary/delete', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ publicId: image.publicId })
                        });
                    }

                    // Remove from local array
                    this.images = this.images.filter(img => img.id !== imageId);
                    
                    // Re-render
                    this.renderImages();
                    this.renderCarouselPreview();
                    
                    this.showNotification('success', 'Image deleted successfully!');
                } catch (error) {
                    console.error('❌ Failed to delete image:', error);
                    this.showNotification('error', 'Failed to delete image');
                }
            }

            previewImage(imageId) {
                const image = this.images.find(img => img.id === imageId);
                if (!image) return;

                // Create preview modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="relative max-w-4xl max-h-full p-4">
                        <img src="${image.url}" alt="${image.title}" class="max-w-full max-h-full object-contain">
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center hover:bg-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="absolute bottom-2 left-2 bg-black bg-opacity-75 text-white p-3 rounded">
                            <div class="font-semibold">${image.title}</div>
                            <div class="text-sm text-gray-300">${image.width} × ${image.height} • ${(image.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                
                // Close on click outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            toggleEditMode() {
                this.editMode = !this.editMode;
                const btn = document.getElementById('editModeBtn');
                
                if (this.editMode) {
                    btn.innerHTML = '<i class="fas fa-check mr-2"></i>Done';
                    btn.className = 'bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition';
                } else {
                    btn.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Mode';
                    btn.className = 'bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition';
                }
                
                this.renderImages();
            }

            async saveOrder() {
                try {
                    const response = await fetch('/api/carousel/order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            images: this.images.map((img, index) => ({
                                publicId: img.publicId,
                                order: index,
                                title: img.title,
                                description: img.description,
                                isActive: img.isActive
                            }))
                        })
                    });

                    if (response.ok) {
                        this.showNotification('success', 'Image order saved successfully!');
                    } else {
                        throw new Error('Failed to save order');
                    }
                } catch (error) {
                    console.error('❌ Failed to save order:', error);
                    this.showNotification('error', 'Failed to save image order');
                }
            }

            async updateImageInDatabase(image) {
                try {
                    const response = await fetch(`/api/carousel/images/${image.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: image.title,
                            description: image.description,
                            isActive: image.isActive,
                            order: image.order
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to update image');
                    }
                } catch (error) {
                    console.error('❌ Failed to update image:', error);
                }
            }

            async refreshImages() {
                await this.loadImages();
                this.showNotification('info', 'Images refreshed');
            }

            // UI Helpers
            showUploadProgress() {
                document.getElementById('uploadProgress').classList.remove('hidden');
            }

            hideUploadProgress() {
                document.getElementById('uploadProgress').classList.add('hidden');
                document.getElementById('progressBar').style.width = '0%';
            }

            updateUploadProgress(percent, text) {
                document.getElementById('progressBar').style.width = `${percent}%`;
                document.getElementById('progressText').textContent = text;
            }

            showNotification(type, message) {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white transform translate-x-full transition-transform duration-300 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 
                    type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
                }`;
                
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                document.body.appendChild(notification);
                
                // Slide in
                setTimeout(() => notification.classList.remove('translate-x-full'), 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
        }

        // Initialize carousel manager
        let carouselManager;
        document.addEventListener('DOMContentLoaded', () => {
            carouselManager = new CarouselManager();
        });
    </script>
</body>
</html>