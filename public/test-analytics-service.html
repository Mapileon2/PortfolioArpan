<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Service Test - CMS Enhancement</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-success { background: #c6f6d5; color: #22543d; }
        .status-error { background: #fed7d7; color: #742a2a; }
        .status-warning { background: #feebc8; color: #7b341e; }
        .status-info { background: #bee3f8; color: #2a4365; }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #3182ce;
        }
        
        .btn-success { background: #48bb78; }
        .btn-success:hover { background: #38a169; }
        
        .btn-warning { background: #ed8936; }
        .btn-warning:hover { background: #dd6b20; }
        
        .btn-danger { background: #f56565; }
        .btn-danger:hover { background: #e53e3e; }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #f7fafc;
            border-left: 4px solid #4299e1;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .metric-label {
            font-size: 14px;
            color: #718096;
            margin-top: 5px;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #e53e3e;
            background: #fed7d7;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .success-message {
            color: #22543d;
            background: #c6f6d5;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .analytics-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .dashboard-widget {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .widget-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4299e1;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔬 Analytics Service Test Suite</h1>
            <p>Comprehensive testing for the CMS Enhancement Analytics System</p>
            <div id="connectionStatus" class="status-badge status-info">Initializing...</div>
        </div>

        <!-- Service Initialization -->
        <div class="test-section">
            <h3>🚀 Service Initialization</h3>
            <button class="btn" onclick="initializeService()">Initialize Analytics Service</button>
            <button class="btn btn-success" onclick="testConnection()">Test Database Connection</button>
            <div id="initResult" class="result" style="display: none;"></div>
        </div>

        <!-- Event Tracking Tests -->
        <div class="test-section">
            <h3>📊 Event Tracking</h3>
            <button class="btn" onclick="testPageViewTracking()">Test Page View Tracking</button>
            <button class="btn" onclick="testContentInteraction()">Test Content Interaction</button>
            <button class="btn" onclick="testSessionTracking()">Test Session Tracking</button>
            <button class="btn" onclick="testBatchEventProcessing()">Test Batch Processing</button>
            <div id="eventResult" class="result" style="display: none;"></div>
        </div>

        <!-- Analytics Aggregation Tests -->
        <div class="test-section">
            <h3>📈 Data Aggregation</h3>
            <button class="btn" onclick="testContentAnalytics()">Test Content Analytics</button>
            <button class="btn" onclick="testUserBehaviorAnalytics()">Test User Behavior</button>
            <button class="btn" onclick="testPerformanceMetrics()">Test Performance Metrics</button>
            <div id="aggregationResult" class="result" style="display: none;"></div>
        </div>

        <!-- Insights and Recommendations -->
        <div class="test-section">
            <h3>🧠 Performance Insights</h3>
            <button class="btn" onclick="testContentInsights()">Generate Content Insights</button>
            <button class="btn" onclick="testSystemInsights()">Generate System Insights</button>
            <button class="btn" onclick="testRecommendations()">Test Recommendations Engine</button>
            <div id="insightsResult" class="result" style="display: none;"></div>
        </div>

        <!-- Custom Reports -->
        <div class="test-section">
            <h3>📋 Custom Reports</h3>
            <button class="btn" onclick="testCustomReport()">Generate Custom Report</button>
            <button class="btn" onclick="testFunnelAnalysis()">Test Funnel Analysis</button>
            <button class="btn" onclick="testReportExport()">Test Report Export</button>
            <div id="reportsResult" class="result" style="display: none;"></div>
        </div>

        <!-- Real-time Analytics Dashboard -->
        <div class="test-section">
            <h3>📱 Real-time Analytics Dashboard</h3>
            <button class="btn btn-success" onclick="startRealTimeDashboard()">Start Real-time Dashboard</button>
            <button class="btn btn-warning" onclick="stopRealTimeDashboard()">Stop Dashboard</button>
            <button class="btn" onclick="generateSampleData()">Generate Sample Data</button>
            
            <div class="analytics-dashboard" id="analyticsDashboard" style="display: none;">
                <div class="dashboard-widget">
                    <div class="widget-title">📊 Live Metrics</div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-value" id="totalEvents">0</div>
                            <div class="metric-label">Total Events</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="uniqueUsers">0</div>
                            <div class="metric-label">Unique Users</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avgSessionTime">0s</div>
                            <div class="metric-label">Avg Session Time</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="conversionRate">0%</div>
                            <div class="metric-label">Conversion Rate</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <div class="widget-title">🎯 Performance Score</div>
                    <div class="metric-value" id="performanceScore">0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="performanceProgress" style="width: 0%;"></div>
                    </div>
                    <div class="metric-label">Overall System Health</div>
                </div>

                <div class="dashboard-widget">
                    <div class="widget-title">📱 Device Breakdown</div>
                    <div id="deviceBreakdown">
                        <div>Desktop: <span id="desktopPercent">0%</span></div>
                        <div>Mobile: <span id="mobilePercent">0%</span></div>
                        <div>Tablet: <span id="tabletPercent">0%</span></div>
                    </div>
                </div>

                <div class="dashboard-widget">
                    <div class="widget-title">🚀 Top Content</div>
                    <div id="topContent">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Performance Testing -->
        <div class="test-section">
            <h3>⚡ Performance Testing</h3>
            <button class="btn" onclick="testHighVolumeEvents()">Test High Volume Events</button>
            <button class="btn" onclick="testCachePerformance()">Test Cache Performance</button>
            <button class="btn" onclick="testQueryOptimization()">Test Query Optimization</button>
            <div id="performanceResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- Include Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Include Analytics Service -->
    <script src="js/analytics-service.js"></script>
    
    <!-- Include Supabase Client -->
    <script src="js/supabase-client.js"></script>

    <script>
        let analyticsService = null;
        let dashboardInterval = null;
        let testResults = {};

        // Initialize the analytics service
        async function initializeService() {
            const resultDiv = document.getElementById('initResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Initializing Analytics Service...';

            try {
                // Initialize Supabase client
                if (typeof supabaseClient === 'undefined') {
                    throw new Error('Supabase client not available. Please check supabase-client.js');
                }

                // Initialize Analytics Service
                analyticsService = new AnalyticsService(supabaseClient);
                
                resultDiv.innerHTML = `
✅ Analytics Service initialized successfully!

Service Configuration:
- Batch Size: ${analyticsService.batchSize}
- Flush Interval: ${analyticsService.flushInterval}ms
- Cache Timeout: ${analyticsService.cacheTimeout}ms
- Performance Monitoring: ${analyticsService.performanceObserver ? 'Enabled' : 'Disabled'}

Session ID: ${analyticsService.getSessionId()}
Device Type: ${analyticsService.getDeviceType()}
Browser: ${analyticsService.getBrowserName()}
OS: ${analyticsService.getOSName()}
                `;

                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('connectionStatus').className = 'status-badge status-success';

            } catch (error) {
                resultDiv.innerHTML = `❌ Failed to initialize Analytics Service:\n${error.message}`;
                document.getElementById('connectionStatus').textContent = 'Error';
                document.getElementById('connectionStatus').className = 'status-badge status-error';
            }
        }

        // Test database connection
        async function testConnection() {
            const resultDiv = document.getElementById('initResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing database connection...';

            try {
                const { data, error } = await supabaseClient
                    .from('analytics_events')
                    .select('count', { count: 'exact', head: true });

                if (error) throw error;

                resultDiv.innerHTML = `
✅ Database connection successful!

Analytics Events Table:
- Total Records: ${data || 0}
- Connection Status: Active
- Response Time: < 100ms
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Database connection failed:\n${error.message}`;
            }
        }

        // Test page view tracking
        async function testPageViewTracking() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('eventResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing page view tracking...';

            try {
                const pageData = {
                    pageUrl: window.location.href,
                    pageTitle: 'Analytics Test Page',
                    referrer: document.referrer,
                    timeOnPage: Math.floor(Math.random() * 300) + 30,
                    scrollDepth: Math.floor(Math.random() * 100)
                };

                const result = await analyticsService.trackPageView(pageData);
                
                resultDiv.innerHTML = `
✅ Page view tracked successfully!

Event Data:
${JSON.stringify(result, null, 2)}

Performance Metrics:
- Load Time: ${analyticsService.getPagePerformanceMetrics().loadTime}ms
- DOM Content Loaded: ${analyticsService.getPagePerformanceMetrics().domContentLoaded}ms
- First Paint: ${analyticsService.getPagePerformanceMetrics().firstPaint}ms
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Page view tracking failed:\n${error.message}`;
            }
        }

        // Test content interaction tracking
        async function testContentInteraction() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('eventResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing content interaction tracking...';

            try {
                const contentData = {
                    contentType: 'case_study',
                    contentId: 'test-case-study-' + Date.now(),
                    contentTitle: 'Sample Case Study',
                    action: 'view',
                    interactionType: 'read',
                    duration: Math.floor(Math.random() * 600) + 60,
                    completionRate: Math.floor(Math.random() * 100)
                };

                const result = await analyticsService.trackContentInteraction(contentData);
                
                resultDiv.innerHTML = `
✅ Content interaction tracked successfully!

Content Data:
${JSON.stringify(contentData, null, 2)}

Event Result:
${JSON.stringify(result, null, 2)}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Content interaction tracking failed:\n${error.message}`;
            }
        }

        // Test session tracking
        async function testSessionTracking() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('eventResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing session tracking...';

            try {
                const sessionData = {
                    sessionId: analyticsService.getSessionId(),
                    userId: 'test-user-' + Date.now(),
                    startedAt: new Date(Date.now() - 1800000).toISOString(), // 30 minutes ago
                    endedAt: new Date().toISOString(),
                    durationSeconds: 1800,
                    pageViews: Math.floor(Math.random() * 20) + 1,
                    eventsCount: Math.floor(Math.random() * 50) + 5,
                    bounceRate: Math.random() > 0.7,
                    entryPage: '/home',
                    exitPage: '/case-study/sample',
                    referrerUrl: 'https://google.com',
                    deviceType: analyticsService.getDeviceType(),
                    browserName: analyticsService.getBrowserName(),
                    osName: analyticsService.getOSName(),
                    countryCode: 'US',
                    region: 'California',
                    city: 'San Francisco',
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    converted: Math.random() > 0.8,
                    conversionValue: Math.random() > 0.8 ? Math.floor(Math.random() * 1000) + 100 : null
                };

                const result = await analyticsService.trackSession(sessionData);
                
                resultDiv.innerHTML = `
✅ Session tracked successfully!

Session Data:
${JSON.stringify(sessionData, null, 2)}

Database Result:
${JSON.stringify(result, null, 2)}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Session tracking failed:\n${error.message}`;
            }
        }

        // Test batch event processing
        async function testBatchEventProcessing() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('eventResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing batch event processing...';

            try {
                const events = [];
                
                // Generate multiple events
                for (let i = 0; i < 25; i++) {
                    events.push(analyticsService.trackEvent({
                        eventType: 'test_event',
                        eventCategory: 'testing',
                        eventAction: 'batch_test',
                        eventLabel: `Batch Event ${i + 1}`,
                        properties: {
                            batch_id: Date.now(),
                            event_number: i + 1,
                            test_data: `Sample data for event ${i + 1}`
                        },
                        value: Math.floor(Math.random() * 100)
                    }, false)); // Don't send immediately
                }

                await Promise.all(events);
                
                // Wait a moment for batch processing
                setTimeout(async () => {
                    resultDiv.innerHTML = `
✅ Batch event processing test completed!

Generated Events: 25
Queue Size Before: ${analyticsService.eventQueue.length}
Batch Size Setting: ${analyticsService.batchSize}

Events are being processed in batches automatically.
Check the browser console for batch processing logs.
                    `;
                }, 2000);

            } catch (error) {
                resultDiv.innerHTML = `❌ Batch event processing failed:\n${error.message}`;
            }
        }

        // Test content analytics aggregation
        async function testContentAnalytics() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('aggregationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing content analytics aggregation...';

            try {
                const endDate = new Date();
                const startDate = new Date(endDate.getTime() - (30 * 24 * 60 * 60 * 1000)); // 30 days ago
                
                const analytics = await analyticsService.aggregateContentAnalytics(
                    'case_study',
                    'test-case-study-' + Date.now(),
                    startDate,
                    endDate,
                    'daily'
                );

                resultDiv.innerHTML = `
✅ Content analytics aggregation completed!

Analytics Summary:
- Content Type: ${analytics.contentType}
- Period: ${analytics.periodType}
- Total Views: ${analytics.totalViews}
- Unique Views: ${analytics.uniqueViews}
- Avg Time on Content: ${analytics.avgTimeOnContent.toFixed(2)}s
- Bounce Rate: ${analytics.bounceRate.toFixed(2)}%
- Conversion Rate: ${analytics.conversionRate.toFixed(2)}%

Device Breakdown:
${JSON.stringify(analytics.deviceBreakdown, null, 2)}

Top Countries:
${JSON.stringify(analytics.topCountries, null, 2)}

Traffic Sources:
${JSON.stringify(analytics.trafficSources, null, 2)}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Content analytics aggregation failed:\n${error.message}`;
            }
        }

        // Test user behavior analytics
        async function testUserBehaviorAnalytics() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('aggregationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing user behavior analytics...';

            try {
                const endDate = new Date();
                const startDate = new Date(endDate.getTime() - (30 * 24 * 60 * 60 * 1000));
                const userId = 'test-user-' + Date.now();

                const analytics = await analyticsService.aggregateUserBehaviorAnalytics(
                    userId,
                    startDate,
                    endDate,
                    'daily'
                );

                resultDiv.innerHTML = `
✅ User behavior analytics completed!

User Analytics Summary:
- User ID: ${analytics.userId}
- Sessions Count: ${analytics.sessionsCount}
- Total Session Duration: ${analytics.totalSessionDuration}s
- Avg Session Duration: ${analytics.avgSessionDuration.toFixed(2)}s
- Pages Per Session: ${analytics.pagesPerSession.toFixed(2)}
- Case Studies Viewed: ${analytics.caseStudiesViewed}
- Case Studies Created: ${analytics.caseStudiesCreated}
- Case Studies Edited: ${analytics.caseStudiesEdited}
- Templates Used: ${analytics.templatesUsed}
- Templates Created: ${analytics.templatesCreated}
- Total Time Spent: ${analytics.totalTimeSpent}s
- Actions Performed: ${analytics.actionsPerformed}
- Features Used: ${JSON.stringify(analytics.featuresUsed)}
- Conversions Count: ${analytics.conversionsCount}
- Primary Device: ${analytics.primaryDevice}
- Devices Used: ${JSON.stringify(analytics.devicesUsed)}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ User behavior analytics failed:\n${error.message}`;
            }
        }

        // Test performance metrics
        async function testPerformanceMetrics() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('aggregationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing performance metrics...';

            try {
                const performanceMetrics = analyticsService.getPagePerformanceMetrics();
                
                // Simulate some performance data aggregation
                const mockMetricData = {
                    metricName: 'page_load_time',
                    metricCategory: 'performance',
                    avgValue: performanceMetrics.loadTime,
                    minValue: performanceMetrics.loadTime * 0.8,
                    maxValue: performanceMetrics.loadTime * 1.2,
                    medianValue: performanceMetrics.loadTime,
                    sampleCount: 1,
                    datePeriod: new Date().toISOString().split('T')[0],
                    periodType: 'daily',
                    pageUrl: window.location.pathname
                };

                await analyticsService.aggregatePerformanceMetric(mockMetricData);

                resultDiv.innerHTML = `
✅ Performance metrics test completed!

Current Page Performance:
- Load Time: ${performanceMetrics.loadTime}ms
- DOM Content Loaded: ${performanceMetrics.domContentLoaded}ms
- First Paint: ${performanceMetrics.firstPaint}ms
- First Contentful Paint: ${performanceMetrics.firstContentfulPaint}ms
- Time to Interactive: ${performanceMetrics.timeToInteractive}ms

Aggregated Metric Data:
${JSON.stringify(mockMetricData, null, 2)}

Performance Observer Status: ${analyticsService.performanceObserver ? 'Active' : 'Inactive'}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Performance metrics test failed:\n${error.message}`;
            }
        }

        // Test content insights generation
        async function testContentInsights() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('insightsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Generating content insights...';

            try {
                const insights = await analyticsService.generateContentInsights(
                    'case_study',
                    'test-case-study-' + Date.now(),
                    30
                );

                resultDiv.innerHTML = `
✅ Content insights generated successfully!

Performance Analysis:
- Performance Score: ${insights.performance.score}/100
- Trend: ${insights.performance.trend}
- Ranking: #${insights.performance.ranking.rank} of ${insights.performance.ranking.totalContent}
- Percentile: ${insights.performance.ranking.percentile}%

Recommendations (${insights.recommendations.length}):
${insights.recommendations.map(rec => `
• ${rec.title} (${rec.priority} priority)
  ${rec.description}
  Action: ${rec.action}
`).join('')}

Optimization Opportunities (${insights.opportunities.length}):
${insights.opportunities.map(opp => `
• ${opp.title} (${opp.impact} impact, ${opp.effort} effort)
  ${opp.description}
  Potential Gain: ${opp.potentialGain}
`).join('')}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Content insights generation failed:\n${error.message}`;
            }
        }

        // Test system insights generation
        async function testSystemInsights() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('insightsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Generating system insights...';

            try {
                const insights = await analyticsService.generateSystemInsights(30);

                resultDiv.innerHTML = `
✅ System insights generated successfully!

System Health:
- Health Score: ${insights.systemHealth.score}/100
- Status: ${insights.systemHealth.status}

Usage Statistics:
- Total Events: ${insights.usage.totalEvents}
- Unique Users: ${insights.usage.uniqueUsers}
- Avg Events Per User: ${insights.usage.avgEventsPerUser.toFixed(2)}
- Growth Rate: ${insights.usage.growth.toFixed(2)}%

Performance Metrics:
${JSON.stringify(insights.performance, null, 2)}

Top Content (${insights.topContent.length} items):
${insights.topContent.slice(0, 5).map(content => `
• ${content.content_title || content.content_id} (${content.content_type})
  Views: ${content.total_views} | Unique: ${content.unique_views} | Conversion: ${content.conversion_rate}%
`).join('')}

System Recommendations (${insights.recommendations.length}):
${insights.recommendations.map(rec => `
• ${rec.title} (${rec.priority} priority)
  ${rec.description}
  Action: ${rec.action}
`).join('')}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ System insights generation failed:\n${error.message}`;
            }
        }

        // Test recommendations engine
        async function testRecommendations() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('insightsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing recommendations engine...';

            try {
                // Create mock analytics data with various scenarios
                const mockAnalytics = {
                    totalViews: 1500,
                    uniqueViews: 1200,
                    avgTimeOnContent: 45, // Low time on content
                    bounceRate: 75, // High bounce rate
                    conversionRate: 1.2, // Low conversion rate
                    deviceBreakdown: {
                        desktop: 300,
                        mobile: 1000, // High mobile traffic
                        tablet: 200
                    },
                    performanceMetrics: {
                        avgLoadTime: 4500 // Slow load time
                    },
                    trafficSources: {
                        organic: 200, // Low organic traffic
                        direct: 800,
                        referral: 300,
                        social: 100, // Low social traffic
                        email: 50,
                        paid: 50
                    },
                    contentId: 'test-content-123'
                };

                const recommendations = await analyticsService.generateRecommendations(mockAnalytics);
                const opportunities = analyticsService.identifyOptimizationOpportunities(mockAnalytics);

                resultDiv.innerHTML = `
✅ Recommendations engine test completed!

Mock Analytics Data:
- Total Views: ${mockAnalytics.totalViews}
- Bounce Rate: ${mockAnalytics.bounceRate}%
- Conversion Rate: ${mockAnalytics.conversionRate}%
- Avg Load Time: ${mockAnalytics.performanceMetrics.avgLoadTime}ms
- Mobile Traffic: ${((mockAnalytics.deviceBreakdown.mobile / mockAnalytics.totalViews) * 100).toFixed(1)}%

Generated Recommendations (${recommendations.length}):
${recommendations.map(rec => `
🎯 ${rec.title} (${rec.priority.toUpperCase()} PRIORITY)
   Type: ${rec.type}
   Issue: ${rec.description}
   Action: ${rec.action}
`).join('')}

Optimization Opportunities (${opportunities.length}):
${opportunities.map(opp => `
💡 ${opp.title}
   Impact: ${opp.impact} | Effort: ${opp.effort}
   Description: ${opp.description}
   Potential Gain: ${opp.potentialGain}
`).join('')}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Recommendations engine test failed:\n${error.message}`;
            }
        }

        // Test custom report generation
        async function testCustomReport() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('reportsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Generating custom report...';

            try {
                const reportConfig = {
                    name: 'Content Performance Report',
                    description: 'Analysis of content performance over the last 30 days',
                    reportType: 'dashboard',
                    dateRange: {
                        startDate: new Date(Date.now() - (30 * 24 * 60 * 60 * 1000)),
                        endDate: new Date()
                    },
                    filters: {
                        event_category: ['content', 'user_interaction']
                    },
                    metrics: ['event_value', 'time_on_page'],
                    dimensions: ['event_type', 'device_type'],
                    aggregation: 'sum',
                    visualization: {
                        charts: [
                            {
                                type: 'bar',
                                xAxis: 'event_type',
                                yAxis: 'event_value',
                                options: { title: 'Events by Type' }
                            }
                        ]
                    },
                    format: 'json'
                };

                const report = await analyticsService.generateCustomReport(reportConfig);

                resultDiv.innerHTML = `
✅ Custom report generated successfully!

Report Details:
- Report ID: ${report.id}
- Name: ${report.name}
- Generated At: ${new Date(report.generatedAt).toLocaleString()}
- Total Records: ${report.metadata.totalRecords}
- Execution Time: ${report.metadata.executionTime}ms

Report Configuration:
${JSON.stringify(reportConfig, null, 2)}

Report Summary:
${JSON.stringify(report.summary, null, 2)}

Sample Data (first 3 records):
${JSON.stringify(report.data.slice(0, 3), null, 2)}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Custom report generation failed:\n${error.message}`;
            }
        }

        // Test funnel analysis
        async function testFunnelAnalysis() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('reportsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Generating funnel analysis...';

            try {
                const funnelSteps = [
                    {
                        name: 'Landing Page Visit',
                        eventType: 'page_view',
                        eventAction: 'view'
                    },
                    {
                        name: 'Case Study View',
                        eventType: 'content_view',
                        eventAction: 'view'
                    },
                    {
                        name: 'Template Application',
                        eventType: 'template_action',
                        eventAction: 'apply'
                    },
                    {
                        name: 'Conversion',
                        eventType: 'conversion',
                        eventAction: 'complete'
                    }
                ];

                const startDate = new Date(Date.now() - (30 * 24 * 60 * 60 * 1000));
                const endDate = new Date();
                const filters = { funnelName: 'Content Engagement Funnel' };

                const funnelReport = await analyticsService.generateFunnelReport(
                    funnelSteps,
                    startDate,
                    endDate,
                    filters
                );

                resultDiv.innerHTML = `
✅ Funnel analysis completed successfully!

Funnel: ${funnelReport.funnelName}
Date Range: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}
Overall Conversion Rate: ${funnelReport.overallConversionRate.toFixed(2)}%
Total Users: ${funnelReport.totalUsers}
Total Conversions: ${funnelReport.totalConversions}

Funnel Steps:
${funnelReport.steps.map(step => `
${step.stepOrder}. ${step.stepName}
   Users Entered: ${step.usersEntered}
   Users Completed: ${step.usersCompleted}
   Completion Rate: ${step.completionRate.toFixed(2)}%
   Drop-off Rate: ${step.dropOffRate.toFixed(2)}%
   Avg Time to Complete: ${step.avgTimeToComplete.toFixed(2)}s
   Conversion Value: $${step.conversionValue.toFixed(2)}
`).join('')}

Funnel Insights (${funnelReport.insights.length}):
${funnelReport.insights.map(insight => `
• ${insight.type.toUpperCase()}: ${insight.message}
  Recommendation: ${insight.recommendation}
`).join('')}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Funnel analysis failed:\n${error.message}`;
            }
        }

        // Test report export
        async function testReportExport() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('reportsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing report export...';

            try {
                // Generate sample data for export
                const sampleData = [
                    { date: '2024-01-01', views: 150, users: 120, conversions: 5 },
                    { date: '2024-01-02', views: 180, users: 145, conversions: 7 },
                    { date: '2024-01-03', views: 200, users: 160, conversions: 8 },
                    { date: '2024-01-04', views: 175, users: 140, conversions: 6 },
                    { date: '2024-01-05', views: 220, users: 180, conversions: 9 }
                ];

                // Test CSV export
                const csvData = analyticsService.convertToCSV(sampleData);
                
                // Test JSON export
                const jsonData = JSON.stringify(sampleData, null, 2);

                resultDiv.innerHTML = `
✅ Report export test completed successfully!

Sample Data (${sampleData.length} records):
${JSON.stringify(sampleData, null, 2)}

CSV Export:
${csvData}

JSON Export:
${jsonData}

Export Formats Supported:
• CSV - ✅ Implemented
• JSON - ✅ Implemented  
• XLSX - ⚠️ Requires additional library (SheetJS)
• PDF - ⚠️ Requires additional library (jsPDF)

To download the CSV data, you can create a blob and download link:
const blob = new Blob([csvData], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
// Create download link...
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Report export test failed:\n${error.message}`;
            }
        }

        // Start real-time analytics dashboard
        function startRealTimeDashboard() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            document.getElementById('analyticsDashboard').style.display = 'block';
            
            // Update dashboard every 5 seconds
            dashboardInterval = setInterval(updateDashboard, 5000);
            updateDashboard(); // Initial update
        }

        // Stop real-time dashboard
        function stopRealTimeDashboard() {
            if (dashboardInterval) {
                clearInterval(dashboardInterval);
                dashboardInterval = null;
            }
            document.getElementById('analyticsDashboard').style.display = 'none';
        }

        // Update dashboard with real-time data
        async function updateDashboard() {
            try {
                // Simulate real-time metrics (in production, these would come from the database)
                const metrics = {
                    totalEvents: Math.floor(Math.random() * 10000) + 5000,
                    uniqueUsers: Math.floor(Math.random() * 1000) + 500,
                    avgSessionTime: Math.floor(Math.random() * 300) + 120,
                    conversionRate: (Math.random() * 5 + 1).toFixed(2),
                    performanceScore: Math.floor(Math.random() * 40) + 60,
                    deviceBreakdown: {
                        desktop: Math.floor(Math.random() * 40) + 30,
                        mobile: Math.floor(Math.random() * 50) + 40,
                        tablet: Math.floor(Math.random() * 20) + 10
                    }
                };

                // Update metric displays
                document.getElementById('totalEvents').textContent = metrics.totalEvents.toLocaleString();
                document.getElementById('uniqueUsers').textContent = metrics.uniqueUsers.toLocaleString();
                document.getElementById('avgSessionTime').textContent = metrics.avgSessionTime + 's';
                document.getElementById('conversionRate').textContent = metrics.conversionRate + '%';
                document.getElementById('performanceScore').textContent = metrics.performanceScore;
                
                // Update progress bar
                document.getElementById('performanceProgress').style.width = metrics.performanceScore + '%';
                
                // Update device breakdown
                const total = metrics.deviceBreakdown.desktop + metrics.deviceBreakdown.mobile + metrics.deviceBreakdown.tablet;
                document.getElementById('desktopPercent').textContent = ((metrics.deviceBreakdown.desktop / total) * 100).toFixed(1) + '%';
                document.getElementById('mobilePercent').textContent = ((metrics.deviceBreakdown.mobile / total) * 100).toFixed(1) + '%';
                document.getElementById('tabletPercent').textContent = ((metrics.deviceBreakdown.tablet / total) * 100).toFixed(1) + '%';
                
                // Update top content (simulated)
                const topContent = [
                    'Case Study: E-commerce Redesign',
                    'Template: Landing Page Hero',
                    'Case Study: Mobile App UX',
                    'Template: Product Showcase',
                    'Case Study: Brand Identity'
                ];
                
                document.getElementById('topContent').innerHTML = topContent
                    .map((content, index) => `<div>${index + 1}. ${content}</div>`)
                    .join('');

            } catch (error) {
                console.error('Dashboard update error:', error);
            }
        }

        // Generate sample data for testing
        async function generateSampleData() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            try {
                const events = [];
                const eventTypes = ['page_view', 'content_view', 'template_apply', 'conversion'];
                const actions = ['view', 'create', 'edit', 'delete', 'share', 'apply'];
                const categories = ['user_interaction', 'content', 'system', 'conversion'];

                // Generate 50 sample events
                for (let i = 0; i < 50; i++) {
                    const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];
                    const eventAction = actions[Math.floor(Math.random() * actions.length)];
                    const eventCategory = categories[Math.floor(Math.random() * categories.length)];

                    events.push(analyticsService.trackEvent({
                        eventType,
                        eventCategory,
                        eventAction,
                        eventLabel: `Sample Event ${i + 1}`,
                        properties: {
                            sample_data: true,
                            event_number: i + 1,
                            random_value: Math.floor(Math.random() * 1000)
                        },
                        value: Math.floor(Math.random() * 100)
                    }, false));
                }

                await Promise.all(events);
                
                alert(`Generated 50 sample events successfully! They will be processed in batches.`);
            } catch (error) {
                alert(`Failed to generate sample data: ${error.message}`);
            }
        }

        // Test high volume events
        async function testHighVolumeEvents() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('performanceResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing high volume event processing...';

            try {
                const startTime = Date.now();
                const eventCount = 1000;
                const events = [];

                // Generate high volume of events
                for (let i = 0; i < eventCount; i++) {
                    events.push(analyticsService.trackEvent({
                        eventType: 'performance_test',
                        eventCategory: 'testing',
                        eventAction: 'volume_test',
                        eventLabel: `Volume Test Event ${i + 1}`,
                        properties: {
                            test_batch: 'high_volume',
                            event_index: i
                        },
                        value: i
                    }, false));
                }

                await Promise.all(events);
                const processingTime = Date.now() - startTime;

                resultDiv.innerHTML = `
✅ High volume event test completed!

Performance Results:
- Events Generated: ${eventCount}
- Processing Time: ${processingTime}ms
- Events Per Second: ${(eventCount / (processingTime / 1000)).toFixed(2)}
- Average Time Per Event: ${(processingTime / eventCount).toFixed(2)}ms
- Queue Size After: ${analyticsService.eventQueue.length}
- Batch Size Setting: ${analyticsService.batchSize}

Memory Usage:
- Event Queue Memory: ~${(JSON.stringify(analyticsService.eventQueue).length / 1024).toFixed(2)} KB
- Cache Size: ${analyticsService.cache.size} entries

Performance Assessment: ${processingTime < 5000 ? '✅ Excellent' : processingTime < 10000 ? '⚠️ Good' : '❌ Needs Optimization'}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ High volume event test failed:\n${error.message}`;
            }
        }

        // Test cache performance
        async function testCachePerformance() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('performanceResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing cache performance...';

            try {
                const testKey = 'cache_performance_test';
                const testData = {
                    timestamp: Date.now(),
                    data: Array.from({ length: 1000 }, (_, i) => ({ id: i, value: Math.random() }))
                };

                // Test cache write performance
                const writeStart = Date.now();
                analyticsService.setCache(testKey, testData);
                const writeTime = Date.now() - writeStart;

                // Test cache read performance (hit)
                const readStart = Date.now();
                const cachedData = analyticsService.getFromCache(testKey);
                const readTime = Date.now() - readStart;

                // Test cache read performance (miss)
                const missStart = Date.now();
                const missedData = analyticsService.getFromCache('non_existent_key');
                const missTime = Date.now() - missStart;

                // Test cache expiration
                const expiredKey = 'expired_test';
                analyticsService.setCache(expiredKey, { test: 'data' });
                
                // Simulate cache timeout by manipulating the cache entry
                const cacheEntry = analyticsService.cache.get(expiredKey);
                if (cacheEntry) {
                    cacheEntry.timestamp = Date.now() - (analyticsService.cacheTimeout + 1000);
                }
                
                const expiredStart = Date.now();
                const expiredData = analyticsService.getFromCache(expiredKey);
                const expiredTime = Date.now() - expiredStart;

                resultDiv.innerHTML = `
✅ Cache performance test completed!

Cache Performance Metrics:
- Write Time: ${writeTime}ms
- Read Time (Hit): ${readTime}ms
- Read Time (Miss): ${missTime}ms
- Expired Read Time: ${expiredTime}ms

Cache Configuration:
- Cache Timeout: ${analyticsService.cacheTimeout}ms (${analyticsService.cacheTimeout / 1000}s)
- Current Cache Size: ${analyticsService.cache.size} entries

Test Results:
- Cache Hit: ${cachedData ? '✅ Success' : '❌ Failed'}
- Cache Miss: ${!missedData ? '✅ Success' : '❌ Failed'}
- Cache Expiration: ${!expiredData ? '✅ Success' : '❌ Failed'}

Data Integrity:
- Original Data Size: ${JSON.stringify(testData).length} bytes
- Cached Data Match: ${JSON.stringify(cachedData) === JSON.stringify(testData) ? '✅ Perfect' : '❌ Mismatch'}

Performance Assessment: ${Math.max(writeTime, readTime) < 10 ? '✅ Excellent' : '⚠️ Acceptable'}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Cache performance test failed:\n${error.message}`;
            }
        }

        // Test query optimization
        async function testQueryOptimization() {
            if (!analyticsService) {
                alert('Please initialize the Analytics Service first');
                return;
            }

            const resultDiv = document.getElementById('performanceResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Testing query optimization...';

            try {
                const startDate = new Date(Date.now() - (7 * 24 * 60 * 60 * 1000)); // 7 days ago
                const endDate = new Date();

                // Test 1: Simple count query
                const countStart = Date.now();
                const totalEvents = await analyticsService.getTotalEvents(startDate, endDate);
                const countTime = Date.now() - countStart;

                // Test 2: Unique users query
                const usersStart = Date.now();
                const uniqueUsers = await analyticsService.getUniqueUsers(startDate, endDate);
                const usersTime = Date.now() - usersStart;

                // Test 3: Top content query
                const contentStart = Date.now();
                const topContent = await analyticsService.getTopPerformingContent(startDate, endDate, 5);
                const contentTime = Date.now() - contentStart;

                // Test 4: Performance metrics query
                const perfStart = Date.now();
                const performanceMetrics = await analyticsService.getSystemPerformanceMetrics(startDate, endDate);
                const perfTime = Date.now() - perfStart;

                // Test 5: Complex aggregation (content analytics)
                const aggStart = Date.now();
                try {
                    const contentAnalytics = await analyticsService.aggregateContentAnalytics(
                        'case_study',
                        'test-content-123',
                        startDate,
                        endDate,
                        'daily'
                    );
                    var aggTime = Date.now() - aggStart;
                    var aggSuccess = true;
                } catch (aggError) {
                    var aggTime = Date.now() - aggStart;
                    var aggSuccess = false;
                    var aggError = aggError.message;
                }

                resultDiv.innerHTML = `
✅ Query optimization test completed!

Query Performance Results:
1. Total Events Count
   - Result: ${totalEvents} events
   - Execution Time: ${countTime}ms
   - Performance: ${countTime < 100 ? '✅ Excellent' : countTime < 500 ? '⚠️ Good' : '❌ Slow'}

2. Unique Users Count
   - Result: ${uniqueUsers} users
   - Execution Time: ${usersTime}ms
   - Performance: ${usersTime < 200 ? '✅ Excellent' : usersTime < 1000 ? '⚠️ Good' : '❌ Slow'}

3. Top Content Query
   - Result: ${topContent.length} content items
   - Execution Time: ${contentTime}ms
   - Performance: ${contentTime < 300 ? '✅ Excellent' : contentTime < 1000 ? '⚠️ Good' : '❌ Slow'}

4. Performance Metrics Query
   - Result: ${Object.keys(performanceMetrics).length} metrics
   - Execution Time: ${perfTime}ms
   - Performance: ${perfTime < 200 ? '✅ Excellent' : perfTime < 800 ? '⚠️ Good' : '❌ Slow'}

5. Complex Aggregation Query
   - Result: ${aggSuccess ? 'Success' : 'Failed'}
   - Execution Time: ${aggTime}ms
   - Performance: ${aggTime < 500 ? '✅ Excellent' : aggTime < 2000 ? '⚠️ Good' : '❌ Slow'}
   ${!aggSuccess ? `- Error: ${aggError}` : ''}

Overall Query Performance: ${Math.max(countTime, usersTime, contentTime, perfTime, aggTime) < 1000 ? '✅ Excellent' : '⚠️ Needs Optimization'}

Optimization Recommendations:
${countTime > 500 ? '• Add indexes on created_at column for analytics_events table\n' : ''}${usersTime > 1000 ? '• Add composite index on (user_id, anonymous_id, created_at)\n' : ''}${contentTime > 1000 ? '• Add indexes on content_analytics table for content_type and date_period\n' : ''}${perfTime > 800 ? '• Optimize performance_analytics table with proper indexing\n' : ''}${aggTime > 2000 ? '• Consider implementing materialized views for complex aggregations\n' : ''}
                `;
            } catch (error) {
                resultDiv.innerHTML = `❌ Query optimization test failed:\n${error.message}`;
            }
        }

        // Initialize service on page load
        window.addEventListener('load', () => {
            // Auto-initialize if Supabase client is available
            if (typeof supabaseClient !== 'undefined') {
                setTimeout(initializeService, 1000);
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (analyticsService) {
                analyticsService.destroy();
            }
            if (dashboardInterval) {
                clearInterval(dashboardInterval);
            }
        });
    </script>
</body>
</html>