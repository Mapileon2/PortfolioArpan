<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Study Editor - Integrated Preview System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Cloudinary SDK -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Our Cloudinary Service -->
    <script src="js/cloudinary-service.js"></script>
    
    <!-- Cloudinary Upload Fix -->
    <script src="js/cloudinary-upload-fix.js"></script>
    <script src="fix-upload-now.js"></script>
    
    <!-- Cloudinary Upload with Your Custom Settings -->
    <script src="js/cloudinary-upload-with-settings.js"></script>
    
    <!-- Case Study Sync Fix -->
    <script src="fix-case-study-sync.js"></script>
    
    <!-- Validation Fix -->
    <script src="fix-case-study-validation.js"></script>
    
    <!-- Fast Image Preview System -->
    <script src="js/fast-image-preview.js"></script>
    
    <style>
        :root {
            --ghibli-blue: #6bb2e2;
            --ghibli-green: #a5d6a7;
            --ghibli-yellow: #fff59d;
            --ghibli-red: #ef9a9a;
            --ghibli-purple: #ce93d8;
            --ghibli-orange: #ffcc80;
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        /* Ghibli-inspired preview styles */
        .ghibli-preview {
            font-family: 'Nunito', sans-serif;
            background-color: #f9f7f0;
            color: #333;
            scroll-behavior: smooth;
        }

        .ghibli-preview .ghibli-font { 
            font-family: 'Gochi Hand', cursive; 
        }
        
        .ghibli-preview .handwriting { 
            font-family: 'Patrick Hand', cursive; 
        }

        .ghibli-preview .cloud-bg {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%236bb2e2' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .ghibli-preview .page-section {
            min-height: 80vh;
            padding: 4rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .ghibli-preview .page-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, #6bb2e2, #a5d6a7, #fff59d, #ef9a9a);
        }

        .ghibli-preview .sketch-border {
            border: 3px dashed #333;
            border-radius: 12px;
        }

        .ghibli-preview .floating {
            animation: floating 6s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .ghibli-preview .slide-in {
            animation: slideIn 1s ease-out forwards;
            opacity: 0;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .ghibli-preview .ghibli-text-blue { color: #6bb2e2; }
        .ghibli-preview .ghibli-text-green { color: #a5d6a7; }
        .ghibli-preview .ghibli-text-yellow { color: #fff59d; }
        .ghibli-preview .ghibli-text-red { color: #ef9a9a; }
        .ghibli-preview .ghibli-text-purple { color: #ce93d8; }
        .ghibli-preview .ghibli-text-orange { color: #ffcc80; }
        
        .ghibli-font { font-family: 'Gochi Hand', cursive; }
        .handwriting { font-family: 'Patrick Hand', cursive; }
        
        .editor-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .editor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .section-header {
            background: linear-gradient(135deg, var(--ghibli-blue), var(--ghibli-green));
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 1.5rem;
        }
        
        .upload-zone {
            border: 3px dashed var(--ghibli-blue);
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .upload-zone:hover {
            border-color: var(--ghibli-green);
            background: linear-gradient(135deg, rgba(107, 178, 226, 0.1), rgba(165, 214, 167, 0.1));
        }
        
        .upload-zone.dragover {
            border-color: var(--ghibli-yellow);
            background: linear-gradient(135deg, rgba(255, 245, 157, 0.2), rgba(255, 204, 128, 0.2));
            transform: scale(1.02);
        }
        
        .form-input {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--ghibli-blue);
            box-shadow: 0 0 0 3px rgba(107, 178, 226, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--ghibli-blue), var(--ghibli-green));
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(107, 178, 226, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--ghibli-purple), var(--ghibli-orange));
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            border-radius: 12px;
            padding: 16px 20px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .preview-panel {
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }
        
        .dynamic-list-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(107, 178, 226, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .dynamic-list-item:hover {
            background: rgba(255, 255, 255, 1);
            border-color: var(--ghibli-blue);
        }
        
        .section-toggle {
            transform: scale(1.2);
            accent-color: var(--ghibli-blue);
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }
        
        .field-error .form-input {
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .field-error .error-message {
            display: block;
        }
        
        /* Section visibility animations */
        .section-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .section-content.hidden {
            opacity: 0;
            max-height: 0;
            margin: 0;
            padding: 0;
        }
        
        .section-content.visible {
            opacity: 1;
            max-height: none;
        }
        
        /* Integrated Preview Mode Styles */
        .preview-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            overflow-y: auto;
        }
        
        .preview-mode.active {
            display: block;
        }
        
        .preview-content {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        .preview-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, var(--ghibli-blue), var(--ghibli-green));
            color: white;
            padding: 1rem 2rem;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .preview-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.75rem 2rem;
            text-align: center;
            font-weight: 500;
        }
        
        .preview-section {
            padding: 2rem;
            margin-bottom: 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .preview-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .preview-metric {
            background: linear-gradient(135deg, var(--ghibli-blue), var(--ghibli-green));
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }
        
        /* Image Preview Fixes */
        .image-preview {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
            transition: all 0.3s ease;
        }
        
        .image-preview.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .image-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            color: #6c757d;
        }
        
        /* Aspect ratio utilities for better image display */
        .aspect-video {
            aspect-ratio: 16 / 9;
        }
        
        .aspect-square {
            aspect-ratio: 1 / 1;
        }
        
        .aspect-\[4\/3\] {
            aspect-ratio: 4 / 3;
        }
        
        .aspect-\[3\/2\] {
            aspect-ratio: 3 / 2;
        }
        
        /* Fallback for browsers that don't support aspect-ratio */
        @supports not (aspect-ratio: 1 / 1) {
            .aspect-video {
                position: relative;
                padding-bottom: 56.25%; /* 16:9 */
                height: 0;
            }
            
            .aspect-video > * {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            .aspect-square {
                position: relative;
                padding-bottom: 100%; /* 1:1 */
                height: 0;
            }
            
            .aspect-square > * {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            .aspect-\[4\/3\] {
                position: relative;
                padding-bottom: 75%; /* 4:3 */
                height: 0;
            }
            
            .aspect-\[4\/3\] > * {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="loading-spinner"></div>
            <p class="text-white mt-4 text-lg">Processing...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Navigation -->
    <nav class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold ghibli-font" style="color: var(--ghibli-blue);">
                        <i class="fas fa-magic mr-2"></i>Case Study Editor
                    </h1>
                    <div class="text-sm text-gray-600">
                        <span id="saveStatus" class="font-medium">Ready</span>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="saveBtn" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>Save & Upload Images
                    </button>
                    <button id="testDbBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-database mr-2"></i>Test DB
                    </button>
                    <button id="previewBtn" class="btn-secondary">
                        <i class="fas fa-eye mr-2"></i>Preview
                    </button>
                    <button id="publishBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-rocket mr-2"></i>Publish & Upload Images
                    </button>
                    <div id="pendingImagesIndicator" class="hidden bg-yellow-100 text-yellow-800 px-3 py-1 rounded-lg text-sm">
                        <i class="fas fa-clock mr-1"></i>
                        <span id="pendingImagesCount">0</span> image(s) pending upload
                    </div>
                    <a href="admin-dashboard.html" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Integrated Preview Mode Overlay -->
    <div id="previewMode" class="preview-mode">
        <div class="preview-content">
            <!-- Preview Header -->
            <div class="preview-header">
                <div class="flex items-center">
                    <i class="fas fa-eye mr-2"></i>
                    <span class="font-bold text-lg">Live Preview</span>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="closePreview" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-times mr-2"></i>Close Preview
                    </button>
                </div>
            </div>
            
            <!-- Preview Warning -->
            <div class="preview-warning">
                <i class="fas fa-info-circle mr-2"></i>
                This is a live preview from the editor. Changes are automatically reflected here.
            </div>
            
            <!-- Preview Content -->
            <div id="integratedPreviewContent" class="p-6">
                <!-- Dynamic preview content will be inserted here -->
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header Section -->
        <div class="editor-card mb-8">
            <div class="section-header">
                <h2 class="text-xl font-bold ghibli-font">
                    <i class="fas fa-file-alt mr-2"></i>Case Study Information
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Select Case Study</label>
                        <select id="caseStudySelect" class="form-input w-full">
                            <option value="">Create New Case Study</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Case Study Title *</label>
                        <input type="text" id="caseStudyTitle" class="form-input w-full" placeholder="Enter case study title" required>
                        <div class="error-message">Title is required</div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">Project Category</label>
                        <select id="projectCategory" class="form-input w-full">
                            <option value="web-design">Web Design</option>
                            <option value="mobile-app">Mobile App</option>
                            <option value="product-design">Product Design</option>
                            <option value="branding">Branding</option>
                            <option value="ui-ux">UI/UX Design</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>  
 
        <!-- Section Controls -->
        <div class="editor-card mb-8">
            <div class="section-header">
                <h2 class="text-xl font-bold ghibli-font">
                    <i class="fas fa-toggle-on mr-2"></i>Section Configuration
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <label class="flex items-center p-4 bg-blue-50 rounded-lg cursor-pointer hover:bg-blue-100 transition">
                        <input type="checkbox" id="heroEnabled" class="section-toggle mr-3" checked data-section="hero">
                        <div>
                            <i class="fas fa-star text-yellow-500 mr-2"></i>
                            <span class="font-medium">Hero Section</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-green-50 rounded-lg cursor-pointer hover:bg-green-100 transition">
                        <input type="checkbox" id="overviewEnabled" class="section-toggle mr-3" checked data-section="overview">
                        <div>
                            <i class="fas fa-info-circle text-green-500 mr-2"></i>
                            <span class="font-medium">Overview</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-red-50 rounded-lg cursor-pointer hover:bg-red-100 transition">
                        <input type="checkbox" id="problemEnabled" class="section-toggle mr-3" checked data-section="problem">
                        <div>
                            <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                            <span class="font-medium">Problem</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-purple-50 rounded-lg cursor-pointer hover:bg-purple-100 transition">
                        <input type="checkbox" id="processEnabled" class="section-toggle mr-3" checked data-section="process">
                        <div>
                            <i class="fas fa-cogs text-purple-500 mr-2"></i>
                            <span class="font-medium">Process</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-indigo-50 rounded-lg cursor-pointer hover:bg-indigo-100 transition">
                        <input type="checkbox" id="showcaseEnabled" class="section-toggle mr-3" checked data-section="showcase">
                        <div>
                            <i class="fas fa-desktop text-indigo-500 mr-2"></i>
                            <span class="font-medium">Showcase</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-pink-50 rounded-lg cursor-pointer hover:bg-pink-100 transition">
                        <input type="checkbox" id="reflectionEnabled" class="section-toggle mr-3" checked data-section="reflection">
                        <div>
                            <i class="fas fa-lightbulb text-pink-500 mr-2"></i>
                            <span class="font-medium">Reflection</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-teal-50 rounded-lg cursor-pointer hover:bg-teal-100 transition">
                        <input type="checkbox" id="galleryEnabled" class="section-toggle mr-3" data-section="gallery">
                        <div>
                            <i class="fas fa-images text-teal-500 mr-2"></i>
                            <span class="font-medium">Gallery</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-orange-50 rounded-lg cursor-pointer hover:bg-orange-100 transition">
                        <input type="checkbox" id="videoEnabled" class="section-toggle mr-3" data-section="video">
                        <div>
                            <i class="fas fa-video text-orange-500 mr-2"></i>
                            <span class="font-medium">Video</span>
                        </div>
                    </label>
                    <label class="flex items-center p-4 bg-cyan-50 rounded-lg cursor-pointer hover:bg-cyan-100 transition">
                        <input type="checkbox" id="resourcesEnabled" class="section-toggle mr-3" data-section="resources">
                        <div>
                            <i class="fas fa-external-link-alt text-cyan-500 mr-2"></i>
                            <span class="font-medium">Resources & Links</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Main Editor Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Form Sections -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Hero Section -->
                <div id="heroSection" class="editor-card section-content visible">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-star mr-2"></i>Hero Section
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Hero Title *</label>
                            <input type="text" id="heroTitle" class="form-input w-full" placeholder="Enter compelling title" required>
                            <div class="error-message">Hero title is required</div>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Hero Subtitle</label>
                            <input type="text" id="heroSubtitle" class="form-input w-full" placeholder="Brief description or tagline">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Hero Description</label>
                            <textarea id="heroDescription" rows="4" class="form-input w-full" placeholder="Detailed introduction to your case study"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Hero Image</label>
                            <div id="heroImageUpload" class="upload-zone p-8 text-center">
                                <div id="heroImagePreview" class="hidden">
                                    <img id="heroImageImg" class="w-full h-64 object-cover rounded-lg mb-4">
                                    <div class="flex justify-center space-x-4">
                                        <button type="button" id="changeHeroImage" class="btn-secondary text-sm">
                                            <i class="fas fa-edit mr-1"></i>Change
                                        </button>
                                        <button type="button" id="removeHeroImage" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                            <i class="fas fa-trash mr-1"></i>Remove
                                        </button>
                                    </div>
                                </div>
                                <div id="heroImagePlaceholder">
                                    <i class="fas fa-cloud-upload-alt text-4xl mb-4" style="color: var(--ghibli-blue);"></i>
                                    <p class="text-lg font-semibold mb-2">Upload Hero Image</p>
                                    <p class="text-gray-600 text-sm">Recommended: 1200x600px, JPG/PNG, Max 10MB</p>
                                    <button type="button" id="uploadHeroImage" class="btn-primary mt-4">
                                        <i class="fas fa-upload mr-2"></i>Choose Image
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="heroImageUrl">
                        </div>
                    </div>
                </div>

                <!-- Overview Section -->
                <div id="overviewSection" class="editor-card section-content visible">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-info-circle mr-2"></i>Project Overview
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Overview Title</label>
                            <input type="text" id="overviewTitle" class="form-input w-full" placeholder="Project Overview" value="Project Overview">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Project Summary</label>
                            <textarea id="overviewSummary" rows="4" class="form-input w-full" placeholder="Provide a comprehensive summary of your project"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Key Metrics</label>
                            <div id="metricsContainer" class="space-y-3">
                                <!-- Dynamic metrics will be added here -->
                            </div>
                            <button type="button" id="addMetric" class="btn-primary mt-3">
                                <i class="fas fa-plus mr-2"></i>Add Metric
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Problem Section -->
                <div id="problemSection" class="editor-card section-content visible">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Problem Statement
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Problem Title</label>
                            <input type="text" id="problemTitle" class="form-input w-full" placeholder="The Challenge" value="The Challenge">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Problem Description</label>
                            <textarea id="problemDescription" rows="5" class="form-input w-full" placeholder="Describe the problem you're solving in detail"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Problem Image</label>
                            <div id="problemImageUpload" class="upload-zone p-6 text-center">
                                <div id="problemImagePreview" class="hidden">
                                    <img id="problemImageImg" class="w-full h-48 object-cover rounded-lg mb-4">
                                    <div class="flex justify-center space-x-4">
                                        <button type="button" id="changeProblemImage" class="btn-secondary text-sm">
                                            <i class="fas fa-edit mr-1"></i>Change
                                        </button>
                                        <button type="button" id="removeProblemImage" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                            <i class="fas fa-trash mr-1"></i>Remove
                                        </button>
                                    </div>
                                </div>
                                <div id="problemImagePlaceholder">
                                    <i class="fas fa-image text-3xl mb-3" style="color: var(--ghibli-red);"></i>
                                    <p class="font-semibold mb-2">Upload Problem Illustration</p>
                                    <p class="text-gray-600 text-sm">Screenshots, diagrams, or supporting visuals</p>
                                    <button type="button" id="uploadProblemImage" class="btn-primary mt-3">
                                        <i class="fas fa-upload mr-2"></i>Choose Image
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="problemImageUrl">
                        </div>
                    </div>
                </div>

                <!-- Process Section -->
                <div id="processSection" class="editor-card section-content visible">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-cogs mr-2"></i>Process & Research
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Process Title</label>
                            <input type="text" id="processTitle" class="form-input w-full" placeholder="Our Process" value="Our Process">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Process Description</label>
                            <textarea id="processDescription" rows="3" class="form-input w-full" placeholder="Describe your methodology and approach"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Process Steps</label>
                            <div id="processStepsContainer" class="space-y-3">
                                <!-- Dynamic steps will be added here -->
                            </div>
                            <button type="button" id="addProcessStep" class="btn-primary mt-3">
                                <i class="fas fa-plus mr-2"></i>Add Step
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Showcase Section -->
                <div id="showcaseSection" class="editor-card section-content visible">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-desktop mr-2"></i>Project Showcase
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Showcase Title</label>
                            <input type="text" id="showcaseTitle" class="form-input w-full" placeholder="Final Solution" value="Final Solution">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Showcase Description</label>
                            <textarea id="showcaseDescription" rows="4" class="form-input w-full" placeholder="Describe your final solution and key features"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Showcase Images</label>
                            <div id="showcaseImagesContainer" class="space-y-3">
                                <!-- Dynamic showcase images will be added here -->
                            </div>
                            <button type="button" id="addShowcaseImage" class="btn-primary mt-3">
                                <i class="fas fa-plus mr-2"></i>Add Image
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reflection Section -->
                <div id="reflectionSection" class="editor-card section-content visible">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-lightbulb mr-2"></i>Reflection & Learnings
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Reflection Title</label>
                            <input type="text" id="reflectionTitle" class="form-input w-full" placeholder="Key Learnings" value="Key Learnings">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">What I Learned</label>
                            <textarea id="reflectionLearnings" rows="4" class="form-input w-full" placeholder="Share your key insights and learnings from this project"></textarea>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">What I Would Do Differently</label>
                            <textarea id="reflectionImprovements" rows="3" class="form-input w-full" placeholder="What would you approach differently next time?"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Gallery Section -->
                <div id="gallerySection" class="editor-card section-content hidden">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-images mr-2"></i>Image Gallery
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Gallery Title</label>
                            <input type="text" id="galleryTitle" class="form-input w-full" placeholder="Project Gallery" value="Project Gallery">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Gallery Images</label>
                            <div id="galleryImagesContainer" class="space-y-3">
                                <!-- Dynamic gallery images will be added here -->
                            </div>
                            <button type="button" id="addGalleryImage" class="btn-primary mt-3">
                                <i class="fas fa-plus mr-2"></i>Add Gallery Image
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Video Section -->
                <div id="videoSection" class="editor-card section-content hidden">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-video mr-2"></i>Video Content
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Video Title</label>
                            <input type="text" id="videoTitle" class="form-input w-full" placeholder="Project Demo" value="Project Demo">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Video URL</label>
                            <input type="url" id="videoUrl" class="form-input w-full" placeholder="https://youtube.com/watch?v=... or https://vimeo.com/...">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Video Description</label>
                            <textarea id="videoDescription" rows="3" class="form-input w-full" placeholder="Brief description of the video content"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Resources & Links Section -->
                <div id="resourcesSection" class="editor-card section-content hidden">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-external-link-alt mr-2"></i>Resources & Links
                        </h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        Add links to project resources like Figma prototypes, Miro boards, documentation, and other relevant materials.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Documents Section -->
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-file-alt text-gray-600 mr-2"></i>
                                Documents & Files
                            </h4>
                            <div id="documentsContainer" class="space-y-3">
                                <!-- Document links will be added here -->
                            </div>
                            <button type="button" id="addDocumentBtn" class="mt-3 text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center">
                                <i class="fas fa-plus mr-1"></i>Add Document Link
                            </button>
                        </div>

                        <!-- Design Resources Section -->
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-palette text-purple-600 mr-2"></i>
                                Design Resources
                            </h4>
                            
                            <!-- Figma Prototype -->
                            <div class="mb-4 p-4 border rounded-lg bg-purple-50">
                                <label class="block text-gray-700 font-medium mb-3">
                                    <i class="fab fa-figma text-purple-500 mr-1"></i>Figma Prototype
                                </label>
                                <div class="space-y-3">
                                    <div class="flex space-x-2">
                                        <input type="url" id="figmaUrl" class="form-input flex-1" placeholder="https://figma.com/file/... or https://figma.com/proto/...">
                                        <input type="text" id="figmaTitle" class="form-input w-32" placeholder="Title" value="Figma Prototype">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" id="figmaEmbed" class="mr-2 accent-purple-500">
                                            <span class="text-sm text-gray-700">
                                                <i class="fas fa-window-maximize text-purple-500 mr-1"></i>
                                                Embed as interactive iframe
                                            </span>
                                        </label>
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Use prototype or file URL - will auto-convert for embedding
                                        </div>
                                    </div>
                                    <div class="mt-2 p-3 bg-purple-100 rounded-lg text-xs text-purple-700">
                                        <strong>ðŸ’¡ Figma Tips:</strong><br>
                                        â€¢ <strong>Files:</strong> Copy URL from browser (figma.com/file/...)<br>
                                        â€¢ <strong>Prototypes:</strong> Copy prototype link (figma.com/proto/...)<br>
                                        â€¢ <strong>Designs:</strong> Copy design URL (figma.com/design/...)<br>
                                        â€¢ Enable embedding for interactive iframe with border styling
                                    </div>
                                </div>
                            </div>

                            <!-- Miro Board -->
                            <div class="mb-4 p-4 border rounded-lg bg-yellow-50">
                                <label class="block text-gray-700 font-medium mb-3">
                                    <i class="fas fa-project-diagram text-yellow-500 mr-1"></i>Miro Board
                                </label>
                                <div class="space-y-3">
                                    <div class="flex space-x-2">
                                        <input type="url" id="miroUrl" class="form-input flex-1" placeholder="https://miro.com/app/board/... or https://miro.com/app/live-embed/...">
                                        <input type="text" id="miroTitle" class="form-input w-32" placeholder="Title" value="Miro Board">
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="checkbox" id="miroEmbed" class="mr-2 accent-yellow-500">
                                            <span class="text-sm text-gray-700">
                                                <i class="fas fa-window-maximize text-yellow-500 mr-1"></i>
                                                Embed as interactive iframe
                                            </span>
                                        </label>
                                        <div class="text-xs text-gray-500">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Use board URL - will auto-convert to live-embed for interactivity
                                        </div>
                                    </div>
                                    <div class="mt-2 p-3 bg-yellow-100 rounded-lg text-xs text-yellow-700">
                                        <strong>ðŸ’¡ Miro Tips:</strong><br>
                                        â€¢ Copy the board URL from your browser<br>
                                        â€¢ Enable embedding to show interactive board directly in case study<br>
                                        â€¢ Viewers can zoom, pan, and interact with the board
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Design Links -->
                            <div id="designLinksContainer" class="space-y-3">
                                <!-- Additional design links will be added here -->
                            </div>
                            <button type="button" id="addDesignLinkBtn" class="mt-3 text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center">
                                <i class="fas fa-plus mr-1"></i>Add Design Link
                            </button>
                        </div>

                        <!-- Additional Links Section -->
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-link text-green-600 mr-2"></i>
                                Additional Links
                            </h4>
                            <div id="additionalLinksContainer" class="space-y-3">
                                <!-- Additional links will be added here -->
                            </div>
                            <button type="button" id="addAdditionalLinkBtn" class="mt-3 text-green-600 hover:text-green-800 text-sm font-medium flex items-center">
                                <i class="fas fa-plus mr-1"></i>Add Link
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column - Preview -->
            <div class="space-y-8">
                
                <!-- Live Preview -->
                <div class="editor-card preview-panel">
                    <div class="section-header">
                        <h3 class="text-lg font-bold ghibli-font">
                            <i class="fas fa-eye mr-2"></i>Live Preview
                        </h3>
                    </div>
                    <div class="p-4">
                        <div id="livePreview" class="bg-white rounded-lg p-6 min-h-96 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-magic text-4xl mb-4" style="color: var(--ghibli-blue);"></i>
                                <p class="text-lg handwriting">Start editing to see the magic!</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>  
  
    <script>
        /**
         * COMPLETE Case Study Editor - No External Dependencies
         * All functionality self-contained and working
         */
        class CompleteCaseStudyEditor {
            constructor() {
                this.currentCaseStudy = null;
                this.isDirty = false;
                this.isPreviewMode = false;
                this.imageCache = new Map(); // Cache for image URLs
                this.autoSaveInterval = null;
                this.previewUpdateTimeout = null;
                this.validationRules = {
                    caseStudyTitle: { required: true, minLength: 3 },
                    heroTitle: { required: true, minLength: 3 }
                };
                this.cloudinaryConfig = {
                    cloudName: 'dgymjtqil',
                    apiKey: '951533987774134',
                    apiSecret: 'jTPgMHSl-6m7LptvsBA5eDbOWwc', // For signed uploads
                    uploadPreset: 'ml_default'
                };
                
                // Store pending images for upload
                this.pendingImages = {
                    hero: null,
                    problem: null,
                    showcase: [],
                    gallery: []
                };
                
                this.init();
            }

            async init() {
                try {
                    console.log('ðŸš€ Initializing Complete Case Study Editor...');
                    
                    // Wait for DOM to be ready
                    if (document.readyState === 'loading') {
                        await new Promise(resolve => {
                            document.addEventListener('DOMContentLoaded', resolve);
                        });
                    }
                    
                    // Wait for Cloudinary service to be ready
                    await this.waitForCloudinaryService();
                    
                    // Setup all functionality
                    this.setupEventListeners();
                    this.initializeDynamicLists();
                    this.setupLivePreview();
                    this.setupAutoSave();
                    
                    // Initial preview update
                    this.updateLivePreview();
                    
                    this.showNotification('success', 'Editor Ready', 'All functionality is working perfectly!');
                    console.log('âœ… Complete Case Study Editor ready!');
                    
                } catch (error) {
                    console.error('âŒ Failed to initialize editor:', error);
                    this.showNotification('error', 'Initialization Failed', error.message);
                }
            }

            async waitForCloudinaryService() {
                console.log('â³ Waiting for Cloudinary service...');
                
                return new Promise((resolve) => {
                    const checkService = () => {
                        if (window.cloudinaryService && typeof window.cloudinaryService.uploadImage === 'function') {
                            console.log('âœ… Cloudinary service is ready');
                            resolve();
                        } else {
                            console.log('â³ Cloudinary service not ready yet, retrying...');
                            setTimeout(checkService, 100);
                        }
                    };
                    checkService();
                });
            }

            setupEventListeners() {
                console.log('ðŸ”§ Setting up event listeners...');
                
                // Navigation buttons
                this.setupNavigationListeners();
                
                // Section toggles - WORKING IMPLEMENTATION
                this.setupSectionToggleListeners();
                
                // Form inputs - WORKING IMPLEMENTATION
                this.setupFormInputListeners();
                
                // Image upload buttons
                this.setupImageUploadListeners();
                
                // Dynamic list buttons
                this.setupDynamicListListeners();
                
                // Case study selection
                this.setupCaseStudySelectionListener();
                
                console.log('âœ… All event listeners set up successfully');
            }

            setupNavigationListeners() {
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => this.saveCaseStudy());
                }
                
                const previewBtn = document.getElementById('previewBtn');
                if (previewBtn) {
                    previewBtn.addEventListener('click', () => this.toggleIntegratedPreview());
                }
                
                const testDbBtn = document.getElementById('testDbBtn');
                if (testDbBtn) {
                    testDbBtn.addEventListener('click', () => this.testDatabaseConnection());
                }
                
                const closePreviewBtn = document.getElementById('closePreview');
                if (closePreviewBtn) {
                    closePreviewBtn.addEventListener('click', () => this.closeIntegratedPreview());
                }
                
                const publishBtn = document.getElementById('publishBtn');
                if (publishBtn) {
                    publishBtn.addEventListener('click', () => this.publishCaseStudy());
                }
            }

            // WORKING CHECKBOX IMPLEMENTATION
            setupSectionToggleListeners() {
                const toggles = document.querySelectorAll('.section-toggle');
                console.log(`Found ${toggles.length} section toggles`);
                
                toggles.forEach(toggle => {
                    toggle.addEventListener('change', (e) => {
                        const sectionName = e.target.dataset.section;
                        const isEnabled = e.target.checked;
                        
                        console.log(`ðŸ”„ Section ${sectionName} ${isEnabled ? 'enabled' : 'disabled'}`);
                        
                        // Update section visibility
                        this.toggleSectionVisibility(sectionName, isEnabled);
                        
                        // Mark as dirty and update preview
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
            }

            // WORKING FORM INPUT LISTENERS
            setupFormInputListeners() {
                const inputs = document.querySelectorAll('.form-input');
                console.log(`Found ${inputs.length} form inputs`);
                
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                    
                    input.addEventListener('change', () => {
                        this.validateField(input);
                    });
                });
            }

            setupImageUploadListeners() {
                // Hero image
                const uploadHeroBtn = document.getElementById('uploadHeroImage');
                if (uploadHeroBtn) {
                    uploadHeroBtn.addEventListener('click', () => this.uploadImage('hero'));
                }
                
                const changeHeroBtn = document.getElementById('changeHeroImage');
                if (changeHeroBtn) {
                    changeHeroBtn.addEventListener('click', () => this.uploadImage('hero'));
                }
                
                const removeHeroBtn = document.getElementById('removeHeroImage');
                if (removeHeroBtn) {
                    removeHeroBtn.addEventListener('click', () => this.removeImage('hero'));
                }
                
                // Problem image
                const uploadProblemBtn = document.getElementById('uploadProblemImage');
                if (uploadProblemBtn) {
                    uploadProblemBtn.addEventListener('click', () => this.uploadImage('problem'));
                }
                
                const changeProblemBtn = document.getElementById('changeProblemImage');
                if (changeProblemBtn) {
                    changeProblemBtn.addEventListener('click', () => this.uploadImage('problem'));
                }
                
                const removeProblemBtn = document.getElementById('removeProblemImage');
                if (removeProblemBtn) {
                    removeProblemBtn.addEventListener('click', () => this.removeImage('problem'));
                }
            }

            setupDynamicListListeners() {
                const addMetricBtn = document.getElementById('addMetric');
                if (addMetricBtn) {
                    addMetricBtn.addEventListener('click', () => this.addMetric());
                }
                
                const addProcessStepBtn = document.getElementById('addProcessStep');
                if (addProcessStepBtn) {
                    addProcessStepBtn.addEventListener('click', () => this.addProcessStep());
                }
                
                const addShowcaseImageBtn = document.getElementById('addShowcaseImage');
                if (addShowcaseImageBtn) {
                    addShowcaseImageBtn.addEventListener('click', () => this.addShowcaseImage());
                }
                
                const addGalleryImageBtn = document.getElementById('addGalleryImage');
                if (addGalleryImageBtn) {
                    addGalleryImageBtn.addEventListener('click', () => this.addGalleryImage());
                }

                // Resources section listeners
                const addDocumentBtn = document.getElementById('addDocumentBtn');
                if (addDocumentBtn) {
                    addDocumentBtn.addEventListener('click', () => this.addDocumentLink());
                }

                const addDesignLinkBtn = document.getElementById('addDesignLinkBtn');
                if (addDesignLinkBtn) {
                    addDesignLinkBtn.addEventListener('click', () => this.addDesignLink());
                }

                const addAdditionalLinkBtn = document.getElementById('addAdditionalLinkBtn');
                if (addAdditionalLinkBtn) {
                    addAdditionalLinkBtn.addEventListener('click', () => this.addAdditionalLink());
                }
            }

            setupCaseStudySelectionListener() {
                const select = document.getElementById('caseStudySelect');
                if (select) {
                    select.addEventListener('change', (e) => {
                        if (e.target.value) {
                            this.loadCaseStudy(e.target.value);
                        } else {
                            this.createNewCaseStudy();
                        }
                    });
                }
            }

            // WORKING SECTION VISIBILITY TOGGLE
            toggleSectionVisibility(sectionName, isEnabled) {
                const sectionElement = document.getElementById(`${sectionName}Section`);
                if (!sectionElement) {
                    console.warn(`âš ï¸ Section element not found: ${sectionName}Section`);
                    return;
                }
                
                if (isEnabled) {
                    sectionElement.classList.remove('hidden');
                    sectionElement.classList.add('visible');
                    console.log(`âœ… Section ${sectionName} shown`);
                } else {
                    sectionElement.classList.remove('visible');
                    sectionElement.classList.add('hidden');
                    console.log(`âœ… Section ${sectionName} hidden`);
                }
            }

            // WORKING LIVE PREVIEW
            setupLivePreview() {
                this.updateLivePreview();
                console.log('âœ… Live preview initialized');
            }

            debouncedUpdatePreview() {
                if (this.previewUpdateTimeout) {
                    clearTimeout(this.previewUpdateTimeout);
                }
                
                this.previewUpdateTimeout = setTimeout(() => {
                    this.updateLivePreview();
                    // Also update integrated preview if active
                    if (this.isPreviewMode) {
                        this.updateIntegratedPreview();
                    }
                }, 300);
            }

            updateLivePreview() {
                try {
                    const preview = document.getElementById('livePreview');
                    if (!preview) return;
                    
                    const data = this.collectFormData();
                    let html = '';
                    
                    // Generate preview HTML for enabled sections only
                    Object.keys(data.sections).forEach(sectionName => {
                        const section = data.sections[sectionName];
                        if (section.enabled) {
                            const sectionHtml = this.generateSectionPreview(sectionName, section);
                            if (sectionHtml) {
                                html += sectionHtml;
                            }
                        }
                    });
                    
                    if (!html) {
                        html = `
                            <div class="text-center text-gray-500 py-12">
                                <i class="fas fa-magic text-4xl mb-4" style="color: var(--ghibli-blue);"></i>
                                <p class="text-lg handwriting">Start editing to see the magic!</p>
                            </div>
                        `;
                    }
                    
                    preview.innerHTML = html;
                    
                } catch (error) {
                    console.error('âŒ Preview update error:', error);
                }
            }

            generateSectionPreview(sectionName, sectionData) {
                switch (sectionName) {
                    case 'hero':
                        return this.generateHeroPreview(sectionData);
                    case 'overview':
                        return this.generateOverviewPreview(sectionData);
                    case 'problem':
                        return this.generateProblemPreview(sectionData);
                    case 'process':
                        return this.generateProcessPreview(sectionData);
                    case 'showcase':
                        return this.generateShowcasePreview(sectionData);
                    case 'reflection':
                        return this.generateReflectionPreview(sectionData);
                    case 'gallery':
                        return this.generateGalleryPreview(sectionData);
                    case 'video':
                        return this.generateVideoPreview(sectionData);
                    case 'resources':
                        return this.generateResourcesPreview(sectionData);
                    default:
                        return '';
                }
            }

            generateHeroPreview(data) {
                if (!data.title && !data.subtitle && !data.description && !data.image) return '';
                
                return `
                    <section class="page-section cloud-bg flex items-center justify-center">
                        <div class="container mx-auto px-6 flex flex-col md:flex-row items-center">
                            <div class="md:w-1/2 mb-10 md:mb-0 slide-in">
                                ${data.title ? `<h1 class="text-4xl md:text-6xl font-bold mb-6 ghibli-text-blue ghibli-font">${this.escapeHtml(data.title)}</h1>` : ''}
                                ${data.subtitle ? `<h2 class="text-2xl md:text-3xl mb-6 ghibli-text-green handwriting">${this.escapeHtml(data.subtitle)}</h2>` : ''}
                                ${data.description ? `<p class="text-lg mb-8 text-gray-700">${this.escapeHtml(data.description)}</p>` : ''}
                            </div>
                            ${data.image ? `
                                <div class="md:w-1/2 flex justify-center slide-in">
                                    <div class="relative floating">
                                        <img src="${this.escapeHtml(data.image)}" alt="Hero image" class="w-full max-w-md h-auto object-contain rounded-xl shadow-lg">
                                        <div class="absolute -bottom-6 -left-6 w-24 h-24 bg-yellow-100 rounded-full opacity-70"></div>
                                        <div class="absolute -top-6 -right-6 w-16 h-16 bg-blue-100 rounded-full opacity-70"></div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </section>
                `;
            }

            generateOverviewPreview(data) {
                if (!data.title && !data.summary && (!data.metrics || data.metrics.length === 0)) return '';
                
                return `
                    <section class="page-section bg-white">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-green handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            <div class="grid md:grid-cols-2 gap-8 mb-12">
                                ${data.summary ? `
                                    <div class="bg-green-50 p-8 rounded-xl sketch-border slide-in">
                                        <h3 class="text-2xl font-bold mb-4 ghibli-text-green">Project Summary</h3>
                                        <p class="text-gray-700 leading-relaxed">${this.escapeHtml(data.summary)}</p>
                                    </div>
                                ` : ''}
                                
                                ${data.metrics && data.metrics.length > 0 ? `
                                    <div class="bg-blue-50 p-8 rounded-xl sketch-border slide-in">
                                        <h3 class="text-2xl font-bold mb-4 ghibli-text-blue">Key Metrics</h3>
                                        <div class="grid grid-cols-2 gap-4">
                                            ${data.metrics.map(metric => `
                                                <div class="bg-white p-4 rounded-lg text-center">
                                                    <div class="text-2xl font-bold ghibli-text-blue mb-2">${this.escapeHtml(metric.value)}</div>
                                                    <div class="text-sm text-gray-600">${this.escapeHtml(metric.name)}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </section>
                `;
            }

            generateProblemPreview(data) {
                if (!data.title && !data.description && !data.image) return '';
                
                return `
                    <section class="page-section bg-yellow-50">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-red handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            <div class="grid md:grid-cols-2 gap-12 items-center">
                                <div class="slide-in">
                                    ${data.description ? `<p class="text-lg mb-6 text-gray-700 leading-relaxed">${this.escapeHtml(data.description)}</p>` : ''}
                                    <div class="bg-white p-6 rounded-xl sketch-border">
                                        <h4 class="font-bold mb-3 ghibli-text-red">Challenge Overview</h4>
                                        <div class="text-gray-700">
                                            Understanding the core problem and its impact on users and business goals.
                                        </div>
                                    </div>
                                </div>
                                
                                ${data.image ? `
                                    <div class="slide-in">
                                        <div class="bg-white p-6 rounded-xl shadow-lg sketch-border">
                                            <img src="${this.escapeHtml(data.image)}" alt="Problem illustration" class="w-full h-64 object-cover rounded-lg mb-4">
                                            <p class="text-sm text-gray-600 text-center">Problem visualization</p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </section>
                `;
            }

            generateProcessPreview(data) {
                if (!data.title && !data.description && (!data.steps || data.steps.length === 0)) return '';
                
                return `
                    <section class="page-section bg-purple-50">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-purple handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            ${data.description ? `
                                <div class="text-center mb-12 slide-in">
                                    <p class="text-lg text-gray-700 max-w-3xl mx-auto leading-relaxed">${this.escapeHtml(data.description)}</p>
                                </div>
                            ` : ''}
                            
                            ${data.steps && data.steps.length > 0 ? `
                                <div class="max-w-4xl mx-auto">
                                    <div class="space-y-8">
                                        ${data.steps.map((step, index) => `
                                            <div class="flex items-start slide-in" style="animation-delay: ${index * 0.2}s">
                                                <div class="flex-shrink-0 mr-6">
                                                    <div class="w-12 h-12 bg-purple-500 text-white rounded-full flex items-center justify-center text-xl font-bold ghibli-font">
                                                        ${index + 1}
                                                    </div>
                                                </div>
                                                <div class="bg-white p-6 rounded-xl sketch-border flex-1">
                                                    <p class="text-gray-700 leading-relaxed">${this.escapeHtml(step)}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </section>
                `;
            }

            generateShowcasePreview(data) {
                if (!data.title && !data.description && (!data.images || data.images.length === 0)) return '';
                
                return `
                    <section class="page-section bg-indigo-50">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-blue handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            ${data.description ? `
                                <div class="text-center mb-12 slide-in">
                                    <p class="text-lg text-gray-700 max-w-3xl mx-auto leading-relaxed">${this.escapeHtml(data.description)}</p>
                                </div>
                            ` : ''}
                            
                            ${data.images && data.images.length > 0 ? `
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    ${data.images.map((image, index) => `
                                        <div class="slide-in" style="animation-delay: ${index * 0.2}s">
                                            <div class="bg-white p-6 rounded-xl sketch-border shadow-lg">
                                                <img src="${this.escapeHtml(image.url)}" alt="${this.escapeHtml(image.caption || 'Showcase image')}" class="w-full h-64 object-cover rounded-lg mb-4">
                                                ${image.caption ? `<p class="text-center text-gray-600 handwriting">${this.escapeHtml(image.caption)}</p>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </section>
                `;
            }

            generateReflectionPreview(data) {
                if (!data.title && !data.learnings && !data.improvements) return '';
                
                return `
                    <section class="page-section bg-pink-50">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-red handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            <div class="grid md:grid-cols-2 gap-8">
                                ${data.learnings ? `
                                    <div class="bg-white p-8 rounded-xl sketch-border slide-in">
                                        <h3 class="text-2xl font-bold mb-4 ghibli-text-green">
                                            <i class="fas fa-lightbulb mr-2"></i>What I Learned
                                        </h3>
                                        <p class="text-gray-700 leading-relaxed">${this.escapeHtml(data.learnings)}</p>
                                    </div>
                                ` : ''}
                                
                                ${data.improvements ? `
                                    <div class="bg-white p-8 rounded-xl sketch-border slide-in">
                                        <h3 class="text-2xl font-bold mb-4 ghibli-text-blue">
                                            <i class="fas fa-arrow-up mr-2"></i>What I'd Do Differently
                                        </h3>
                                        <p class="text-gray-700 leading-relaxed">${this.escapeHtml(data.improvements)}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </section>
                `;
            }

            generateGalleryPreview(data) {
                if (!data.title && (!data.images || data.images.length === 0)) return '';
                
                return `
                    <section class="page-section bg-teal-50">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-green handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            ${data.images && data.images.length > 0 ? `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${data.images.map((image, index) => `
                                        <div class="slide-in floating" style="animation-delay: ${index * 0.1}s">
                                            <div class="bg-white p-4 rounded-xl sketch-border shadow-lg hover:shadow-xl transition-shadow">
                                                <img src="${this.escapeHtml(image.url)}" alt="${this.escapeHtml(image.caption || 'Gallery image')}" class="w-full h-48 object-cover rounded-lg mb-3">
                                                ${image.caption ? `<p class="text-center text-gray-600 handwriting text-sm">${this.escapeHtml(image.caption)}</p>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </section>
                `;
            }

            generateVideoPreview(data) {
                if (!data.title && !data.url && !data.description) return '';
                
                return `
                    <section class="page-section bg-orange-50">
                        <div class="container mx-auto px-6">
                            ${data.title ? `<h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-orange handwriting slide-in">${this.escapeHtml(data.title)}</h2>` : ''}
                            
                            <div class="max-w-4xl mx-auto">
                                ${data.url ? `
                                    <div class="bg-white p-6 rounded-xl sketch-border shadow-lg slide-in mb-8">
                                        ${this.generateVideoEmbed(data.url)}
                                    </div>
                                ` : ''}
                                
                                ${data.description ? `
                                    <div class="text-center slide-in">
                                        <p class="text-lg text-gray-700 leading-relaxed">${this.escapeHtml(data.description)}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </section>
                `;
            }

            generateResourcesPreview(data) {
                if (!data.figmaUrl && !data.miroUrl && (!data.documents || data.documents.length === 0) && 
                    (!data.designLinks || data.designLinks.length === 0) && (!data.additionalLinks || data.additionalLinks.length === 0)) {
                    return '';
                }
                
                let html = `
                    <section class="page-section bg-cyan-50">
                        <div class="container mx-auto px-6">
                            <h2 class="text-3xl md:text-4xl font-bold mb-12 text-center ghibli-text-blue handwriting slide-in">${this.escapeHtml(data.title || 'Resources & Links')}</h2>
                `;

                // Figma and Miro resources with iframe support
                if (data.figmaUrl || data.miroUrl) {
                    html += '<div class="mb-12"><h3 class="text-2xl font-bold mb-8 ghibli-text-purple handwriting slide-in flex items-center justify-center"><i class="fas fa-palette mr-3"></i>Design Resources</h3>';
                    
                    // Figma Prototype
                    if (data.figmaUrl) {
                        html += `<div class="mb-6">`;
                        html += `<h4 class="font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fab fa-figma text-purple-500 mr-2"></i>
                            ${this.escapeHtml(data.figmaTitle || 'Figma Prototype')}
                        </h4>`;
                        
                        if (data.figmaEmbed && this.isFigmaEmbedUrl(data.figmaUrl)) {
                            // Show embedded iframe with proper Figma format
                            const embedUrl = this.convertToFigmaEmbedUrl(data.figmaUrl);
                            html += `
                                <div class="mb-3">
                                    <iframe 
                                        style="border: 1px solid rgba(0, 0, 0, 0.1);" 
                                        width="100%" 
                                        height="450" 
                                        src="${this.escapeHtml(embedUrl)}" 
                                        allowfullscreen
                                        class="w-full rounded-lg">
                                    </iframe>
                                </div>
                                <div class="flex items-center justify-between text-sm text-gray-600">
                                    <span><i class="fas fa-window-maximize mr-1"></i>Interactive Figma Design</span>
                                    <a href="${this.escapeHtml(data.figmaUrl)}" target="_blank" class="text-purple-600 hover:text-purple-800">
                                        <i class="fas fa-external-link-alt mr-1"></i>Open in Figma
                                    </a>
                                </div>
                            `;
                        } else {
                            // Show as link
                            html += `
                                <a href="${this.escapeHtml(data.figmaUrl)}" target="_blank" class="flex items-center p-4 bg-white rounded-lg border hover:shadow-md transition-shadow">
                                    <i class="fab fa-figma text-purple-500 mr-3 text-xl"></i>
                                    <div class="flex-1">
                                        <span class="font-medium block">${this.escapeHtml(data.figmaTitle || 'Figma Prototype')}</span>
                                        <span class="text-sm text-gray-600">Click to view prototype</span>
                                    </div>
                                    <i class="fas fa-external-link-alt text-gray-400"></i>
                                </a>
                            `;
                        }
                        html += `</div>`;
                    }
                    
                    // Miro Board
                    if (data.miroUrl) {
                        html += `<div class="mb-6">`;
                        html += `<h4 class="font-medium text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-project-diagram text-yellow-500 mr-2"></i>
                            ${this.escapeHtml(data.miroTitle || 'Miro Board')}
                        </h4>`;
                        
                        if (data.miroEmbed && this.isMiroEmbedUrl(data.miroUrl)) {
                            // Show embedded iframe
                            const embedUrl = this.convertToMiroEmbedUrl(data.miroUrl);
                            const originalUrl = data.miroUrl.includes('/live-embed/') ? 
                                data.miroUrl.replace('/live-embed/', '/board/').replace('/?autoplay=true', '') : 
                                data.miroUrl;
                            html += `
                                <div class="bg-white rounded-lg border shadow-sm overflow-hidden mb-3">
                                    <iframe 
                                        src="${this.escapeHtml(embedUrl)}" 
                                        width="100%" 
                                        height="500" 
                                        frameborder="0" 
                                        scrolling="no" 
                                        allowfullscreen
                                        class="w-full">
                                    </iframe>
                                </div>
                                <div class="flex items-center justify-between text-sm text-gray-600">
                                    <span><i class="fas fa-window-maximize mr-1"></i>Interactive Miro Board</span>
                                    <a href="${this.escapeHtml(originalUrl)}" target="_blank" class="text-yellow-600 hover:text-yellow-800">
                                        <i class="fas fa-external-link-alt mr-1"></i>Open in Miro
                                    </a>
                                </div>
                            `;
                        } else {
                            // Show as link
                            html += `
                                <a href="${this.escapeHtml(data.miroUrl)}" target="_blank" class="flex items-center p-4 bg-white rounded-lg border hover:shadow-md transition-shadow">
                                    <i class="fas fa-project-diagram text-yellow-500 mr-3 text-xl"></i>
                                    <div class="flex-1">
                                        <span class="font-medium block">${this.escapeHtml(data.miroTitle || 'Miro Board')}</span>
                                        <span class="text-sm text-gray-600">Click to view board</span>
                                    </div>
                                    <i class="fas fa-external-link-alt text-gray-400"></i>
                                </a>
                            `;
                        }
                        html += `</div>`;
                    }
                    
                    html += '</div>';
                }

                // Documents
                if (data.documents && data.documents.length > 0) {
                    html += '<div class="mb-4"><h3 class="font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-file-alt text-gray-600 mr-2"></i>Documents</h3><div class="space-y-2">';
                    data.documents.forEach(doc => {
                        html += `
                            <a href="${this.escapeHtml(doc.url)}" target="_blank" class="flex items-center p-3 bg-white rounded-lg border hover:shadow-md transition-shadow">
                                <i class="fas fa-file-alt text-gray-500 mr-3"></i>
                                <span class="font-medium">${this.escapeHtml(doc.title)}</span>
                                <i class="fas fa-external-link-alt ml-auto text-gray-400 text-sm"></i>
                            </a>
                        `;
                    });
                    html += '</div></div>';
                }

                // Design Links
                if (data.designLinks && data.designLinks.length > 0) {
                    html += '<div class="mb-4"><h3 class="font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-palette text-purple-500 mr-2"></i>Additional Design Resources</h3><div class="space-y-2">';
                    data.designLinks.forEach(link => {
                        html += `
                            <a href="${this.escapeHtml(link.url)}" target="_blank" class="flex items-center p-3 bg-white rounded-lg border hover:shadow-md transition-shadow">
                                <i class="fas fa-link text-purple-500 mr-3"></i>
                                <span class="font-medium">${this.escapeHtml(link.title)}</span>
                                <i class="fas fa-external-link-alt ml-auto text-gray-400 text-sm"></i>
                            </a>
                        `;
                    });
                    html += '</div></div>';
                }

                // Additional Links
                if (data.additionalLinks && data.additionalLinks.length > 0) {
                    html += '<div class="mb-4"><h3 class="font-semibold text-gray-800 mb-2 flex items-center"><i class="fas fa-link text-green-600 mr-2"></i>Additional Links</h3><div class="space-y-2">';
                    data.additionalLinks.forEach(link => {
                        html += `
                            <a href="${this.escapeHtml(link.url)}" target="_blank" class="flex items-center p-3 bg-white rounded-lg border hover:shadow-md transition-shadow">
                                <i class="fas fa-external-link-alt text-green-500 mr-3"></i>
                                <div class="flex-1">
                                    <span class="font-medium block">${this.escapeHtml(link.title)}</span>
                                    ${link.description ? `<span class="text-sm text-gray-600">${this.escapeHtml(link.description)}</span>` : ''}
                                </div>
                                <i class="fas fa-external-link-alt ml-auto text-gray-400 text-sm"></i>
                            </a>
                        `;
                    });
                    html += '</div></div>';
                }

                html += `
                        </div>
                    </section>
                `;
                return html;
            }
    
        // Data collection with proper section handling
            collectFormData() {
                const sections = {};
                
                // Collect all sections with their enabled state
                const sectionNames = ['hero', 'overview', 'problem', 'process', 'showcase', 'reflection', 'gallery', 'video', 'resources'];
                
                sectionNames.forEach(sectionName => {
                    const enabledCheckbox = document.getElementById(`${sectionName}Enabled`);
                    const isEnabled = enabledCheckbox ? enabledCheckbox.checked : false;
                    
                    sections[sectionName] = {
                        enabled: isEnabled,
                        ...this.collectSectionData(sectionName)
                    };
                });
                
                return {
                    project_title: this.getInputValue('caseStudyTitle') || 'Untitled Project',
                    project_description: this.getInputValue('heroDescription') || this.getInputValue('overviewSummary') || '',
                    project_image_url: this.getInputValue('heroImageUrl') || null,
                    project_category: this.getInputValue('projectCategory') || 'web-design',
                    project_rating: 5,
                    project_achievement: 'Successfully completed',
                    status: 'published',
                    sections: sections
                };
            }

            collectSectionData(sectionName) {
                switch (sectionName) {
                    case 'hero':
                        return {
                            title: this.getInputValue('heroTitle'),
                            subtitle: this.getInputValue('heroSubtitle'),
                            description: this.getInputValue('heroDescription'),
                            image: this.getInputValue('heroImageUrl')
                        };
                    
                    case 'overview':
                        return {
                            title: this.getInputValue('overviewTitle') || 'Project Overview',
                            summary: this.getInputValue('overviewSummary'),
                            metrics: this.collectMetrics()
                        };
                    
                    case 'problem':
                        return {
                            title: this.getInputValue('problemTitle') || 'The Challenge',
                            description: this.getInputValue('problemDescription'),
                            image: this.getInputValue('problemImageUrl')
                        };
                    
                    case 'process':
                        return {
                            title: this.getInputValue('processTitle') || 'Our Process',
                            description: this.getInputValue('processDescription'),
                            steps: this.collectProcessSteps()
                        };
                    
                    case 'showcase':
                        return {
                            title: this.getInputValue('showcaseTitle') || 'Final Solution',
                            description: this.getInputValue('showcaseDescription'),
                            images: this.collectShowcaseImages()
                        };
                    
                    case 'reflection':
                        return {
                            title: this.getInputValue('reflectionTitle') || 'Key Learnings',
                            learnings: this.getInputValue('reflectionLearnings'),
                            improvements: this.getInputValue('reflectionImprovements')
                        };
                    
                    case 'gallery':
                        return {
                            title: this.getInputValue('galleryTitle') || 'Project Gallery',
                            images: this.collectGalleryImages()
                        };
                    
                    case 'video':
                        return {
                            title: this.getInputValue('videoTitle') || 'Project Demo',
                            url: this.getInputValue('videoUrl'),
                            description: this.getInputValue('videoDescription')
                        };
                    
                    case 'resources':
                        return {
                            title: 'Resources & Links',
                            figmaUrl: this.getInputValue('figmaUrl'),
                            figmaTitle: this.getInputValue('figmaTitle'),
                            figmaEmbed: this.getCheckboxValue('figmaEmbed'),
                            miroUrl: this.getInputValue('miroUrl'),
                            miroTitle: this.getInputValue('miroTitle'),
                            miroEmbed: this.getCheckboxValue('miroEmbed'),
                            documents: this.collectDocumentLinks(),
                            designLinks: this.collectDesignLinks(),
                            additionalLinks: this.collectAdditionalLinks()
                        };
                    
                    default:
                        return {};
                }
            }

            getInputValue(id) {
                const element = document.getElementById(id);
                return element ? element.value : '';
            }

            getCheckboxValue(id) {
                const element = document.getElementById(id);
                return element ? element.checked : false;
            }

            // WORKING DYNAMIC LISTS
            initializeDynamicLists() {
                this.clearContainer('metricsContainer');
                this.addMetric();
                
                this.clearContainer('processStepsContainer');
                this.addProcessStep();
                
                this.clearContainer('showcaseImagesContainer');
                this.clearContainer('galleryImagesContainer');
            }

            clearContainer(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                }
            }

            addMetric() {
                const container = document.getElementById('metricsContainer');
                if (!container) return;
                
                const metricDiv = document.createElement('div');
                metricDiv.className = 'dynamic-list-item flex space-x-3 items-center';
                metricDiv.innerHTML = `
                    <input type="text" placeholder="Metric name (e.g., User Satisfaction)" class="form-input flex-1">
                    <input type="text" placeholder="Value (e.g., 95%)" class="form-input flex-1">
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(metricDiv);
                
                // Add event listeners
                metricDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
                
                // Remove button
                metricDiv.querySelector('button').addEventListener('click', () => {
                    metricDiv.remove();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            addProcessStep() {
                const container = document.getElementById('processStepsContainer');
                if (!container) return;
                
                const stepNumber = container.children.length + 1;
                const stepDiv = document.createElement('div');
                stepDiv.className = 'dynamic-list-item flex space-x-3 items-center';
                stepDiv.innerHTML = `
                    <span class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">${stepNumber}</span>
                    <input type="text" placeholder="Process step description" class="form-input flex-1">
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(stepDiv);
                
                // Add event listener
                stepDiv.querySelector('input').addEventListener('input', () => {
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
                
                // Remove button
                stepDiv.querySelector('button').addEventListener('click', () => {
                    stepDiv.remove();
                    this.renumberSteps();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            addShowcaseImage() {
                const container = document.getElementById('showcaseImagesContainer');
                if (!container) return;
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'dynamic-list-item space-y-3';
                imageDiv.innerHTML = `
                    <div class="flex space-x-3 items-center">
                        <input type="url" placeholder="Image URL" class="form-input flex-1">
                        <button type="button" class="btn-secondary text-sm">
                            <i class="fas fa-upload mr-1"></i>Upload
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" placeholder="Image caption (optional)" class="form-input w-full">
                `;
                
                container.appendChild(imageDiv);
                
                // Add event listeners
                imageDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
                
                // Upload button
                imageDiv.querySelector('.btn-secondary').addEventListener('click', () => {
                    this.uploadShowcaseImage(imageDiv);
                });
                
                // Remove button
                imageDiv.querySelector('.bg-red-500').addEventListener('click', () => {
                    imageDiv.remove();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            addGalleryImage() {
                const container = document.getElementById('galleryImagesContainer');
                if (!container) return;
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'dynamic-list-item space-y-3';
                imageDiv.innerHTML = `
                    <div class="flex space-x-3 items-center">
                        <input type="url" placeholder="Image URL" class="form-input flex-1">
                        <button type="button" class="btn-secondary text-sm">
                            <i class="fas fa-upload mr-1"></i>Upload
                        </button>
                        <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" placeholder="Image caption (optional)" class="form-input w-full">
                `;
                
                container.appendChild(imageDiv);
                
                // Add event listeners
                imageDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
                
                // Upload button
                imageDiv.querySelector('.btn-secondary').addEventListener('click', () => {
                    this.uploadGalleryImage(imageDiv);
                });
                
                // Remove button
                imageDiv.querySelector('.bg-red-500').addEventListener('click', () => {
                    imageDiv.remove();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            // Resources Section Functions
            addDocumentLink() {
                const container = document.getElementById('documentsContainer');
                if (!container) return;
                
                const linkDiv = document.createElement('div');
                linkDiv.className = 'dynamic-list-item flex space-x-3 items-center';
                linkDiv.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <input type="text" placeholder="Document title" class="form-input w-full">
                        <input type="url" placeholder="Document URL" class="form-input w-full">
                    </div>
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(linkDiv);
                
                // Add event listeners
                linkDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
                
                // Remove button
                linkDiv.querySelector('button').addEventListener('click', () => {
                    linkDiv.remove();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            addDesignLink() {
                const container = document.getElementById('designLinksContainer');
                if (!container) return;
                
                const linkDiv = document.createElement('div');
                linkDiv.className = 'dynamic-list-item flex space-x-3 items-center';
                linkDiv.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <input type="text" placeholder="Design resource title" class="form-input w-full">
                        <input type="url" placeholder="Design resource URL" class="form-input w-full">
                    </div>
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(linkDiv);
                
                // Add event listeners
                linkDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
                
                // Remove button
                linkDiv.querySelector('button').addEventListener('click', () => {
                    linkDiv.remove();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            addAdditionalLink() {
                const container = document.getElementById('additionalLinksContainer');
                if (!container) return;
                
                const linkDiv = document.createElement('div');
                linkDiv.className = 'dynamic-list-item flex space-x-3 items-center';
                linkDiv.innerHTML = `
                    <div class="flex-1 space-y-2">
                        <input type="text" placeholder="Link title" class="form-input w-full">
                        <input type="url" placeholder="Link URL" class="form-input w-full">
                        <input type="text" placeholder="Description (optional)" class="form-input w-full">
                    </div>
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded transition">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(linkDiv);
                
                // Add event listeners
                linkDiv.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        this.markDirty();
                        this.debouncedUpdatePreview();
                    });
                });
                
                // Remove button
                linkDiv.querySelector('button').addEventListener('click', () => {
                    linkDiv.remove();
                    this.markDirty();
                    this.debouncedUpdatePreview();
                });
            }

            renumberSteps() {
                const container = document.getElementById('processStepsContainer');
                if (!container) return;
                
                Array.from(container.children).forEach((step, index) => {
                    const numberSpan = step.querySelector('span');
                    if (numberSpan) {
                        numberSpan.textContent = index + 1;
                    }
                });
            }

            collectMetrics() {
                const metrics = [];
                const container = document.getElementById('metricsContainer');
                if (!container) return metrics;
                
                Array.from(container.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        metrics.push({
                            name: inputs[0].value,
                            value: inputs[1].value
                        });
                    }
                });
                
                return metrics;
            }

            collectProcessSteps() {
                const steps = [];
                const container = document.getElementById('processStepsContainer');
                if (!container) return steps;
                
                Array.from(container.children).forEach(item => {
                    const input = item.querySelector('input');
                    if (input && input.value) {
                        steps.push(input.value);
                    }
                });
                
                return steps;
            }

            collectShowcaseImages() {
                const images = [];
                const container = document.getElementById('showcaseImagesContainer');
                if (!container) return images;
                
                Array.from(container.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value) {
                        images.push({
                            url: inputs[0].value,
                            caption: inputs[1].value || ''
                        });
                    }
                });
                
                return images;
            }

            collectGalleryImages() {
                const images = [];
                const container = document.getElementById('galleryImagesContainer');
                if (!container) return images;
                
                Array.from(container.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value) {
                        images.push({
                            url: inputs[0].value,
                            caption: inputs[1].value || ''
                        });
                    }
                });
                
                return images;
            }

            // Resources section collection functions
            collectDocumentLinks() {
                const links = [];
                const container = document.getElementById('documentsContainer');
                if (!container) return links;
                
                Array.from(container.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        links.push({
                            title: inputs[0].value,
                            url: inputs[1].value
                        });
                    }
                });
                
                return links;
            }

            collectDesignLinks() {
                const links = [];
                const container = document.getElementById('designLinksContainer');
                if (!container) return links;
                
                Array.from(container.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        links.push({
                            title: inputs[0].value,
                            url: inputs[1].value
                        });
                    }
                });
                
                return links;
            }

            collectAdditionalLinks() {
                const links = [];
                const container = document.getElementById('additionalLinksContainer');
                if (!container) return links;
                
                Array.from(container.children).forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        links.push({
                            title: inputs[0].value,
                            url: inputs[1].value,
                            description: inputs[2] ? inputs[2].value : ''
                        });
                    }
                });
                
                return links;
            }

            // Image upload functionality
            async uploadImage(section) {
                try {
                    this.showFallbackUpload(section);
                } catch (error) {
                    console.error('âŒ Image upload error:', error);
                    this.showNotification('error', 'Upload Error', error.message);
                }
            }

            async uploadShowcaseImage(imageDiv) {
                try {
                    this.showFallbackUploadForDiv(imageDiv, 'showcase');
                } catch (error) {
                    console.error('âŒ Showcase image upload error:', error);
                    this.showNotification('error', 'Upload Error', error.message);
                }
            }

            async uploadGalleryImage(imageDiv) {
                try {
                    this.showFallbackUploadForDiv(imageDiv, 'gallery');
                } catch (error) {
                    console.error('âŒ Gallery image upload error:', error);
                    this.showNotification('error', 'Upload Error', error.message);
                }
            }

            showFallbackUpload(section) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.style.display = 'none';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            // Validate file
                            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                                throw new Error('File size must be less than 10MB');
                            }
                            
                            if (!file.type.startsWith('image/')) {
                                throw new Error('Please select a valid image file');
                            }
                            
                            // Store file for later upload
                            this.pendingImages[section] = {
                                file: file,
                                section: section,
                                timestamp: Date.now()
                            };
                            
                            // Create local preview immediately
                            const objectUrl = URL.createObjectURL(file);
                            this.setImagePreview(section, objectUrl);
                            
                            // Set a temporary URL that will be replaced on save/publish
                            const pendingUrl = `pending-upload-${section}-${Date.now()}`;
                            document.getElementById(`${section}ImageUrl`).value = pendingUrl;
                            
                            console.log('ðŸ“¸ Debug: Image uploaded for section:', section);
                            console.log('ðŸ”— Debug: Pending URL set:', pendingUrl);
                            console.log('ðŸ“Š Debug: Pending images object:', this.pendingImages);
                            
                            this.markDirty();
                            this.debouncedUpdatePreview();
                            
                            this.showNotification('info', 'Image Selected', `Image will be uploaded when you save or publish (${(file.size / 1024 / 1024).toFixed(1)}MB)`);
                            
                        } catch (error) {
                            console.error('âŒ Image selection failed:', error);
                            this.showNotification('error', 'Selection Failed', error.message);
                        }
                    }
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            showFallbackUploadForDiv(imageDiv, section) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.style.display = 'none';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            // Validate file
                            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                                throw new Error('File size must be less than 10MB');
                            }
                            
                            if (!file.type.startsWith('image/')) {
                                throw new Error('Please select a valid image file');
                            }
                            
                            // Generate unique ID for this image
                            const imageId = `${section}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                            
                            // Store file for later upload
                            if (!this.pendingImages[section]) {
                                this.pendingImages[section] = [];
                            }
                            this.pendingImages[section].push({
                                file: file,
                                section: section,
                                imageId: imageId,
                                imageDiv: imageDiv,
                                timestamp: Date.now()
                            });
                            
                            // Create local preview
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                // Set the URL in the input with a pending identifier
                                const urlInput = imageDiv.querySelector('input[type="url"]');
                                if (urlInput) {
                                    urlInput.value = `pending-upload-${imageId}`;
                                    urlInput.setAttribute('data-pending-file', 'true');
                                    urlInput.setAttribute('data-image-id', imageId);
                                }
                                
                                this.markDirty();
                                this.debouncedUpdatePreview();
                            };
                            reader.readAsDataURL(file);
                            
                            this.showNotification('info', 'Image Selected', `Image will be uploaded when you save or publish (${(file.size / 1024 / 1024).toFixed(1)}MB)`);
                            
                        } catch (error) {
                            console.error('âŒ Image selection failed:', error);
                            this.showNotification('error', 'Selection Failed', error.message);
                        }
                    }
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            // Upload all pending images to Cloudinary
            async uploadAllPendingImages() {
                const totalImages = this.countPendingImages();
                if (totalImages === 0) {
                    console.log('ðŸ“¸ No pending images to upload');
                    return;
                }
                
                console.log(`ðŸ“¸ Uploading ${totalImages} pending images to Cloudinary...`);
                let uploadedCount = 0;
                
                try {
                    // Upload hero image
                    if (this.pendingImages.hero) {
                        this.updateSaveStatus(`Uploading hero image... (${++uploadedCount}/${totalImages})`);
                        const result = await this.uploadSingleImage(this.pendingImages.hero);
                        document.getElementById('heroImageUrl').value = result.secure_url;
                        this.setImagePreview('hero', result.secure_url);
                        this.pendingImages.hero = null;
                    }
                    
                    // Upload problem image
                    if (this.pendingImages.problem) {
                        this.updateSaveStatus(`Uploading problem image... (${++uploadedCount}/${totalImages})`);
                        const result = await this.uploadSingleImage(this.pendingImages.problem);
                        document.getElementById('problemImageUrl').value = result.secure_url;
                        this.setImagePreview('problem', result.secure_url);
                        this.pendingImages.problem = null;
                    }
                    
                    // Upload showcase images
                    if (this.pendingImages.showcase && this.pendingImages.showcase.length > 0) {
                        for (const imageData of this.pendingImages.showcase) {
                            this.updateSaveStatus(`Uploading showcase image... (${++uploadedCount}/${totalImages})`);
                            const result = await this.uploadSingleImage(imageData);
                            
                            // Update the corresponding input
                            const urlInput = imageData.imageDiv.querySelector('input[type="url"]');
                            if (urlInput) {
                                urlInput.value = result.secure_url;
                                urlInput.removeAttribute('data-pending-file');
                                urlInput.removeAttribute('data-image-id');
                            }
                        }
                        this.pendingImages.showcase = [];
                    }
                    
                    // Upload gallery images
                    if (this.pendingImages.gallery && this.pendingImages.gallery.length > 0) {
                        for (const imageData of this.pendingImages.gallery) {
                            this.updateSaveStatus(`Uploading gallery image... (${++uploadedCount}/${totalImages})`);
                            const result = await this.uploadSingleImage(imageData);
                            
                            // Update the corresponding input
                            const urlInput = imageData.imageDiv.querySelector('input[type="url"]');
                            if (urlInput) {
                                urlInput.value = result.secure_url;
                                urlInput.removeAttribute('data-pending-file');
                                urlInput.removeAttribute('data-image-id');
                            }
                        }
                        this.pendingImages.gallery = [];
                    }
                    
                    console.log(`âœ… Successfully uploaded ${uploadedCount} images to Cloudinary`);
                    
                } catch (error) {
                    console.error('âŒ Failed to upload images:', error);
                    throw new Error(`Image upload failed: ${error.message}`);
                }
            }
            
            // Upload a single image to Cloudinary using your custom settings
            async uploadSingleImage(imageData) {
                try {
                    console.log(`ðŸ“¤ Uploading ${imageData.file.name} with custom settings...`);
                    
                    // Use the custom settings upload service first
                    if (window.cloudinaryUploadWithSettings) {
                        const result = await window.cloudinaryUploadWithSettings.uploadImage(imageData.file, {
                            folder: `portfolio/case-studies/${imageData.section}`,
                            tags: `case-study,${imageData.section}`
                        });
                        
                        console.log(`âœ… Uploaded ${imageData.file.name} with custom settings:`, result.secure_url);
                        return {
                            secure_url: result.secure_url,
                            public_id: result.public_id,
                            width: result.width,
                            height: result.height
                        };
                    }
                    
                    // Fallback to direct upload with your custom settings
                    console.log(`ðŸ“¤ Using direct upload with custom settings for ${imageData.file.name}...`);
                    
                    const formData = new FormData();
                    formData.append('file', imageData.file);
                    formData.append('upload_preset', 'ml_default');
                    
                    // Apply your custom settings
                    formData.append('overwrite', 'false');
                    formData.append('use_filename', 'false');
                    formData.append('unique_filename', 'false');
                    formData.append('use_filename_as_display_name', 'true');
                    formData.append('use_asset_folder_as_public_id_prefix', 'false');
                    formData.append('type', 'upload');
                    formData.append('asset_folder', 'portfolio');
                    formData.append('folder', `portfolio/case-studies/${imageData.section}`);
                    formData.append('tags', `case-study,${imageData.section}`);
                    
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${this.cloudinaryConfig.cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        
                        // If unsigned upload fails, try signed upload with custom settings
                        if (errorData.error?.message?.includes('Upload preset must be whitelisted')) {
                            console.log('ðŸ” Trying signed upload with custom settings...');
                            return await this.uploadWithSignedSettings(imageData);
                        }
                        
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log(`âœ… Uploaded ${imageData.file.name} with custom settings:`, result.secure_url);
                    return result;
                    
                } catch (error) {
                    console.error(`âŒ Failed to upload ${imageData.file.name}:`, error);
                    
                    // Try signed upload as final fallback
                    try {
                        console.log('ðŸ” Attempting signed upload as fallback...');
                        return await this.uploadWithSignedSettings(imageData);
                    } catch (signedError) {
                        console.error(`âŒ Signed upload also failed:`, signedError);
                        throw new Error(`All upload methods failed: ${error.message}`);
                    }
                }
            }
            
            // Signed upload with your custom settings
            async uploadWithSignedSettings(imageData) {
                const timestamp = Math.round(Date.now() / 1000);
                
                // Create parameters with your custom settings
                const params = {
                    timestamp: timestamp,
                    overwrite: false,
                    use_filename: false,
                    unique_filename: false,
                    use_filename_as_display_name: true,
                    use_asset_folder_as_public_id_prefix: false,
                    type: 'upload',
                    asset_folder: 'portfolio',
                    folder: `portfolio/case-studies/${imageData.section}`,
                    tags: `case-study,${imageData.section}`
                };
                
                // Generate signature
                const signature = await this.generateCloudinarySignature(params);
                
                const formData = new FormData();
                formData.append('file', imageData.file);
                formData.append('api_key', this.cloudinaryConfig.apiKey);
                formData.append('timestamp', timestamp);
                formData.append('signature', signature);
                
                // Add all parameters
                Object.keys(params).forEach(key => {
                    if (key !== 'timestamp') {
                        formData.append(key, params[key]);
                    }
                });
                
                const response = await fetch(`https://api.cloudinary.com/v1_1/${this.cloudinaryConfig.cloudName}/image/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log(`âœ… Signed upload successful for ${imageData.file.name}:`, result.secure_url);
                return result;
            }
            
            // Generate Cloudinary signature
            async generateCloudinarySignature(params) {
                const sortedParams = Object.keys(params)
                    .sort()
                    .map(key => `${key}=${params[key]}`)
                    .join('&');
                
                const stringToSign = sortedParams + this.cloudinaryConfig.apiSecret;
                
                // Generate SHA-1 hash
                const encoder = new TextEncoder();
                const data = encoder.encode(stringToSign);
                const hashBuffer = await crypto.subtle.digest('SHA-1', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
            
            // Count total pending images
            countPendingImages() {
                let count = 0;
                if (this.pendingImages.hero) count++;
                if (this.pendingImages.problem) count++;
                if (this.pendingImages.showcase) count += this.pendingImages.showcase.length;
                if (this.pendingImages.gallery) count += this.pendingImages.gallery.length;
                return count;
            }

            setImagePreview(section, imageUrl) {
                const preview = document.getElementById(`${section}ImagePreview`);
                const placeholder = document.getElementById(`${section}ImagePlaceholder`);
                const img = document.getElementById(`${section}ImageImg`);
                
                if (preview && placeholder && img) {
                    img.src = imageUrl;
                    preview.classList.remove('hidden');
                    placeholder.style.display = 'none';
                }
            }

            removeImage(section) {
                const preview = document.getElementById(`${section}ImagePreview`);
                const placeholder = document.getElementById(`${section}ImagePlaceholder`);
                const urlInput = document.getElementById(`${section}ImageUrl`);
                
                if (preview && placeholder) {
                    preview.classList.add('hidden');
                    placeholder.style.display = 'block';
                }
                
                if (urlInput) {
                    urlInput.value = '';
                }
                
                this.markDirty();
                this.debouncedUpdatePreview();
            }

            // Case study management
            createNewCaseStudy() {
                this.currentCaseStudy = null;
                
                // Clear form
                document.querySelectorAll('.form-input').forEach(input => {
                    if (input.type !== 'checkbox') {
                        input.value = '';
                    }
                });
                
                // Reset checkboxes to default state
                const defaultSections = ['hero', 'overview', 'problem', 'process', 'showcase', 'reflection'];
                document.querySelectorAll('.section-toggle').forEach(toggle => {
                    const shouldBeChecked = defaultSections.includes(toggle.dataset.section);
                    toggle.checked = shouldBeChecked;
                    this.toggleSectionVisibility(toggle.dataset.section, shouldBeChecked);
                });
                
                // Clear images
                this.removeImage('hero');
                this.removeImage('problem');
                
                // Reset dynamic lists
                this.initializeDynamicLists();
                
                this.updateLivePreview();
                
                this.isDirty = false;
                this.updateSaveStatus('Ready');
                
                console.log('ðŸ“ Created new case study');
            }

            async testDatabaseConnection() {
                try {
                    this.showLoading('Testing database connection...');
                    
                    const response = await fetch('/api/case-studies');
                    const data = await response.json();
                    
                    this.hideLoading();
                    
                    if (response.ok) {
                        this.showNotification('success', 'Database Connected!', 
                            `Found ${Array.isArray(data) ? data.length : 0} case studies in database`);
                    } else {
                        this.showNotification('error', 'Database Error', 
                            `Status: ${response.status} - ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showNotification('error', 'Connection Failed', error.message);
                }
            }

            async saveCaseStudy(silent = false) {
                try {
                    if (!this.validateForm()) {
                        if (!silent) {
                            this.showNotification('warning', 'Validation Failed', 'Please fix the errors before saving');
                        }
                        return false;
                    }
                    
                    if (!silent) {
                        this.showLoading('Processing and uploading images...');
                        this.updateSaveStatus('Processing images...');
                    }
                    
                    // First, upload all pending images to Cloudinary
                    await this.uploadAllPendingImages();
                    
                    if (!silent) {
                        this.updateSaveStatus('Saving case study...');
                    }
                    
                    const caseStudyData = this.collectFormData();
                    
                    // Save to database via API
                    console.log('ðŸ’¾ Saving case study with uploaded images:', caseStudyData);
                    
                    const response = await fetch('/api/case-studies', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(caseStudyData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        this.currentCaseStudy = result;
                        this.isDirty = false;
                        this.updateSaveStatus('Saved');
                        
                        if (!silent) {
                            this.hideLoading();
                            this.showNotification('success', 'Saved Successfully', `Case study saved with ID: ${result.id}`);
                        }
                        
                        // Trigger homepage sync
                        if (window.CaseStudyHomepageSync) {
                            window.CaseStudyHomepageSync.triggerSync();
                        }
                        
                        return true;
                    } else {
                        throw new Error(result.error || 'Failed to save case study');
                    }
                    
                } catch (error) {
                    console.error('âŒ Save failed:', error);
                    this.updateSaveStatus('Save Failed');
                    
                    if (!silent) {
                        this.hideLoading();
                        this.showNotification('error', 'Save Failed', error.message);
                    }
                    
                    return false;
                }
            }

            async publishCaseStudy() {
                try {
                    this.showLoading('Processing images and publishing...');
                    this.updateSaveStatus('Processing images...');
                    
                    // First, upload all pending images to Cloudinary
                    await this.uploadAllPendingImages();
                    
                    this.updateSaveStatus('Publishing...');
                    
                    // Save the case study first
                    await this.saveCaseStudy(true);
                    
                    // Mock publish - replace with actual API call
                    console.log('ðŸš€ Publishing case study with all images uploaded');
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    this.hideLoading();
                    this.updateSaveStatus('Published');
                    this.showNotification('success', 'Published!', 'Your case study is now live with all images uploaded to Cloudinary');
                    
                } catch (error) {
                    console.error('âŒ Publish failed:', error);
                    this.hideLoading();
                    this.updateSaveStatus('Publish Failed');
                    this.showNotification('error', 'Publish Failed', error.message);
                }
            }

            // INTEGRATED PREVIEW SYSTEM - NO MORE EXTERNAL WINDOWS
            toggleIntegratedPreview() {
                if (this.isPreviewMode) {
                    this.closeIntegratedPreview();
                } else {
                    this.openIntegratedPreview();
                }
            }

            openIntegratedPreview() {
                try {
                    this.isPreviewMode = true;
                    this.updateIntegratedPreview();
                    
                    document.getElementById('previewMode').classList.add('active');
                    document.getElementById('previewBtn').innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Mode';
                    
                    this.showNotification('info', 'Preview Mode', 'You are now in preview mode. Changes will be reflected instantly.');
                    console.log('âœ… Integrated preview opened');
                    
                } catch (error) {
                    console.error('âŒ Preview failed:', error);
                    this.showNotification('error', 'Preview Failed', 'Could not open preview');
                }
            }

            closeIntegratedPreview() {
                this.isPreviewMode = false;
                document.getElementById('previewMode').classList.remove('active');
                document.getElementById('previewBtn').innerHTML = '<i class="fas fa-eye mr-2"></i>Preview';
                
                this.showNotification('info', 'Edit Mode', 'You are back in edit mode.');
                console.log('âœ… Integrated preview closed');
            }

            updateIntegratedPreview() {
                if (!this.isPreviewMode) return;
                
                const caseStudyData = this.collectFormData();
                const previewContent = document.getElementById('integratedPreviewContent');
                
                if (!previewContent) return;
                
                previewContent.innerHTML = this.generateIntegratedPreviewHTML(caseStudyData);
            }

            generateIntegratedPreviewHTML(data) {
                const sections = data.sections || {};
                let html = `<div class="ghibli-preview">`;
                
                // Hero Section
                if (sections.hero && sections.hero.enabled) {
                    html += this.generateHeroPreview(sections.hero);
                }
                
                // Overview Section
                if (sections.overview && sections.overview.enabled) {
                    html += this.generateOverviewPreview(sections.overview);
                }
                
                // Problem Section
                if (sections.problem && sections.problem.enabled) {
                    html += this.generateProblemPreview(sections.problem);
                }
                
                // Process Section
                if (sections.process && sections.process.enabled) {
                    html += this.generateProcessPreview(sections.process);
                }
                
                // Showcase Section
                if (sections.showcase && sections.showcase.enabled) {
                    html += this.generateShowcasePreview(sections.showcase);
                }
                
                // Reflection Section
                if (sections.reflection && sections.reflection.enabled) {
                    html += this.generateReflectionPreview(sections.reflection);
                }
                
                // Gallery Section
                if (sections.gallery && sections.gallery.enabled) {
                    html += this.generateGalleryPreview(sections.gallery);
                }
                
                // Video Section
                if (sections.video && sections.video.enabled) {
                    html += this.generateVideoPreview(sections.video);
                }
                
                // Resources Section
                if (sections.resources && sections.resources.enabled) {
                    html += this.generateResourcesPreview(sections.resources);
                }
                
                // Empty state
                if (!html || html === `<div class="ghibli-preview">`) {
                    html = `
                        <div class="ghibli-preview">
                            <div class="page-section cloud-bg flex items-center justify-center">
                                <div class="text-center slide-in">
                                    <i class="fas fa-magic text-6xl mb-4" style="color: #6bb2e2;"></i>
                                    <h3 class="text-2xl font-bold mb-4 ghibli-font ghibli-text-blue">Start Creating Your Magical Case Study</h3>
                                    <p class="text-gray-600 handwriting">Fill in the form fields and enable sections to see your content appear here in real-time.</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `</div>`; // Close ghibli-preview wrapper
                }
                
                return html;
            }

            // Legacy preview method for backward compatibility - redirect to integrated preview
            async previewCaseStudy() {
                this.toggleIntegratedPreview();
            }

            storePendingImagesForPreview() {
                // Store a lightweight reference to pending images
                const pendingImageInfo = {};
                
                if (this.pendingImages) {
                    // Store file info without the actual file data
                    Object.keys(this.pendingImages).forEach(section => {
                        if (this.pendingImages[section]) {
                            if (Array.isArray(this.pendingImages[section])) {
                                pendingImageInfo[section] = this.pendingImages[section].map(img => ({
                                    imageId: img.imageId,
                                    fileName: img.file ? img.file.name : 'unknown',
                                    fileSize: img.file ? img.file.size : 0,
                                    fileType: img.file ? img.file.type : 'unknown'
                                }));
                            } else {
                                pendingImageInfo[section] = {
                                    fileName: this.pendingImages[section].file ? this.pendingImages[section].file.name : 'unknown',
                                    fileSize: this.pendingImages[section].file ? this.pendingImages[section].file.size : 0,
                                    fileType: this.pendingImages[section].file ? this.pendingImages[section].file.type : 'unknown'
                                };
                            }
                        }
                    });
                }
                
                localStorage.setItem('pendingImageInfo', JSON.stringify(pendingImageInfo));
                console.log('ðŸ’¾ Stored pending image info:', pendingImageInfo);
            }



            // Validation
            validateForm() {
                let isValid = true;
                
                // Clear previous errors
                document.querySelectorAll('.field-error').forEach(field => {
                    field.classList.remove('field-error');
                });
                
                // Validate required fields
                Object.keys(this.validationRules).forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const rules = this.validationRules[fieldId];
                    
                    if (field && rules.required && !field.value.trim()) {
                        this.showFieldError(field, 'This field is required');
                        isValid = false;
                    } else if (field && rules.minLength && field.value.length < rules.minLength) {
                        this.showFieldError(field, `Minimum ${rules.minLength} characters required`);
                        isValid = false;
                    }
                });
                
                return isValid;
            }

            validateField(field) {
                const fieldId = field.id;
                const rules = this.validationRules[fieldId];
                
                if (!rules) return true;
                
                // Clear previous error
                field.parentElement.classList.remove('field-error');
                
                if (rules.required && !field.value.trim()) {
                    this.showFieldError(field, 'This field is required');
                    return false;
                } else if (rules.minLength && field.value.length < rules.minLength) {
                    this.showFieldError(field, `Minimum ${rules.minLength} characters required`);
                    return false;
                }
                
                return true;
            }

            showFieldError(field, message) {
                field.parentElement.classList.add('field-error');
                const errorElement = field.parentElement.querySelector('.error-message');
                if (errorElement) {
                    errorElement.textContent = message;
                }
            }

            // Auto-save
            setupAutoSave() {
                this.autoSaveInterval = setInterval(() => {
                    if (this.isDirty && this.currentCaseStudy) {
                        console.log('ðŸ’¾ Auto-saving...');
                        this.saveCaseStudy(true);
                    }
                }, 30000); // Every 30 seconds
            }

            // Utility methods
            markDirty() {
                this.isDirty = true;
                this.updateSaveStatus('Unsaved changes');
                this.updatePendingImagesIndicator();
            }
            
            updatePendingImagesIndicator() {
                const count = this.countPendingImages();
                const indicator = document.getElementById('pendingImagesIndicator');
                const countSpan = document.getElementById('pendingImagesCount');
                
                if (indicator && countSpan) {
                    countSpan.textContent = count;
                    if (count > 0) {
                        indicator.classList.remove('hidden');
                    } else {
                        indicator.classList.add('hidden');
                    }
                }
            }

            updateSaveStatus(status) {
                const statusElement = document.getElementById('saveStatus');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }

            showLoading(message = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    const text = overlay.querySelector('p');
                    if (text) text.textContent = message;
                    overlay.classList.add('show');
                }
            }

            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
            }

            showNotification(type, title, message) {
                const container = document.getElementById('notificationContainer');
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm">${message}</p>
                        </div>
                        <button class="ml-auto text-white hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }, 5000);
            }

            // Utility function to escape HTML
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Generate responsive image preview with fast loading
            generateImagePreview(imageUrl, altText, section, aspectRatio = 'auto') {
                // Use the fast image preview system
                if (window.fastImagePreview) {
                    // Set up reference for pending images
                    window.caseStudyEditor = this;
                    
                    return window.fastImagePreview.generateImagePreview(imageUrl, altText, section, {
                        aspectRatio: aspectRatio === '16:9' ? 'auto' : aspectRatio, // Convert default to auto
                        className: 'shadow-sm hover:shadow-md transition-shadow',
                        showControls: true
                    });
                }
                
                // Fallback to original implementation
                return this.generateImagePreviewFallback(imageUrl, altText, section, aspectRatio);
            }

            // Fallback image preview implementation
            generateImagePreviewFallback(imageUrl, altText, section, aspectRatio = '16:9') {
                // Handle pending upload URLs
                if (imageUrl && imageUrl.startsWith('pending-upload-')) {
                    console.log('ðŸ” Debug: Handling pending upload URL:', imageUrl, 'for section:', section);
                    
                    // Try to get the actual image data from pending images
                    const pendingImage = this.pendingImages && this.pendingImages[section];
                    
                    if (pendingImage) {
                        // Handle single image (hero, problem)
                        if (pendingImage.file) {
                            console.log('âœ… Debug: Creating object URL for single image');
                            const objectUrl = URL.createObjectURL(pendingImage.file);
                            return this.createImageHTML(objectUrl, altText, aspectRatio, true);
                        }
                        // Handle array of images (showcase, gallery)
                        else if (Array.isArray(pendingImage) && pendingImage.length > 0) {
                            console.log('âœ… Debug: Creating object URL for array image');
                            // For arrays, try to match by imageId or use first image
                            const imageId = imageUrl.split('-').pop();
                            const matchingImage = pendingImage.find(img => img.imageId && img.imageId.includes(imageId)) || pendingImage[0];
                            if (matchingImage && matchingImage.file) {
                                const objectUrl = URL.createObjectURL(matchingImage.file);
                                return this.createImageHTML(objectUrl, altText, aspectRatio, true);
                            }
                        }
                    }
                    
                    // Show placeholder for pending upload
                    return this.createImagePlaceholder(altText, aspectRatio, 'Image selected - will upload on save');
                }
                
                // Handle regular URLs
                if (imageUrl && !imageUrl.startsWith('pending-upload-')) {
                    return this.createImageHTML(imageUrl, altText, aspectRatio, false);
                }
                
                return '';
            }

            createImageHTML(src, alt, aspectRatio, isPending) {
                const aspectClasses = {
                    '16:9': 'aspect-video',
                    '4:3': 'aspect-[4/3]',
                    '1:1': 'aspect-square',
                    '3:2': 'aspect-[3/2]',
                    'auto': '' // No fixed aspect ratio
                };
                
                const aspectClass = aspectClasses[aspectRatio] || '';
                const previewId = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // Determine container and image classes based on aspect ratio
                let containerClass, imageClass;
                
                if (aspectRatio === 'auto' || !aspectClass) {
                    // Auto aspect ratio - flexible container
                    containerClass = 'relative w-full mb-3 rounded-lg overflow-hidden bg-gray-100 group shadow-sm hover:shadow-md transition-all duration-300 min-h-[150px] max-h-[600px]';
                    imageClass = 'w-full h-auto max-h-[600px] object-contain transition-all duration-500 group-hover:scale-105 opacity-0';
                } else {
                    // Fixed aspect ratio
                    containerClass = `relative ${aspectClass} w-full mb-3 rounded-lg overflow-hidden bg-gray-100 group shadow-sm hover:shadow-md transition-all duration-300`;
                    imageClass = 'absolute inset-0 w-full h-full object-cover transition-all duration-500 group-hover:scale-105 opacity-0';
                }
                
                // Enhanced image HTML with better error handling and loading states
                const pendingIndicator = isPending ? `
                    <div class="absolute top-2 right-2 bg-yellow-500 text-white px-2 py-1 rounded text-xs font-medium z-10">
                        <i class="fas fa-clock mr-1"></i>Pending
                    </div>
                ` : '';

                const loadingOverlay = `
                    <div class="absolute inset-0 bg-gray-200 flex items-center justify-center loading-overlay transition-opacity duration-300">
                        <div class="text-center text-gray-500">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mx-auto mb-2"></div>
                            <p class="text-xs">Loading...</p>
                        </div>
                    </div>
                `;

                const imageControls = `
                    <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex space-x-1 z-10">
                        <button onclick="window.advancedImagePreview?.zoomImage('${previewId}')" 
                                class="bg-black bg-opacity-50 text-white p-1 rounded hover:bg-opacity-75 transition-all">
                            <i class="fas fa-search-plus text-xs"></i>
                        </button>
                    </div>
                `;
                
                return `
                    <div id="${previewId}" class="${containerClass}">
                        ${loadingOverlay}
                        <img 
                            src="${this.escapeHtml(src)}" 
                            alt="${this.escapeHtml(alt)}" 
                            class="${imageClass}"
                            onload="
                                this.style.opacity='1'; 
                                this.parentElement.querySelector('.loading-overlay')?.remove();
                                ${aspectRatio === 'auto' ? 'window.fastImagePreview?.adjustContainerHeight(this);' : ''}
                                console.log('âœ… Image loaded successfully:', this.src);
                            "
                            onerror="
                                console.error('âŒ Failed to load image:', this.src);
                                this.parentElement.innerHTML='${this.createImagePlaceholder(alt, aspectRatio, 'Failed to load image').replace(/'/g, '\\\'').replace(/"/g, '\\"')}';
                            "
                            loading="lazy"
                            decoding="async"
                        >
                        ${pendingIndicator}
                        ${imageControls}
                    </div>
                `;
            }

            createImagePlaceholder(alt, aspectRatio, message = 'No image') {
                const aspectClasses = {
                    '16:9': 'aspect-video',
                    '4:3': 'aspect-[4/3]',
                    '1:1': 'aspect-square',
                    '3:2': 'aspect-[3/2]'
                };
                
                const aspectClass = aspectClasses[aspectRatio] || 'aspect-video';
                
                return `
                    <div class="${aspectClass} w-full mb-3 rounded-lg bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-image text-2xl mb-2"></i>
                            <p class="text-sm font-medium">${message}</p>
                            <p class="text-xs">${this.escapeHtml(alt)}</p>
                        </div>
                    </div>
                `;
            }

            // Generate YouTube/video embed with proper aspect ratio
            generateVideoEmbed(url) {
                if (!url) return '';
                
                // Extract YouTube video ID
                const youtubeMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/);
                
                if (youtubeMatch) {
                    const videoId = youtubeMatch[1];
                    return `
                        <div class="relative aspect-video w-full mb-3 rounded-lg overflow-hidden bg-gray-900">
                            <iframe 
                                src="https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1" 
                                class="absolute inset-0 w-full h-full"
                                frameborder="0" 
                                allowfullscreen
                                title="YouTube video player"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            ></iframe>
                        </div>
                    `;
                }
                
                // Handle Vimeo URLs
                const vimeoMatch = url.match(/vimeo\.com\/(\d+)/);
                if (vimeoMatch) {
                    const videoId = vimeoMatch[1];
                    return `
                        <div class="relative aspect-video w-full mb-3 rounded-lg overflow-hidden bg-gray-900">
                            <iframe 
                                src="https://player.vimeo.com/video/${videoId}" 
                                class="absolute inset-0 w-full h-full"
                                frameborder="0" 
                                allowfullscreen
                                title="Vimeo video player"
                            ></iframe>
                        </div>
                    `;
                }
                
                // Handle direct video URLs
                if (url.match(/\.(mp4|webm|ogg)$/i)) {
                    return `
                        <div class="relative aspect-video w-full mb-3 rounded-lg overflow-hidden bg-gray-900">
                            <video 
                                controls 
                                class="absolute inset-0 w-full h-full object-cover"
                                preload="metadata"
                            >
                                <source src="${this.escapeHtml(url)}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                }
                
                // Fallback for other URLs
                return `
                    <div class="relative aspect-video w-full mb-3 rounded-lg overflow-hidden bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center">
                        <div class="text-center text-gray-600">
                            <i class="fas fa-video text-3xl mb-2"></i>
                            <p class="text-sm font-medium mb-2">Video Preview</p>
                            <a href="${this.escapeHtml(url)}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                ${this.escapeHtml(url)}
                            </a>
                        </div>
                    </div>
                `;
            }

            // URL validation utilities for iframe embedding
            isFigmaEmbedUrl(url) {
                // Check if URL is a Figma URL that can be embedded
                return url && (
                    url.includes('figma.com/embed') || 
                    url.includes('figma.com/proto/') ||
                    url.includes('figma.com/file/') ||
                    url.includes('figma.com/design/') ||
                    url.includes('figma.com/')
                );
            }

            isMiroEmbedUrl(url) {
                // Check if URL is a Miro live-embed URL or can be converted to one
                return url && (
                    url.includes('miro.com/app/live-embed/') ||
                    url.includes('miro.com/app/board/')
                );
            }

            convertToFigmaEmbedUrl(url) {
                // Convert regular Figma URLs to embed URLs with proper format
                if (!url) return url;
                
                // If already an embed URL, return as is
                if (url.includes('figma.com/embed')) {
                    return url;
                }
                
                // Convert file URLs to embed URLs
                if (url.includes('figma.com/file/')) {
                    const encodedUrl = encodeURIComponent(url);
                    return `https://www.figma.com/embed?embed_host=yourapp&url=${encodedUrl}`;
                }
                
                // Convert prototype URLs to embed URLs
                if (url.includes('figma.com/proto/')) {
                    const encodedUrl = encodeURIComponent(url);
                    return `https://www.figma.com/embed?embed_host=yourapp&url=${encodedUrl}`;
                }
                
                // Convert design URLs to embed URLs
                if (url.includes('figma.com/design/')) {
                    const encodedUrl = encodeURIComponent(url);
                    return `https://www.figma.com/embed?embed_host=yourapp&url=${encodedUrl}`;
                }
                
                // If it's already a figma.com URL but not recognized, try to embed it
                if (url.includes('figma.com/')) {
                    const encodedUrl = encodeURIComponent(url);
                    return `https://www.figma.com/embed?embed_host=yourapp&url=${encodedUrl}`;
                }
                
                return url;
            }

            convertToMiroEmbedUrl(url) {
                // Convert regular Miro URLs to live-embed URLs if possible
                if (!url) return url;
                
                // If already a live-embed URL, return as is
                if (url.includes('miro.com/app/live-embed/')) {
                    return url;
                }
                
                // Convert board URLs to live-embed URLs
                if (url.includes('miro.com/app/board/')) {
                    const boardId = url.match(/\/board\/([^\/\?]+)/);
                    if (boardId) {
                        return `https://miro.com/app/live-embed/${boardId[1]}/?autoplay=true`;
                    }
                }
                
                return url;
            }

            // HTML escaping utility (if not already defined)
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Cleanup
            destroy() {
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                }
                if (this.previewUpdateTimeout) {
                    clearTimeout(this.previewUpdateTimeout);
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.editor = new CompleteCaseStudyEditor();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.editor) {
                window.editor.destroy();
            }
        });
    </script>
</body>
</html>