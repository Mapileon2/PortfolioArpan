<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Case Study Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-4xl font-bold mb-8 text-center text-blue-600">ğŸ§ª Case Study Integration Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Test Actions -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">ğŸ”§ Test Actions</h2>
                <div class="space-y-3">
                    <button onclick="testCaseStudySync()" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        ğŸ”„ Test Case Study Sync
                    </button>
                    <button onclick="createTestCaseStudy()" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        ğŸ“ Create Test Case Study
                    </button>
                    <button onclick="checkHomepageProjects()" class="w-full bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        ğŸ  Check Homepage Projects
                    </button>
                    <button onclick="clearTestData()" class="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                        ğŸ—‘ï¸ Clear Test Data
                    </button>
                </div>
            </div>

            <!-- Current Status -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold mb-4">ğŸ“Š Current Status</h2>
                <div id="statusInfo" class="space-y-2">
                    <div class="text-gray-600">Loading status...</div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-semibold mb-4">ğŸ“‹ Test Results</h2>
            <div id="testResults" class="space-y-3">
                <div class="text-gray-600">Run tests to see results...</div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold mb-4">ğŸ”— Quick Navigation</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <a href="index.html" target="_blank" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-center block">
                    ğŸ  Homepage
                </a>
                <a href="admin-dashboard.html#case-studies" target="_blank" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 text-center block">
                    ğŸ“Š Admin Dashboard
                </a>
                <a href="case_study_editor_complete.html" target="_blank" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-center block">
                    ğŸ“ Case Study Editor
                </a>
                <a href="case_study_display.html" target="_blank" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 text-center block">
                    ğŸ‘ï¸ Case Study Display
                </a>
            </div>
        </div>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const colors = {
                success: 'text-green-600 bg-green-50 border-green-200',
                error: 'text-red-600 bg-red-50 border-red-200',
                warning: 'text-yellow-600 bg-yellow-50 border-yellow-200',
                info: 'text-blue-600 bg-blue-50 border-blue-200'
            };
            
            const result = document.createElement('div');
            result.className = `p-3 border rounded ${colors[type]}`;
            result.innerHTML = `
                <div class="flex items-start">
                    <span class="font-semibold mr-2">[${new Date().toLocaleTimeString()}]</span>
                    <span>${message}</span>
                </div>
            `;
            resultsDiv.appendChild(result);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateStatus() {
            const statusDiv = document.getElementById('statusInfo');
            
            // Check localStorage data
            const caseStudyData = localStorage.getItem('homepageCaseStudyData');
            const lastSync = localStorage.getItem('caseStudyLastSync');
            
            let statusHtml = '';
            
            if (caseStudyData) {
                try {
                    const data = JSON.parse(caseStudyData);
                    statusHtml += `<div class="text-green-600">âœ… Case Study Data: ${data.length} items</div>`;
                    statusHtml += `<div class="text-blue-600">ğŸ•’ Last Sync: ${lastSync ? new Date(lastSync).toLocaleString() : 'Unknown'}</div>`;
                } catch (error) {
                    statusHtml += `<div class="text-red-600">âŒ Invalid case study data in localStorage</div>`;
                }
            } else {
                statusHtml += `<div class="text-red-600">âŒ No case study data found</div>`;
            }
            
            // Check if sync script is available
            if (typeof window.CaseStudyHomepageSync !== 'undefined') {
                statusHtml += `<div class="text-green-600">âœ… Case Study Sync Available</div>`;
            } else {
                statusHtml += `<div class="text-yellow-600">âš ï¸ Case Study Sync Not Loaded</div>`;
            }
            
            statusDiv.innerHTML = statusHtml;
        }

        async function testCaseStudySync() {
            addResult('ğŸ§ª Starting case study sync test...', 'info');
            
            try {
                // Test API connection
                addResult('ğŸ“¡ Testing API connection...', 'info');
                const response = await fetch('/api/case-studies');
                
                if (response.ok) {
                    const caseStudies = await response.json();
                    addResult(`âœ… API connection successful - found ${caseStudies.length} case studies`, 'success');
                    
                    // Test sync functionality
                    if (window.CaseStudyHomepageSync) {
                        addResult('ğŸ”„ Triggering sync...', 'info');
                        window.CaseStudyHomepageSync.triggerSync();
                        addResult('âœ… Sync triggered successfully', 'success');
                    } else {
                        addResult('âŒ Sync class not available', 'error');
                    }
                    
                    // Check localStorage after sync
                    setTimeout(() => {
                        const syncedData = localStorage.getItem('homepageCaseStudyData');
                        if (syncedData) {
                            const data = JSON.parse(syncedData);
                            addResult(`âœ… Sync successful - ${data.length} items in localStorage`, 'success');
                        } else {
                            addResult('âŒ Sync failed - no data in localStorage', 'error');
                        }
                        updateStatus();
                    }, 1000);
                    
                } else {
                    addResult(`âŒ API connection failed - ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Test failed: ${error.message}`, 'error');
            }
        }

        async function createTestCaseStudy() {
            addResult('ğŸ“ Creating test case study...', 'info');
            
            const testCaseStudy = {
                project_title: 'Test Project ' + Date.now(),
                project_description: 'This is a test case study created for integration testing',
                project_image_url: 'https://images.unsplash.com/photo-1551650975-87deedd944c3?w=400&h=300&fit=crop',
                project_category: 'Test',
                project_rating: 5,
                project_achievement: 'Successfully created via integration test',
                status: 'published',
                sections: {
                    hero: {
                        headline: 'Test Project ' + Date.now(),
                        description: 'This is a test case study created for integration testing',
                        image: 'https://images.unsplash.com/photo-1551650975-87deedd944c3?w=400&h=300&fit=crop'
                    },
                    overview: {
                        content: 'This case study was created to test the integration between the admin dashboard and homepage projects section.'
                    }
                }
            };

            try {
                const response = await fetch('/api/case-studies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testCaseStudy)
                });

                if (response.ok) {
                    const result = await response.json();
                    addResult(`âœ… Test case study created with ID: ${result.id}`, 'success');
                    
                    // Trigger sync
                    if (window.CaseStudyHomepageSync) {
                        window.CaseStudyHomepageSync.triggerSync();
                        addResult('ğŸ”„ Homepage sync triggered', 'success');
                    }
                    
                    addResult('ğŸ  Check the homepage projects section to see the new case study', 'info');
                } else {
                    const error = await response.text();
                    addResult(`âŒ Failed to create test case study: ${error}`, 'error');
                }
            } catch (error) {
                addResult(`âŒ Error creating test case study: ${error.message}`, 'error');
            }
        }

        async function checkHomepageProjects() {
            addResult('ğŸ  Checking homepage projects...', 'info');
            
            try {
                // Check localStorage data
                const caseStudyData = localStorage.getItem('homepageCaseStudyData');
                if (caseStudyData) {
                    const data = JSON.parse(caseStudyData);
                    addResult(`ğŸ“¦ Found ${data.length} case studies in localStorage`, 'success');
                    
                    data.forEach((cs, index) => {
                        addResult(`ğŸ“„ ${index + 1}. "${cs.projectTitle}" - ${cs.projectCategory}`, 'info');
                    });
                } else {
                    addResult('âŒ No case study data in localStorage', 'error');
                }
                
                // Check if homepage DOM elements exist
                const homepage = window.open('index.html', 'homepage-check');
                setTimeout(() => {
                    if (homepage && homepage.document) {
                        const projectsGrid = homepage.document.getElementById('projectsGrid');
                        if (projectsGrid) {
                            const projectCards = projectsGrid.children.length;
                            addResult(`ğŸ¯ Homepage has ${projectCards} project cards displayed`, 'success');
                        } else {
                            addResult('âŒ Homepage projects grid not found', 'error');
                        }
                        homepage.close();
                    }
                }, 2000);
                
            } catch (error) {
                addResult(`âŒ Error checking homepage: ${error.message}`, 'error');
            }
        }

        function clearTestData() {
            addResult('ğŸ—‘ï¸ Clearing test data...', 'info');
            
            localStorage.removeItem('homepageCaseStudyData');
            localStorage.removeItem('caseStudyLastSync');
            
            addResult('âœ… Test data cleared from localStorage', 'success');
            addResult('ğŸ  Homepage will now show empty or default projects', 'info');
            
            updateStatus();
        }

        // Auto-update status on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            
            // Listen for case study updates
            window.addEventListener('caseStudyDataUpdated', function(event) {
                addResult(`ğŸ“¡ Received case study update event with ${event.detail.caseStudies.length} items`, 'success');
                updateStatus();
            });
            
            // Listen for homepage project updates
            window.addEventListener('homepageProjectsUpdated', function(event) {
                addResult(`ğŸ  Homepage projects updated with ${event.detail.caseStudies.length} items`, 'success');
            });
        });
    </script>
    <script src="fix-case-study-homepage-sync.js"></script>
</body>
</html>