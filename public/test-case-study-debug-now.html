<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Study Debug - Immediate Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h1 class="text-2xl font-bold mb-4">ğŸ” Case Study Debug - Immediate Test</h1>
            <p class="text-gray-600 mb-4">Testing case study sync between editor and admin dashboard</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button onclick="testLocalStorage()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ğŸ“¦ Test localStorage
                </button>
                <button onclick="testAPICall()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    ğŸŒ Test API Call
                </button>
                <button onclick="createTestCaseStudy()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    â• Create Test Case Study
                </button>
                <button onclick="simulateAdminLoad()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    ğŸ  Simulate Admin Load
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š Current Status</h2>
            <div id="statusDisplay" class="space-y-2">
                <p class="text-gray-500">Click a test button to see results...</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ Debug Log</h2>
            <div id="debugLog" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
                <div>Debug session started...</div>
            </div>
        </div>
    </div>

    <!-- Load the sync fix -->
    <script src="fix-case-study-sync.js"></script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400',
                warning: 'text-yellow-400'
            };
            
            const entry = document.createElement('div');
            entry.className = colors[type] || 'text-green-400';
            entry.textContent = `[${timestamp}] ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(data) {
            const statusDiv = document.getElementById('statusDisplay');
            statusDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded">
                        <h3 class="font-semibold text-blue-800 mb-2">localStorage</h3>
                        <p class="text-sm">Case studies: ${data.localStorageCount || 0}</p>
                        <p class="text-sm">Storage size: ${data.storageSize || 0} bytes</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded">
                        <h3 class="font-semibold text-green-800 mb-2">API Status</h3>
                        <p class="text-sm">Fetch override: ${data.fetchOverride ? 'âœ… Active' : 'âŒ Not active'}</p>
                        <p class="text-sm">Last test: ${data.lastTest || 'None'}</p>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-semibold mb-2">Case Studies:</h3>
                    <div class="bg-gray-100 p-4 rounded text-sm max-h-40 overflow-y-auto">
                        ${data.caseStudiesData ? JSON.stringify(data.caseStudiesData, null, 2) : 'No data'}
                    </div>
                </div>
            `;
        }

        function testLocalStorage() {
            log('ğŸ” Testing localStorage...', 'info');
            
            try {
                const storageKey = 'portfolio_case_studies';
                const storedData = localStorage.getItem(storageKey);
                const caseStudies = storedData ? JSON.parse(storedData) : [];
                
                log(`âœ… localStorage test complete:`, 'success');
                log(`   - Key exists: ${!!storedData}`, 'info');
                log(`   - Case studies: ${caseStudies.length}`, 'info');
                log(`   - Storage size: ${storedData ? storedData.length : 0} bytes`, 'info');
                
                if (caseStudies.length > 0) {
                    log(`ğŸ“š Found case studies:`, 'success');
                    caseStudies.forEach((cs, index) => {
                        log(`   ${index + 1}. ${cs.project_title || cs.caseStudyTitle || 'Untitled'} (ID: ${cs.id})`, 'info');
                    });
                } else {
                    log('âš ï¸ No case studies found in localStorage', 'warning');
                }
                
                updateStatus({
                    localStorageCount: caseStudies.length,
                    storageSize: storedData ? storedData.length : 0,
                    fetchOverride: typeof window.fetch !== 'function' || window.fetch.toString().includes('case-studies'),
                    lastTest: 'localStorage',
                    caseStudiesData: caseStudies
                });
                
            } catch (error) {
                log(`âŒ Error testing localStorage: ${error.message}`, 'error');
            }
        }

        async function testAPICall() {
            log('ğŸŒ Testing API call...', 'info');
            
            try {
                log('ğŸ“– Testing GET /api/case-studies...', 'info');
                const response = await fetch('/api/case-studies');
                const data = await response.json();
                
                log(`ğŸ“¨ API response: ${response.status}`, response.ok ? 'success' : 'error');
                log(`ğŸ“Š Data: ${JSON.stringify(data)}`, 'info');
                
                if (data.success && data.data) {
                    log(`ğŸ“š Found ${data.data.length} case studies via API`, 'success');
                    data.data.forEach((cs, index) => {
                        log(`   ${index + 1}. ${cs.project_title || cs.caseStudyTitle || 'Untitled'}`, 'info');
                    });
                } else {
                    log('âš ï¸ API returned no case studies or error', 'warning');
                }
                
                updateStatus({
                    localStorageCount: data.data ? data.data.length : 0,
                    fetchOverride: true,
                    lastTest: 'API',
                    caseStudiesData: data.data || []
                });
                
            } catch (error) {
                log(`âŒ Error testing API: ${error.message}`, 'error');
            }
        }

        async function createTestCaseStudy() {
            log('â• Creating test case study...', 'info');
            
            const testCaseStudy = {
                project_title: `Debug Test Case Study ${Date.now()}`,
                caseStudyTitle: `Debug Test Case Study ${Date.now()}`,
                heroTitle: 'Debug Test Hero Title',
                heroSubtitle: 'This is a debug test case study',
                overviewDescription: 'Debug test overview',
                problemDescription: 'Debug test problem',
                processDescription: 'Debug test process',
                showcaseDescription: 'Debug test showcase',
                reflectionDescription: 'Debug test reflection',
                status: 'published',
                featured: false
            };
            
            try {
                log('ğŸ“¤ Sending POST request...', 'info');
                const response = await fetch('/api/case-studies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testCaseStudy)
                });
                
                const result = await response.json();
                
                log(`ğŸ“¨ POST response: ${response.status}`, response.ok ? 'success' : 'error');
                log(`ğŸ“Š Result: ${JSON.stringify(result)}`, 'info');
                
                if (result.success) {
                    log(`âœ… Test case study created: ${result.data.id}`, 'success');
                    
                    // Check localStorage again
                    setTimeout(() => {
                        log('ğŸ”„ Rechecking localStorage after creation...', 'info');
                        testLocalStorage();
                    }, 500);
                } else {
                    log('âŒ Failed to create test case study', 'error');
                }
                
            } catch (error) {
                log(`âŒ Error creating test case study: ${error.message}`, 'error');
            }
        }

        async function simulateAdminLoad() {
            log('ğŸ  Simulating admin dashboard case study loading...', 'info');
            
            try {
                // Simulate what the admin dashboard does
                log('ğŸ“– Simulating admin dashboard API call...', 'info');
                
                const response = await fetch('/api/case-studies');
                const result = await response.json();
                
                log(`ğŸ“¨ Admin dashboard would receive: ${response.status}`, response.ok ? 'success' : 'error');
                log(`ğŸ“Š Data: ${JSON.stringify(result)}`, 'info');
                
                if (result.success && result.data && result.data.length > 0) {
                    log(`âœ… Admin dashboard would show ${result.data.length} case studies:`, 'success');
                    
                    result.data.forEach((cs, index) => {
                        log(`   ${index + 1}. ${cs.project_title || cs.caseStudyTitle || 'Untitled'} (${cs.status || 'unknown status'})`, 'info');
                    });
                    
                    log('ğŸ¨ Admin dashboard would render case study cards successfully', 'success');
                    
                } else {
                    log('âŒ Admin dashboard would show "No Case Studies Yet"', 'error');
                    log('ğŸ’¡ This is why case studies are not appearing!', 'warning');
                    
                    // Check if localStorage has data but API doesn't
                    const localData = localStorage.getItem('portfolio_case_studies');
                    if (localData) {
                        const localCaseStudies = JSON.parse(localData);
                        if (localCaseStudies.length > 0) {
                            log(`ğŸ”§ Found ${localCaseStudies.length} case studies in localStorage but API returned none`, 'warning');
                            log('ğŸ’¡ The fetch override might not be working properly', 'warning');
                        }
                    }
                }
                
            } catch (error) {
                log(`âŒ Error simulating admin dashboard: ${error.message}`, 'error');
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            log('ğŸš€ Debug tool loaded', 'success');
            log('ğŸ”§ Checking initial state...', 'info');
            
            // Auto-test localStorage on load
            setTimeout(testLocalStorage, 1000);
        });
    </script>
</body>
</html>