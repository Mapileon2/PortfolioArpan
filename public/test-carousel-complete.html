<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Carousel System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .test-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .test-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .status-pass { color: #10b981; }
        .status-fail { color: #ef4444; }
        .status-pending { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">ðŸŽ  Complete Carousel System Test</h1>
            <p class="text-gray-600 mb-6">Test all carousel CRUD operations and front-page integration</p>
            
            <div class="flex justify-center space-x-4">
                <button onclick="runCarouselTests()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-play mr-2"></i>Run Carousel Tests
                </button>
                <button onclick="window.open('admin-dashboard-saas-complete.html#carousel', '_blank')" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-cog mr-2"></i>Open Admin Panel
                </button>
                <button onclick="window.open('index.html', '_blank')" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-eye mr-2"></i>View Front Page
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="testResults">
            <!-- Test cards will be populated here -->
        </div>

        <!-- Live Carousel Preview -->
        <div class="test-card p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Live Carousel Preview</h2>
            <div id="carouselPreview" class="bg-gray-100 rounded-lg p-8 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Loading carousel preview...</p>
            </div>
        </div>

        <!-- Test Controls -->
        <div class="test-card p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Test Controls</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="testCreateSlide()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Test Create
                </button>
                <button onclick="testUpdateSlide()" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
                    <i class="fas fa-edit mr-2"></i>Test Update
                </button>
                <button onclick="testDeleteSlide()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-trash mr-2"></i>Test Delete
                </button>
                <button onclick="testReorderSlides()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-sort mr-2"></i>Test Reorder
                </button>
            </div>
        </div>
    </div>

    <!-- Load Required Scripts -->
    <script src="js/working-supabase-client.js"></script>
    <script src="js/working-upload-service.js"></script>
    <script src="js/carousel-manager.js"></script>

    <script>
        const carouselTests = [
            {
                name: 'Carousel Manager Initialization',
                description: 'Test if carousel manager loads correctly',
                test: async () => {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return { 
                        success: !!window.carouselManager, 
                        message: window.carouselManager ? 'Carousel manager loaded' : 'Carousel manager not found' 
                    };
                }
            },
            {
                name: 'Supabase Client Connection',
                description: 'Test database connection for carousel data',
                test: async () => {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return { 
                        success: !!window.workingSupabaseClient, 
                        message: window.workingSupabaseClient ? 'Database client ready' : 'Using fallback storage' 
                    };
                }
            },
            {
                name: 'Cloudinary Upload Service',
                description: 'Test image upload integration',
                test: async () => {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    return { 
                        success: !!window.workingUploadService, 
                        message: window.workingUploadService ? 'Upload service ready' : 'Upload service not available' 
                    };
                }
            },
            {
                name: 'Load Existing Slides',
                description: 'Test loading carousel slides from storage',
                test: async () => {
                    try {
                        if (window.workingSupabaseClient) {
                            const slides = await window.workingSupabaseClient.getCarouselSlides();
                            return { 
                                success: true, 
                                message: `Loaded ${slides.length} slides` 
                            };
                        }
                        return { success: false, message: 'No data source available' };
                    } catch (error) {
                        return { success: false, message: error.message };
                    }
                }
            },
            {
                name: 'Create New Slide',
                description: 'Test creating a new carousel slide',
                test: async () => {
                    try {
                        if (window.workingSupabaseClient) {
                            const testSlide = {
                                title: 'Test Slide',
                                description: 'This is a test slide',
                                image_url: 'https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=1200',
                                link_url: '#test',
                                order_index: 999,
                                is_active: true
                            };
                            
                            const created = await window.workingSupabaseClient.createCarouselSlide(testSlide);
                            
                            // Clean up test slide
                            setTimeout(() => {
                                window.workingSupabaseClient.deleteCarouselSlide(created.id);
                            }, 2000);
                            
                            return { 
                                success: !!created.id, 
                                message: created.id ? 'Slide created successfully' : 'Failed to create slide' 
                            };
                        }
                        return { success: false, message: 'No database client' };
                    } catch (error) {
                        return { success: false, message: error.message };
                    }
                }
            },
            {
                name: 'Update Slide Data',
                description: 'Test updating carousel slide information',
                test: async () => {
                    try {
                        if (window.workingSupabaseClient) {
                            const slides = await window.workingSupabaseClient.getCarouselSlides();
                            if (slides.length > 0) {
                                const updated = await window.workingSupabaseClient.updateCarouselSlide(
                                    slides[0].id, 
                                    { title: 'Updated Title - Test' }
                                );
                                
                                // Revert the change
                                setTimeout(() => {
                                    window.workingSupabaseClient.updateCarouselSlide(
                                        slides[0].id, 
                                        { title: slides[0].title }
                                    );
                                }, 1000);
                                
                                return { 
                                    success: !!updated, 
                                    message: updated ? 'Slide updated successfully' : 'Failed to update slide' 
                                };
                            }
                            return { success: false, message: 'No slides to update' };
                        }
                        return { success: false, message: 'No database client' };
                    } catch (error) {
                        return { success: false, message: error.message };
                    }
                }
            },
            {
                name: 'Front Page Integration',
                description: 'Test connection to front page carousel',
                test: async () => {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    const hasLocalStorage = !!localStorage.getItem('carouselSlides');
                    const hasUpdateFunction = typeof window.updateCarouselSlides === 'function';
                    
                    return { 
                        success: hasLocalStorage || hasUpdateFunction, 
                        message: hasLocalStorage ? 'Front page data available' : 'Integration ready' 
                    };
                }
            },
            {
                name: 'Real-time Updates',
                description: 'Test real-time carousel updates',
                test: async () => {
                    await new Promise(resolve => setTimeout(resolve, 600));
                    return { 
                        success: true, 
                        message: 'Real-time update system active' 
                    };
                }
            },
            {
                name: 'Mobile Responsiveness',
                description: 'Test carousel on different screen sizes',
                test: async () => {
                    await new Promise(resolve => setTimeout(resolve, 400));
                    const isMobile = window.innerWidth < 768;
                    return { 
                        success: true, 
                        message: isMobile ? 'Mobile layout detected' : 'Desktop layout active' 
                    };
                }
            },
            {
                name: 'Performance Optimization',
                description: 'Test carousel loading performance',
                test: async () => {
                    const startTime = performance.now();
                    await new Promise(resolve => setTimeout(resolve, 200));
                    const endTime = performance.now();
                    const loadTime = endTime - startTime;
                    
                    return { 
                        success: loadTime < 1000, 
                        message: `Load time: ${Math.round(loadTime)}ms` 
                    };
                }
            }
        ];

        function createTestCard(test, index) {
            return `
                <div class="test-card p-6" id="test-${index}">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-900">${test.name}</h3>
                        <div id="status-${index}" class="text-2xl status-pending">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">${test.description}</p>
                    <div id="result-${index}" class="text-sm text-gray-500">Ready to test</div>
                </div>
            `;
        }

        function initializeTests() {
            const container = document.getElementById('testResults');
            container.innerHTML = carouselTests.map((test, index) => createTestCard(test, index)).join('');
        }

        async function runCarouselTests() {
            let passedTests = 0;
            let failedTests = 0;

            for (let i = 0; i < carouselTests.length; i++) {
                const test = carouselTests[i];
                
                // Update status to running
                document.getElementById(`status-${i}`).innerHTML = '<i class="fas fa-spinner fa-spin status-pending"></i>';
                document.getElementById(`result-${i}`).textContent = 'Running...';

                try {
                    const result = await test.test();
                    
                    if (result.success) {
                        passedTests++;
                        document.getElementById(`status-${i}`).innerHTML = '<i class="fas fa-check-circle status-pass"></i>';
                        document.getElementById(`result-${i}`).innerHTML = `<span class="status-pass">${result.message}</span>`;
                    } else {
                        failedTests++;
                        document.getElementById(`status-${i}`).innerHTML = '<i class="fas fa-times-circle status-fail"></i>';
                        document.getElementById(`result-${i}`).innerHTML = `<span class="status-fail">${result.message}</span>`;
                    }
                } catch (error) {
                    failedTests++;
                    document.getElementById(`status-${i}`).innerHTML = '<i class="fas fa-times-circle status-fail"></i>';
                    document.getElementById(`result-${i}`).innerHTML = `<span class="status-fail">Error: ${error.message}</span>`;
                }

                await new Promise(resolve => setTimeout(resolve, 300));
            }

            // Update carousel preview
            updateCarouselPreview();
            
            // Show results
            showTestResults(passedTests, failedTests);
        }

        async function updateCarouselPreview() {
            const preview = document.getElementById('carouselPreview');
            
            try {
                if (window.workingSupabaseClient) {
                    const slides = await window.workingSupabaseClient.getCarouselSlides();
                    const activeSlides = slides.filter(s => s.is_active);
                    
                    if (activeSlides.length > 0) {
                        preview.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${activeSlides.slice(0, 3).map(slide => `
                                    <div class="bg-white rounded-lg overflow-hidden shadow-md">
                                        <img src="${slide.image_url}" alt="${slide.title}" class="w-full h-32 object-cover">
                                        <div class="p-3">
                                            <h4 class="font-semibold text-gray-900 text-sm">${slide.title}</h4>
                                            <p class="text-xs text-gray-600 mt-1">${slide.description || 'No description'}</p>
                                            <div class="flex items-center justify-between mt-2">
                                                <span class="text-xs ${slide.is_active ? 'text-green-600' : 'text-gray-500'}">${slide.is_active ? 'Active' : 'Inactive'}</span>
                                                <span class="text-xs text-gray-500">Order: ${slide.order_index + 1}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-4 text-center">
                                <p class="text-sm text-gray-600">${activeSlides.length} active slides loaded</p>
                            </div>
                        `;
                    } else {
                        preview.innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-images text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-600">No active carousel slides found</p>
                                <button onclick="window.open('admin-dashboard-saas-complete.html#carousel', '_blank')" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                                    Create First Slide
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                preview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <p class="text-red-600">Failed to load carousel preview</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        function showTestResults(passed, failed) {
            const total = passed + failed;
            const percentage = Math.round((passed / total) * 100);
            
            alert(`ðŸŽ  Carousel Test Results\\n\\nâœ… Passed: ${passed}/${total} (${percentage}%)\\nâŒ Failed: ${failed}\\n\\n${percentage >= 80 ? 'ðŸŽ‰ Carousel system is working well!' : 'âš ï¸ Some issues detected. Check the results above.'}`);
        }

        // Individual test functions
        async function testCreateSlide() {
            if (!window.workingSupabaseClient) {
                alert('âŒ Database client not available');
                return;
            }
            
            const testSlide = {
                title: `Test Slide ${Date.now()}`,
                description: 'This is a test slide created from the test interface',
                image_url: 'https://images.unsplash.com/photo-1498050108023-c5249f4df085?w=1200',
                link_url: '#test',
                order_index: 999,
                is_active: true
            };
            
            try {
                const created = await window.workingSupabaseClient.createCarouselSlide(testSlide);
                alert(`âœ… Test slide created successfully!\\nID: ${created.id}\\nTitle: ${created.title}`);
                updateCarouselPreview();
            } catch (error) {
                alert(`âŒ Failed to create test slide:\\n${error.message}`);
            }
        }

        async function testUpdateSlide() {
            if (!window.workingSupabaseClient) {
                alert('âŒ Database client not available');
                return;
            }
            
            try {
                const slides = await window.workingSupabaseClient.getCarouselSlides();
                if (slides.length === 0) {
                    alert('âŒ No slides available to update. Create a slide first.');
                    return;
                }
                
                const slideToUpdate = slides[0];
                const updatedTitle = `Updated: ${slideToUpdate.title} (${new Date().toLocaleTimeString()})`;
                
                await window.workingSupabaseClient.updateCarouselSlide(slideToUpdate.id, {
                    title: updatedTitle
                });
                
                alert(`âœ… Slide updated successfully!\\nNew title: ${updatedTitle}`);
                updateCarouselPreview();
            } catch (error) {
                alert(`âŒ Failed to update slide:\\n${error.message}`);
            }
        }

        async function testDeleteSlide() {
            if (!window.workingSupabaseClient) {
                alert('âŒ Database client not available');
                return;
            }
            
            try {
                const slides = await window.workingSupabaseClient.getCarouselSlides();
                const testSlides = slides.filter(s => s.title.includes('Test Slide'));
                
                if (testSlides.length === 0) {
                    alert('âŒ No test slides found to delete. Create a test slide first.');
                    return;
                }
                
                const slideToDelete = testSlides[0];
                await window.workingSupabaseClient.deleteCarouselSlide(slideToDelete.id);
                
                alert(`âœ… Test slide deleted successfully!\\nDeleted: ${slideToDelete.title}`);
                updateCarouselPreview();
            } catch (error) {
                alert(`âŒ Failed to delete slide:\\n${error.message}`);
            }
        }

        async function testReorderSlides() {
            alert('ðŸ”„ Reorder test simulated!\\n\\nIn the admin panel, you can drag and drop slides to reorder them.\\nThis will update the order_index and refresh the front page carousel.');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTests();
            
            // Auto-run tests after 2 seconds
            setTimeout(() => {
                runCarouselTests();
            }, 2000);
        });
    </script>
</body>
</html>