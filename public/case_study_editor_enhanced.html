<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Case Study Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Cloudinary SDK -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    
    <!-- Rich Text Editor -->
    <script src="https://cdn.ckeditor.com/ckeditor5/35.0.1/classic/ckeditor.js"></script>
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .section-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .upload-zone {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .upload-zone:hover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .upload-zone.dragover {
            border-color: #3182ce;
            background-color: #bee3f8;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="glass-effect sticky top-0 z-50 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">
                <i class="fas fa-edit mr-2"></i>Case Study Editor
            </h1>
            <div class="flex space-x-4">
                <button id="saveBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-save mr-2"></i>Save
                </button>
                <button id="previewBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-eye mr-2"></i>Preview
                </button>
                <a href="/admin-dashboard.html" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        <!-- Case Study Selection -->
        <div class="glass-effect rounded-xl p-6 mb-6">
            <h2 class="text-xl font-bold text-white mb-4">Case Study Selection</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-white mb-2">Select Existing Case Study</label>
                    <select id="caseStudySelect" class="w-full px-4 py-2 rounded-lg bg-white/20 text-white border border-white/30">
                        <option value="">Create New Case Study</option>
                    </select>
                </div>
                <div>
                    <label class="block text-white mb-2">Case Study Title</label>
                    <input type="text" id="caseStudyTitle" placeholder="Enter case study title" 
                           class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                </div>
            </div>
        </div>  
      <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column - Form Sections -->
            <div class="space-y-6">
                
                <!-- Hero Section -->
                <div class="section-card glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-star text-yellow-400 mr-2"></i>Hero Section
                        </h3>
                        <label class="flex items-center">
                            <input type="checkbox" id="heroEnabled" checked class="mr-2">
                            <span class="text-white text-sm">Enable</span>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white mb-2">Hero Title</label>
                            <input type="text" id="heroTitle" placeholder="Main project title" 
                                   class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Subtitle</label>
                            <input type="text" id="heroSubtitle" placeholder="Brief description" 
                                   class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Hero Image</label>
                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer" onclick="uploadHeroImage()">
                                <div id="heroImagePreview" class="hidden">
                                    <img id="heroImageImg" class="w-full h-32 object-cover rounded-lg mb-2">
                                    <button type="button" onclick="removeHeroImage()" class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-trash mr-1"></i>Remove
                                    </button>
                                </div>
                                <div id="heroImageUpload" class="text-white/70">
                                    <i class="fas fa-cloud-upload-alt text-3xl mb-2"></i>
                                    <p>Click to upload hero image</p>
                                    <p class="text-sm">Recommended: 1200x600px</p>
                                </div>
                            </div>
                            <input type="hidden" id="heroImageUrl">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Introduction Text</label>
                            <textarea id="heroDescription" rows="3" placeholder="Brief project introduction..." 
                                      class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Overview Section -->
                <div class="section-card glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-info-circle text-blue-400 mr-2"></i>Overview
                        </h3>
                        <label class="flex items-center">
                            <input type="checkbox" id="overviewEnabled" checked class="mr-2">
                            <span class="text-white text-sm">Enable</span>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white mb-2">Overview Title</label>
                            <input type="text" id="overviewTitle" placeholder="Project Overview" 
                                   class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Summary</label>
                            <textarea id="overviewSummary" rows="4" placeholder="Project summary and key points..." 
                                      class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Key Metrics</label>
                            <div id="metricsContainer" class="space-y-2">
                                <div class="flex space-x-2">
                                    <input type="text" placeholder="Metric name" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                                    <input type="text" placeholder="Value" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                                    <button type="button" onclick="removeMetric(this)" class="text-red-400 hover:text-red-300 px-2">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" onclick="addMetric()" class="mt-2 text-blue-400 hover:text-blue-300">
                                <i class="fas fa-plus mr-1"></i>Add Metric
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Problem Section -->
                <div class="section-card glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-exclamation-triangle text-red-400 mr-2"></i>Problem Statement
                        </h3>
                        <label class="flex items-center">
                            <input type="checkbox" id="problemEnabled" checked class="mr-2">
                            <span class="text-white text-sm">Enable</span>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white mb-2">Problem Title</label>
                            <input type="text" id="problemTitle" placeholder="The Challenge" 
                                   class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Problem Description</label>
                            <textarea id="problemDescription" rows="4" placeholder="Describe the problem you're solving..." 
                                      class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Supporting Image</label>
                            <div class="upload-zone rounded-lg p-4 text-center cursor-pointer" onclick="uploadProblemImage()">
                                <div id="problemImagePreview" class="hidden">
                                    <img id="problemImageImg" class="w-full h-32 object-cover rounded-lg mb-2">
                                    <button type="button" onclick="removeProblemImage()" class="text-red-400 hover:text-red-300">
                                        <i class="fas fa-trash mr-1"></i>Remove
                                    </button>
                                </div>
                                <div id="problemImageUpload" class="text-white/70">
                                    <i class="fas fa-image text-2xl mb-2"></i>
                                    <p>Upload supporting image</p>
                                </div>
                            </div>
                            <input type="hidden" id="problemImageUrl">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column - Preview and Additional Sections -->
            <div class="space-y-6">
                
                <!-- Live Preview -->
                <div class="glass-effect rounded-xl p-6">
                    <h3 class="text-lg font-bold text-white mb-4">
                        <i class="fas fa-eye text-green-400 mr-2"></i>Live Preview
                    </h3>
                    <div id="livePreview" class="bg-white rounded-lg p-4 min-h-96 overflow-y-auto max-h-96">
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-file-alt text-4xl mb-4"></i>
                            <p>Start editing to see live preview</p>
                        </div>
                    </div>
                </div>

                <!-- Process Section -->
                <div class="section-card glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-cogs text-purple-400 mr-2"></i>Process & Research
                        </h3>
                        <label class="flex items-center">
                            <input type="checkbox" id="processEnabled" class="mr-2">
                            <span class="text-white text-sm">Enable</span>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white mb-2">Process Title</label>
                            <input type="text" id="processTitle" placeholder="My Process" 
                                   class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Process Steps</label>
                            <div id="processStepsContainer" class="space-y-2">
                                <div class="flex space-x-2">
                                    <input type="text" placeholder="Step description" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                                    <button type="button" onclick="removeProcessStep(this)" class="text-red-400 hover:text-red-300 px-2">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" onclick="addProcessStep()" class="mt-2 text-blue-400 hover:text-blue-300">
                                <i class="fas fa-plus mr-1"></i>Add Step
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Solution Section -->
                <div class="section-card glass-effect rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-white">
                            <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>Solution
                        </h3>
                        <label class="flex items-center">
                            <input type="checkbox" id="solutionEnabled" class="mr-2">
                            <span class="text-white text-sm">Enable</span>
                        </label>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-white mb-2">Solution Title</label>
                            <input type="text" id="solutionTitle" placeholder="The Solution" 
                                   class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30">
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Solution Description</label>
                            <textarea id="solutionDescription" rows="4" placeholder="Describe your solution..." 
                                      class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-white mb-2">Key Features</label>
                            <div id="featuresContainer" class="space-y-2">
                                <div class="flex space-x-2">
                                    <input type="text" placeholder="Feature description" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                                    <button type="button" onclick="removeFeature(this)" class="text-red-400 hover:text-red-300 px-2">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" onclick="addFeature()" class="mt-2 text-blue-400 hover:text-blue-300">
                                <i class="fas fa-plus mr-1"></i>Add Feature
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>    
<!-- Load Scripts -->
    <script src="js/cloudinary-config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/auth-system.js"></script>

    <script>
        // Enhanced Case Study Editor
        class CaseStudyEditor {
            constructor() {
                this.currentCaseStudy = null;
                this.isDirty = false;
                this.autoSaveInterval = null;
                
                this.init();
            }

            async init() {
                console.log('üöÄ Initializing Enhanced Case Study Editor...');
                
                // Wait for dependencies
                await this.waitForDependencies();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Load existing case studies
                await this.loadCaseStudies();
                
                // Setup auto-save
                this.setupAutoSave();
                
                // Setup live preview
                this.setupLivePreview();
                
                console.log('‚úÖ Case Study Editor initialized');
            }

            async waitForDependencies() {
                return new Promise((resolve) => {
                    const checkDependencies = () => {
                        if (window.cloudinaryManager && window.supabaseAPI && window.authSystem) {
                            resolve();
                        } else {
                            setTimeout(checkDependencies, 100);
                        }
                    };
                    checkDependencies();
                });
            }

            setupEventListeners() {
                // Save button
                document.getElementById('saveBtn').addEventListener('click', () => this.saveCaseStudy());
                
                // Preview button
                document.getElementById('previewBtn').addEventListener('click', () => this.openPreview());
                
                // Case study selection
                document.getElementById('caseStudySelect').addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.loadCaseStudy(e.target.value);
                    } else {
                        this.createNewCaseStudy();
                    }
                });

                // Form change detection
                const formElements = document.querySelectorAll('input, textarea, select');
                formElements.forEach(element => {
                    element.addEventListener('input', () => {
                        this.isDirty = true;
                        this.updateLivePreview();
                    });
                });

                // Section toggles
                const sectionToggles = document.querySelectorAll('input[type="checkbox"][id$="Enabled"]');
                sectionToggles.forEach(toggle => {
                    toggle.addEventListener('change', () => {
                        this.toggleSection(toggle.id.replace('Enabled', ''));
                        this.updateLivePreview();
                    });
                });

                // Prevent accidental navigation
                window.addEventListener('beforeunload', (e) => {
                    if (this.isDirty) {
                        e.preventDefault();
                        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                    }
                });
            }

            async loadCaseStudies() {
                try {
                    const caseStudies = await window.supabaseAPI.getCaseStudies();
                    const select = document.getElementById('caseStudySelect');
                    
                    // Clear existing options except the first one
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                    
                    // Add case studies
                    caseStudies.forEach(caseStudy => {
                        const option = document.createElement('option');
                        option.value = caseStudy.id;
                        option.textContent = caseStudy.project_title || 'Untitled Case Study';
                        select.appendChild(option);
                    });
                    
                    console.log(`‚úÖ Loaded ${caseStudies.length} case studies`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to load case studies:', error);
                    this.showNotification('error', 'Load Failed', 'Failed to load existing case studies');
                }
            }

            async loadCaseStudy(id) {
                try {
                    console.log(`üìñ Loading case study: ${id}`);
                    
                    const caseStudy = await window.supabaseAPI.getCaseStudy(id);
                    this.currentCaseStudy = caseStudy;
                    
                    // Populate form fields
                    this.populateForm(caseStudy);
                    
                    // Update preview
                    this.updateLivePreview();
                    
                    this.isDirty = false;
                    console.log('‚úÖ Case study loaded successfully');
                    
                } catch (error) {
                    console.error('‚ùå Failed to load case study:', error);
                    this.showNotification('error', 'Load Failed', 'Failed to load case study');
                }
            }

            populateForm(caseStudy) {
                // Basic info
                document.getElementById('caseStudyTitle').value = caseStudy.project_title || '';
                
                // Parse sections from JSON
                const sections = caseStudy.sections || {};
                
                // Hero section
                if (sections.hero) {
                    document.getElementById('heroTitle').value = sections.hero.title || '';
                    document.getElementById('heroSubtitle').value = sections.hero.subtitle || '';
                    document.getElementById('heroDescription').value = sections.hero.description || '';
                    if (sections.hero.image) {
                        this.setImagePreview('hero', sections.hero.image);
                    }
                    document.getElementById('heroEnabled').checked = sections.hero.enabled !== false;
                }
                
                // Overview section
                if (sections.overview) {
                    document.getElementById('overviewTitle').value = sections.overview.title || '';
                    document.getElementById('overviewSummary').value = sections.overview.summary || '';
                    document.getElementById('overviewEnabled').checked = sections.overview.enabled !== false;
                    
                    // Populate metrics
                    if (sections.overview.metrics) {
                        this.populateMetrics(sections.overview.metrics);
                    }
                }
                
                // Problem section
                if (sections.problem) {
                    document.getElementById('problemTitle').value = sections.problem.title || '';
                    document.getElementById('problemDescription').value = sections.problem.description || '';
                    if (sections.problem.image) {
                        this.setImagePreview('problem', sections.problem.image);
                    }
                    document.getElementById('problemEnabled').checked = sections.problem.enabled !== false;
                }
                
                // Process section
                if (sections.process) {
                    document.getElementById('processTitle').value = sections.process.title || '';
                    document.getElementById('processEnabled').checked = sections.process.enabled !== false;
                    
                    if (sections.process.steps) {
                        this.populateProcessSteps(sections.process.steps);
                    }
                }
                
                // Solution section
                if (sections.solution) {
                    document.getElementById('solutionTitle').value = sections.solution.title || '';
                    document.getElementById('solutionDescription').value = sections.solution.description || '';
                    document.getElementById('solutionEnabled').checked = sections.solution.enabled !== false;
                    
                    if (sections.solution.features) {
                        this.populateFeatures(sections.solution.features);
                    }
                }
            }

            createNewCaseStudy() {
                this.currentCaseStudy = null;
                
                // Clear all form fields
                const formElements = document.querySelectorAll('input, textarea');
                formElements.forEach(element => {
                    if (element.type !== 'checkbox') {
                        element.value = '';
                    }
                });
                
                // Reset checkboxes to default
                document.getElementById('heroEnabled').checked = true;
                document.getElementById('overviewEnabled').checked = true;
                document.getElementById('problemEnabled').checked = true;
                document.getElementById('processEnabled').checked = false;
                document.getElementById('solutionEnabled').checked = false;
                
                // Clear image previews
                this.clearImagePreview('hero');
                this.clearImagePreview('problem');
                
                // Reset dynamic lists
                this.resetMetrics();
                this.resetProcessSteps();
                this.resetFeatures();
                
                // Update preview
                this.updateLivePreview();
                
                this.isDirty = false;
                console.log('üìù Created new case study');
            }

            async saveCaseStudy() {
                try {
                    console.log('üíæ Saving case study...');
                    
                    const saveBtn = document.getElementById('saveBtn');
                    const originalText = saveBtn.innerHTML;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    saveBtn.disabled = true;
                    
                    const caseStudyData = this.collectFormData();
                    
                    let result;
                    if (this.currentCaseStudy) {
                        // Update existing
                        result = await window.supabaseAPI.updateCaseStudy(this.currentCaseStudy.id, caseStudyData);
                    } else {
                        // Create new
                        result = await window.supabaseAPI.createCaseStudy(caseStudyData);
                        this.currentCaseStudy = result;
                        
                        // Refresh the case study list
                        await this.loadCaseStudies();
                        document.getElementById('caseStudySelect').value = result.id;
                    }
                    
                    this.isDirty = false;
                    this.showNotification('success', 'Saved!', 'Case study saved successfully');
                    console.log('‚úÖ Case study saved successfully');
                    
                } catch (error) {
                    console.error('‚ùå Failed to save case study:', error);
                    this.showNotification('error', 'Save Failed', error.message);
                } finally {
                    const saveBtn = document.getElementById('saveBtn');
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }

            collectFormData() {
                const data = {
                    project_title: document.getElementById('caseStudyTitle').value,
                    project_description: document.getElementById('heroDescription').value,
                    project_image_url: document.getElementById('heroImageUrl').value,
                    status: 'draft',
                    sections: {
                        hero: {
                            enabled: document.getElementById('heroEnabled').checked,
                            title: document.getElementById('heroTitle').value,
                            subtitle: document.getElementById('heroSubtitle').value,
                            description: document.getElementById('heroDescription').value,
                            image: document.getElementById('heroImageUrl').value
                        },
                        overview: {
                            enabled: document.getElementById('overviewEnabled').checked,
                            title: document.getElementById('overviewTitle').value,
                            summary: document.getElementById('overviewSummary').value,
                            metrics: this.collectMetrics()
                        },
                        problem: {
                            enabled: document.getElementById('problemEnabled').checked,
                            title: document.getElementById('problemTitle').value,
                            description: document.getElementById('problemDescription').value,
                            image: document.getElementById('problemImageUrl').value
                        },
                        process: {
                            enabled: document.getElementById('processEnabled').checked,
                            title: document.getElementById('processTitle').value,
                            steps: this.collectProcessSteps()
                        },
                        solution: {
                            enabled: document.getElementById('solutionEnabled').checked,
                            title: document.getElementById('solutionTitle').value,
                            description: document.getElementById('solutionDescription').value,
                            features: this.collectFeatures()
                        }
                    }
                };
                
                return data;
            }

            // Image upload functions
            uploadHeroImage() {
                window.uploadImage((result) => {
                    this.setImagePreview('hero', result.secure_url);
                    document.getElementById('heroImageUrl').value = result.secure_url;
                    this.isDirty = true;
                    this.updateLivePreview();
                }, {
                    folder: 'portfolio/case-studies/hero',
                    tags: ['case-study', 'hero']
                });
            }

            uploadProblemImage() {
                window.uploadImage((result) => {
                    this.setImagePreview('problem', result.secure_url);
                    document.getElementById('problemImageUrl').value = result.secure_url;
                    this.isDirty = true;
                    this.updateLivePreview();
                }, {
                    folder: 'portfolio/case-studies/problem',
                    tags: ['case-study', 'problem']
                });
            }

            setImagePreview(section, imageUrl) {
                const preview = document.getElementById(`${section}ImagePreview`);
                const upload = document.getElementById(`${section}ImageUpload`);
                const img = document.getElementById(`${section}ImageImg`);
                
                img.src = imageUrl;
                preview.classList.remove('hidden');
                upload.classList.add('hidden');
            }

            clearImagePreview(section) {
                const preview = document.getElementById(`${section}ImagePreview`);
                const upload = document.getElementById(`${section}ImageUpload`);
                
                preview.classList.add('hidden');
                upload.classList.remove('hidden');
                document.getElementById(`${section}ImageUrl`).value = '';
            }

            // Dynamic list management
            addMetric() {
                const container = document.getElementById('metricsContainer');
                const div = document.createElement('div');
                div.className = 'flex space-x-2';
                div.innerHTML = `
                    <input type="text" placeholder="Metric name" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                    <input type="text" placeholder="Value" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                    <button type="button" onclick="removeMetric(this)" class="text-red-400 hover:text-red-300 px-2">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            }

            removeMetric(button) {
                button.parentElement.remove();
                this.isDirty = true;
                this.updateLivePreview();
            }

            collectMetrics() {
                const metrics = [];
                const container = document.getElementById('metricsContainer');
                const rows = container.querySelectorAll('div');
                
                rows.forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    if (inputs.length >= 2 && inputs[0].value && inputs[1].value) {
                        metrics.push({
                            name: inputs[0].value,
                            value: inputs[1].value
                        });
                    }
                });
                
                return metrics;
            }

            // Live preview functionality
            setupLivePreview() {
                this.updateLivePreview();
            }

            updateLivePreview() {
                const preview = document.getElementById('livePreview');
                const data = this.collectFormData();
                
                let html = '';
                
                // Hero section
                if (data.sections.hero.enabled && (data.sections.hero.title || data.sections.hero.description)) {
                    html += `
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">${data.sections.hero.title || 'Untitled'}</h1>
                            ${data.sections.hero.subtitle ? `<h2 class="text-xl text-gray-600 mb-4">${data.sections.hero.subtitle}</h2>` : ''}
                            ${data.sections.hero.image ? `<img src="${data.sections.hero.image}" class="w-full h-48 object-cover rounded-lg mb-4">` : ''}
                            ${data.sections.hero.description ? `<p class="text-gray-700">${data.sections.hero.description}</p>` : ''}
                        </div>
                    `;
                }
                
                // Overview section
                if (data.sections.overview.enabled && (data.sections.overview.title || data.sections.overview.summary)) {
                    html += `
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">${data.sections.overview.title || 'Overview'}</h2>
                            ${data.sections.overview.summary ? `<p class="text-gray-700 mb-4">${data.sections.overview.summary}</p>` : ''}
                            ${data.sections.overview.metrics.length > 0 ? `
                                <div class="grid grid-cols-2 gap-4">
                                    ${data.sections.overview.metrics.map(metric => `
                                        <div class="bg-blue-50 p-3 rounded">
                                            <div class="font-semibold text-blue-800">${metric.value}</div>
                                            <div class="text-sm text-blue-600">${metric.name}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Problem section
                if (data.sections.problem.enabled && (data.sections.problem.title || data.sections.problem.description)) {
                    html += `
                        <div class="mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">${data.sections.problem.title || 'Problem'}</h2>
                            ${data.sections.problem.image ? `<img src="${data.sections.problem.image}" class="w-full h-32 object-cover rounded-lg mb-4">` : ''}
                            ${data.sections.problem.description ? `<p class="text-gray-700">${data.sections.problem.description}</p>` : ''}
                        </div>
                    `;
                }
                
                if (!html) {
                    html = `
                        <div class="text-gray-500 text-center py-8">
                            <i class="fas fa-file-alt text-4xl mb-4"></i>
                            <p>Start editing to see live preview</p>
                        </div>
                    `;
                }
                
                preview.innerHTML = html;
            }

            // Utility functions
            showNotification(type, title, message) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
                    type === 'success' ? 'bg-green-500' : 'bg-red-500'
                } text-white`;
                
                notification.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-3 mt-1"></i>
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm">${message}</p>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            setupAutoSave() {
                this.autoSaveInterval = setInterval(() => {
                    if (this.isDirty && this.currentCaseStudy) {
                        console.log('üíæ Auto-saving...');
                        this.saveCaseStudy();
                    }
                }, 30000); // Auto-save every 30 seconds
            }

            openPreview() {
                if (!this.currentCaseStudy) {
                    this.showNotification('error', 'No Case Study', 'Please save the case study first');
                    return;
                }
                
                const previewUrl = `/case_study_display.html?id=${this.currentCaseStudy.id}`;
                window.open(previewUrl, '_blank');
            }
        }

        // Global functions for dynamic content
        function removeMetric(button) {
            button.parentElement.remove();
            if (window.caseStudyEditor) {
                window.caseStudyEditor.isDirty = true;
                window.caseStudyEditor.updateLivePreview();
            }
        }

        function addProcessStep() {
            const container = document.getElementById('processStepsContainer');
            const div = document.createElement('div');
            div.className = 'flex space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="Step description" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                <button type="button" onclick="removeProcessStep(this)" class="text-red-400 hover:text-red-300 px-2">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeProcessStep(button) {
            button.parentElement.remove();
            if (window.caseStudyEditor) {
                window.caseStudyEditor.isDirty = true;
                window.caseStudyEditor.updateLivePreview();
            }
        }

        function addFeature() {
            const container = document.getElementById('featuresContainer');
            const div = document.createElement('div');
            div.className = 'flex space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="Feature description" class="flex-1 px-3 py-2 rounded bg-white/20 text-white placeholder-white/70 border border-white/30">
                <button type="button" onclick="removeFeature(this)" class="text-red-400 hover:text-red-300 px-2">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        }

        function removeFeature(button) {
            button.parentElement.remove();
            if (window.caseStudyEditor) {
                window.caseStudyEditor.isDirty = true;
                window.caseStudyEditor.updateLivePreview();
            }
        }

        function uploadHeroImage() {
            if (window.caseStudyEditor) {
                window.caseStudyEditor.uploadHeroImage();
            }
        }

        function uploadProblemImage() {
            if (window.caseStudyEditor) {
                window.caseStudyEditor.uploadProblemImage();
            }
        }

        function removeHeroImage() {
            if (window.caseStudyEditor) {
                window.caseStudyEditor.clearImagePreview('hero');
                window.caseStudyEditor.isDirty = true;
                window.caseStudyEditor.updateLivePreview();
            }
        }

        function removeProblemImage() {
            if (window.caseStudyEditor) {
                window.caseStudyEditor.clearImagePreview('problem');
                window.caseStudyEditor.isDirty = true;
                window.caseStudyEditor.updateLivePreview();
            }
        }

        function addMetric() {
            if (window.caseStudyEditor) {
                window.caseStudyEditor.addMetric();
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.caseStudyEditor = new CaseStudyEditor();
        });
    </script>
</body>
</html>