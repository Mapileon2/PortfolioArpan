<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudinary Upload Fix Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-900 mb-6">🔧 Cloudinary Upload Fix & Test</h1>
            
            <!-- Test Results -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-900 mb-2">Connection Test</h3>
                    <div id="connectionStatus" class="text-sm">Testing...</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-900 mb-2">Upload Test</h3>
                    <div id="uploadStatus" class="text-sm">Ready</div>
                </div>
            </div>

            <!-- Upload Section -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Test Image Upload</h3>
                <p class="text-gray-600 mb-4">Select an image to test the fixed upload functionality</p>
                
                <input type="file" id="imageInput" accept="image/*" class="hidden">
                <button onclick="document.getElementById('imageInput').click()" 
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Select Image
                </button>
            </div>

            <!-- Upload Progress -->
            <div id="uploadProgress" class="hidden mb-6">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-sm text-gray-600 mt-2">Uploading...</div>
            </div>

            <!-- Results -->
            <div id="results" class="hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Upload Results</h3>
                <div id="resultContent" class="bg-gray-50 p-4 rounded-lg"></div>
            </div>

            <!-- Debug Info -->
            <div class="mt-6 bg-gray-100 p-4 rounded-lg">
                <h3 class="font-semibold text-gray-900 mb-2">Debug Information</h3>
                <div id="debugInfo" class="text-sm text-gray-600 font-mono"></div>
            </div>
        </div>
    </div>

    <script>
        class CloudinaryUploadFix {
            constructor() {
                this.config = {
                    cloudName: 'dgymjtqil',
                    apiKey: '951533987774134',
                    // We'll use unsigned upload preset
                    uploadPreset: 'ml_default'
                };
                
                this.init();
            }

            async init() {
                console.log('🔧 Initializing Cloudinary Upload Fix...');
                await this.testConnection();
                this.setupEventListeners();
            }

            async testConnection() {
                const statusDiv = document.getElementById('connectionStatus');
                
                try {
                    // Test 1: Check if cloud exists
                    const response = await fetch(`https://res.cloudinary.com/${this.config.cloudName}/image/upload/sample.jpg`);
                    
                    if (response.ok) {
                        statusDiv.innerHTML = `
                            <div class="text-green-600">
                                <i class="fas fa-check-circle mr-2"></i>
                                Cloud Name: ✅ Valid
                            </div>
                        `;
                    } else {
                        throw new Error('Cloud name invalid');
                    }

                    // Test 2: Check upload preset
                    await this.testUploadPreset();
                    
                } catch (error) {
                    console.error('Connection test failed:', error);
                    statusDiv.innerHTML = `
                        <div class="text-red-600">
                            <i class="fas fa-times-circle mr-2"></i>
                            Connection Failed: ${error.message}
                        </div>
                    `;
                }
            }

            async testUploadPreset() {
                try {
                    // Create a small test image (1x1 pixel)
                    const canvas = document.createElement('canvas');
                    canvas.width = 1;
                    canvas.height = 1;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(0, 0, 1, 1);
                    
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    
                    const formData = new FormData();
                    formData.append('file', blob, 'test.png');
                    formData.append('upload_preset', this.config.uploadPreset);
                    
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${this.config.cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('✅ Upload preset test successful:', result.public_id);
                        
                        // Clean up test image
                        setTimeout(() => {
                            this.deleteTestImage(result.public_id);
                        }, 5000);
                        
                        return true;
                    } else {
                        const error = await response.json();
                        throw new Error(error.error?.message || 'Upload preset test failed');
                    }
                } catch (error) {
                    console.error('Upload preset test failed:', error);
                    throw error;
                }
            }

            async deleteTestImage(publicId) {
                try {
                    // Note: This would require signed request in production
                    console.log('Test image cleanup scheduled for:', publicId);
                } catch (error) {
                    console.error('Test image cleanup failed:', error);
                }
            }

            setupEventListeners() {
                const imageInput = document.getElementById('imageInput');
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.uploadImage(file);
                    }
                });
            }

            async uploadImage(file) {
                const uploadStatus = document.getElementById('uploadStatus');
                const uploadProgress = document.getElementById('uploadProgress');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const results = document.getElementById('results');
                const resultContent = document.getElementById('resultContent');
                const debugInfo = document.getElementById('debugInfo');

                try {
                    // Validate file
                    if (!file.type.startsWith('image/')) {
                        throw new Error('Please select a valid image file');
                    }

                    if (file.size > 10 * 1024 * 1024) {
                        throw new Error('File size must be less than 10MB');
                    }

                    // Show progress
                    uploadProgress.classList.remove('hidden');
                    results.classList.add('hidden');
                    
                    uploadStatus.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Uploading...</div>';
                    progressText.textContent = 'Preparing upload...';

                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', this.config.uploadPreset);
                    formData.append('folder', 'portfolio/test');
                    formData.append('tags', 'test,portfolio');

                    // Update debug info
                    debugInfo.innerHTML = `
                        Cloud Name: ${this.config.cloudName}<br>
                        Upload Preset: ${this.config.uploadPreset}<br>
                        File Name: ${file.name}<br>
                        File Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        File Type: ${file.type}
                    `;

                    // Simulate progress
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 30;
                        if (progress > 90) progress = 90;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                    }, 200);

                    // Upload to Cloudinary
                    const response = await fetch(`https://api.cloudinary.com/v1_1/${this.config.cloudName}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    progressText.textContent = 'Processing...';

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();

                    // Success
                    uploadStatus.innerHTML = '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Upload Successful!</div>';
                    
                    resultContent.innerHTML = `
                        <div class="space-y-4">
                            <div class="flex items-center justify-center">
                                <img src="${result.secure_url}" alt="Uploaded image" class="max-w-xs max-h-48 rounded-lg shadow-md">
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>URL:</strong><br><a href="${result.secure_url}" target="_blank" class="text-blue-600 break-all">${result.secure_url}</a></div>
                                <div><strong>Public ID:</strong><br><code class="bg-gray-200 px-2 py-1 rounded">${result.public_id}</code></div>
                                <div><strong>Size:</strong><br>${result.width} x ${result.height}</div>
                                <div><strong>Format:</strong><br>${result.format.toUpperCase()}</div>
                                <div><strong>File Size:</strong><br>${(result.bytes / 1024 / 1024).toFixed(2)} MB</div>
                                <div><strong>Created:</strong><br>${new Date(result.created_at).toLocaleString()}</div>
                            </div>
                        </div>
                    `;

                    results.classList.remove('hidden');
                    uploadProgress.classList.add('hidden');

                    console.log('✅ Upload successful:', result);

                } catch (error) {
                    console.error('❌ Upload failed:', error);
                    
                    uploadStatus.innerHTML = `<div class="text-red-600"><i class="fas fa-times-circle mr-2"></i>Upload Failed: ${error.message}</div>`;
                    
                    resultContent.innerHTML = `
                        <div class="text-red-600">
                            <h4 class="font-semibold mb-2">Upload Error:</h4>
                            <p class="mb-4">${error.message}</p>
                            <div class="bg-red-50 p-3 rounded text-sm">
                                <strong>Troubleshooting:</strong>
                                <ul class="list-disc list-inside mt-2 space-y-1">
                                    <li>Check if upload preset '${this.config.uploadPreset}' exists in Cloudinary</li>
                                    <li>Verify cloud name '${this.config.cloudName}' is correct</li>
                                    <li>Ensure upload preset allows unsigned uploads</li>
                                    <li>Check file size and format restrictions</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    
                    results.classList.remove('hidden');
                    uploadProgress.classList.add('hidden');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.cloudinaryFix = new CloudinaryUploadFix();
        });
    </script>
</body>
</html>